<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Java并发编程实战：第3章 对象的共享 - LeeHua&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="LeeHua&#039;s Blog"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="LeeHua&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="1. 可见性其实关键字 synchronized 关键字不仅仅能用于实现原子性或者确定 “临界区（Critical Section）” 同步还有另一个重要的方面：内存可见性（Memory Visibility）。 我们不仅希望防止某个线程正常使用对象状态而另一个线程再同时修改该状态，而且希望确保当一个线程修改了对象状态之后，其他线程能够看到发生状态变化。我们可以通过同步或者类库中内置的同步保证对象"><meta property="og:type" content="blog"><meta property="og:title" content="Java并发编程实战：第3章 对象的共享"><meta property="og:url" content="https://osys.github.io/"><meta property="og:site_name" content="Osys&#039;s Blog"><meta property="og:description" content="1. 可见性其实关键字 synchronized 关键字不仅仅能用于实现原子性或者确定 “临界区（Critical Section）” 同步还有另一个重要的方面：内存可见性（Memory Visibility）。 我们不仅希望防止某个线程正常使用对象状态而另一个线程再同时修改该状态，而且希望确保当一个线程修改了对象状态之后，其他线程能够看到发生状态变化。我们可以通过同步或者类库中内置的同步保证对象"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20220829215446.png"><meta property="article:published_time" content="2022-08-29T14:06:14.000Z"><meta property="article:modified_time" content="2022-08-29T14:40:44.000Z"><meta property="article:author" content="Osys"><meta property="article:tag" content="Java并发编程"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20220829215446.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://osys.github.io/"},"headline":"LeeHua's Blog","image":["https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20220829215446.png"],"datePublished":"2022-08-29T14:06:14.000Z","dateModified":"2022-08-29T14:40:44.000Z","author":{"@type":"Person","name":"Osys"},"publisher":{"@type":"Organization","name":"Osys","logo":{"@type":"ImageObject","url":"https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"}},"description":"一路生花"}</script><link rel="canonical" href="https://osys.github.io/posts/fff0.html"><link rel="alternate" href="/path/to/atom.xml" title="LeeHua&#039;s Blog" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?44cd31785e14a1fdaad0921651759e0f";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><script src="/js/runtime.js"></script><meta name="generator" content="Hexo 6.0.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png" alt="LeeHua&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-08-29T14:06:14.000Z" title="8/29/2022, 2:06:14 PM">2022年08月29日</time>发表</span><span class="level-item"><time dateTime="2022-08-29T14:40:44.000Z" title="8/29/2022, 2:40:44 PM">2022年08月29日</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Java/">Java</a></span><span class="level-item">42 分钟读完 (大约6237个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Java并发编程实战：第3章 对象的共享</h1><div class="content"><h1 id="1-可见性"><a href="#1-可见性" class="headerlink" title="1. 可见性"></a>1. 可见性</h1><p>其实关键字 synchronized 关键字不仅仅能用于实现原子性或者确定 “临界区（Critical Section）”</p>
<p>同步还有另一个重要的方面：内存可见性（Memory Visibility）。</p>
<p>我们不仅希望防止某个线程正常使用对象状态而另一个线程再同时修改该状态，而且希望确保当一个线程修改了对象状态之后，其他线程能够看到发生状态变化。我们可以通过同步或者类库中内置的同步保证对象安全地发布。</p>
<span id="more"></span>

<h2 id="1-1-可见性"><a href="#1-1-可见性" class="headerlink" title="1.1 可见性"></a>1.1 可见性</h2><ul>
<li><p>对于单线程而言，如果向某个变量先写入值，然后在没有其他写入操作的情况下，读取这个变量，其值是正确的。</p>
</li>
<li><p>多线程中。读操作、写操作，在不同的线程中执行，可能会导致读写不一致问题。</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">data=1</span><br><span class="line"></span><br><span class="line">1. 线程A，读取data=1</span><br><span class="line">2. 线程A，修改data=2（还未写入）</span><br><span class="line">3. 线程B，读取data=1</span><br><span class="line">4. 线程A，写入data=2（此时data值为2）</span><br><span class="line"></span><br><span class="line">此时线程B读取的内容是data=1，而线程A已经将data修改为2了</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="1-2-在没有同步的情况下共享变量"><a href="#1-2-在没有同步的情况下共享变量" class="headerlink" title="1.2 在没有同步的情况下共享变量"></a>1.2 在没有同步的情况下共享变量</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoVisibility</span> &#123;</span><br><span class="line">    <span class="comment">/** 默认值为 false */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> ready;</span><br><span class="line">    <span class="comment">/** 默认值为 0 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ReaderTread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.setName(<span class="string">&quot;Reader&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (!ready) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                当一个线程使用了 Thread.yield() 方法之后，它就会把自己CPU执行的时间让掉，让自己或者其它的线程运行。</span></span><br><span class="line"><span class="comment">                </span></span><br><span class="line"><span class="comment">                打个比方：</span></span><br><span class="line"><span class="comment">                    现在有很多人在排队上厕所，好不容易轮到这个人上厕所了，突然这个人说：“我要和大家来个竞赛，看谁先抢到厕所！”。</span></span><br><span class="line"><span class="comment">                    然后所有的人在同一起跑线冲向厕所，有可能是别人抢到了，也有可能他自己有抢到了。</span></span><br><span class="line"><span class="comment">                    我们还知道线程有个优先级的问题，那么手里有优先权的这些人就一定能抢到厕所的位置吗?</span></span><br><span class="line"><span class="comment">                    不一定的，他们只是概率上大些，也有可能没特权的抢到了。</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                Thread.yield();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(number);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// main 线程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Reader 线程</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ReaderTread</span>().start();</span><br><span class="line">        number = <span class="number">66</span>;</span><br><span class="line">        ready = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>这里一共有两个线程，Main 线程和 Reader 线程</li>
<li>当多个线程在没有同步的情况下共享数据时，Main 线程和 Reader 线程都将访问共享变量 ready 和 number</li>
<li>Main 线程启动 Reader 线程，然后将 number 设为66，并将 ready 设为 true。</li>
<li>Reader 线程一直循环直到发现 ready 的值变为true，然后输出 number 的值。</li>
<li>虽然 NoVisibility 看起来会输出66，但事实上很可能输出 0，或者根本无法终止。</li>
<li>这是因为在代码中没有使用足够的同步机制，因此无法保证主线程写入的 ready 值和 number 值对于读线程来说是可见的。</li>
</ol>
<h2 id="1-3-失效数据"><a href="#1-3-失效数据" class="headerlink" title="1.3 失效数据"></a>1.3 失效数据</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">data=1</span><br><span class="line"></span><br><span class="line">1. 线程A，读取data=1</span><br><span class="line">2. 线程A，修改data=2（还未写入）</span><br><span class="line">3. 线程B，读取data=1</span><br><span class="line">4. 线程A，写入data=2（此时data值为2）</span><br><span class="line"></span><br><span class="line">此时线程B读取的内容是data=1，而线程A已经将data修改为2了</span><br></pre></td></tr></table></figure>

<p>当线程A，和线程B获取的 data 数据均为 1 时。线程A对数据进行更改，此时线程B中获取的 data&#x3D;1 数据为失效数据。</p>
<blockquote>
<p>程序清单 3-2、3-3</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.NotThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NotThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MutableInteger</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Integer value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>线程不安全：MutableInteger.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.GuardedBy;</span><br><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedInteger</span> &#123;</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> Integer <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Integer value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用了两个同步代码块，来进行get、set操作。不过针对不同线程分别调用这两个方法，还是换出现数据安全性问题（失效值）。</p>
<h2 id="1-4-非原子的-64-位操作"><a href="#1-4-非原子的-64-位操作" class="headerlink" title="1.4 非原子的 64 位操作"></a>1.4 非原子的 64 位操作</h2><p>计算机中存储数据和计算数据都是基于二进制来做的。在 Java 的基本数据类型中，long 和 double 是 64 位的。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>占用字节</th>
<th>占用位数</th>
<th>数值长度</th>
</tr>
</thead>
<tbody><tr>
<td>byte</td>
<td>1</td>
<td>8</td>
<td>-128~127(-2的7次方到2的7次方-1)</td>
</tr>
<tr>
<td>short</td>
<td>2</td>
<td>16</td>
<td>-32768~32767(-2的15次方到2的15次方-1)</td>
</tr>
<tr>
<td>int</td>
<td>4</td>
<td>32</td>
<td>-2的31次方到2的31次方-1</td>
</tr>
<tr>
<td>long</td>
<td>8</td>
<td>64</td>
<td>-2的63次方到2的63次方-1</td>
</tr>
<tr>
<td>float</td>
<td>4</td>
<td>32</td>
<td>（e-45是乘以10的负45次方，e+38是乘以10的38次方) （2的-149次方~2的128次方-1）</td>
</tr>
<tr>
<td>double</td>
<td>8</td>
<td>64</td>
<td>(2的-1074次方 ~ 2的1024次方)</td>
</tr>
<tr>
<td>char</td>
<td>2</td>
<td>16</td>
<td></td>
</tr>
<tr>
<td>boolean</td>
<td></td>
<td>1</td>
<td></td>
</tr>
</tbody></table>
<p>位数中，不同位代表的含义不一样，有符号位，指数位，尾数位。</p>
<p>非原子的 64 位操作</p>
<ul>
<li>最低安全性：当线程在没有同步的情况下读取变量时，可能会得到一个失效值，但至少这个值是由之前某个线程设置的，而不再一个随机值。</li>
<li>Java内存模型要求，变量的读取操作和写入操作都必须是原子操作。对于非 <code>volatile</code> 类型的 64 位数值变量(<code>long</code>、<code>double</code>)，JVM允许将64位的读操作或写操作分解为两个32为的操作。</li>
<li>当读取一个非 <code>volatile</code> 类型的 64 位数值变量(<code>long</code>、<code>double</code>) 时，如果对改变了的 <code>读</code> 操作和 <code>写</code> 操作在不同的线程中执行，那么很可能会读取到某个值的高32位和另一个值的低32位。</li>
<li>因此，即使不考虑失效数据问题，在多线程中使用共享且可变的<code>long</code>、<code>double</code> 等类型的变量也是不安全的，需要用 <code>volatile</code> 关键字来声明，或者用 <code>锁</code> 保护起来。</li>
</ul>
<h2 id="1-5-加锁与可见性"><a href="#1-5-加锁与可见性" class="headerlink" title="1.5 加锁与可见性"></a>1.5 加锁与可见性</h2><p>内置锁可以用于确保某个线程以一种可预测的方式来查看另一个线程的执行结果。</p>
<p><img src="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20220829215446.png" alt="1"></p>
<p>当线程A执行某个同步代码块时，线程B随后进入由同一个锁保护的同步代码块。</p>
<p>在这种情况下可以保证，当线程B执行由锁保护的同步代码块时，可以看到前面线程A在同一个在代码块中的所有操作结果。</p>
<p>其实这就是为了确保某个线程写入该变量的值，对于其他线程来说都是可见的。</p>
<h1 id="2-Volatile-关键字"><a href="#2-Volatile-关键字" class="headerlink" title="2. Volatile 关键字"></a>2. Volatile 关键字</h1><h2 id="2-1-什么是重排序"><a href="#2-1-什么是重排序" class="headerlink" title="2.1 什么是重排序"></a>2.1 什么是重排序</h2><ul>
<li><p>在执行程序时为了<code>提高性能</code>，编译器和处理器常常会对指令<code>做重排序</code>。</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">源代码 --&gt; 编译器优化的重排序 --&gt; 指令级并行的重排序 --&gt; 内存系统的重排序 --&gt; 最终指向指令</span><br></pre></td></tr></table></figure>

</li>
<li><p><code>编译器优化的重排序</code></p>
<p>  编译器在不改变单线程程序语义的前提下，可以重新安排语句的执行顺序。</p>
</li>
<li><p><code>指令级并行的重排序</code></p>
<p>  处理器将多条指令重叠执行。如果不存在数据依赖性，处理器可以改变语句对应机器指令的执行顺序。</p>
</li>
<li><p><code>内存系统的重排序</code></p>
<p>  处理器使用缓存和读&#x2F;写缓冲区，使得加载和存储操作看上去可能是在乱序执行。</p>
</li>
</ul>
<h2 id="2-2-可见性"><a href="#2-2-可见性" class="headerlink" title="2.2 可见性"></a>2.2 可见性</h2><p>简单的理解，当一个线程修改了共享变量时，另一个线程可以读取到这个修改后的值。</p>
<h2 id="2-3-volatile-关键字"><a href="#2-3-volatile-关键字" class="headerlink" title="2.3 volatile 关键字"></a>2.3 volatile 关键字</h2><p>Java 中一种稍弱的同步机制。用来确保将变量的更新操作通知到其他线程。</p>
<p>简单理解就是，读取 volatile 变量，总数返回最新写入的值。</p>
<p>对于以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.GuardedBy;</span><br><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedInteger</span> &#123;</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> Integer <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Integer value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以将其修改位用 <code>volatile </code> 关键字修饰：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.GuardedBy;</span><br><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedInteger</span> &#123;</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Integer value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Integer value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>被 <code>volatile</code> 修饰的变量，编译器与运行时，都会注意到这个变量是共享的，因此不会将该变量上的操作与其他内存操作一起重排序。</li>
<li>在访问 <code>volatile</code> 变量时，不会执行加锁操作，因此也就不会指向线程阻塞，因此 volatile 变量是一种比 synchronized 关键字更轻量级的同步机制。</li>
</ul>
<h2 id="2-4-分析-volatile-变量"><a href="#2-4-分析-volatile-变量" class="headerlink" title="2.4 分析 volatile 变量"></a>2.4 分析 volatile 变量</h2><p>从内存可见性的角度来看，<code>写入</code> volatile 变量相当于<code>退出</code>同步代码块，<code>读取</code> volatile 变量相当于<code>进入</code>同步代码块。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">value1</span> <span class="operator">=</span> <span class="number">666</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">value2</span> <span class="operator">=</span> <span class="number">123</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>非 volatile 变量可以这样理解：</code></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">单线程：</span><br><span class="line">1. 平时修改数据(value2)，首先读取数据（将value2拷贝一份出来）  --- 每个线程读取都会拷贝一份value2=123</span><br><span class="line">2. 对(将value2=123) 拷贝出来的数据进行修改，value2=456</span><br><span class="line">3. 然后将 value2=456 写入到本体中，完成了修改操作</span><br><span class="line"></span><br><span class="line">多线程：</span><br><span class="line">4. 如果多线程情况下，每个线程同时读取，分别都拷贝了一份(value2=123)，其中一个线程对其进行了修改并写入(value2=456)，其他线程已读取的数据还是前面的(value2=123)</span><br></pre></td></tr></table></figure>

</li>
<li><p><code>从内存角度来看 volatile 变量：</code></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 有A、B两个线程，读取 volatile 变量，就相当于进入了 volatile 变量的同步代码块中</span><br><span class="line">2. 线程A修改了 volatile 变量，线程B也会同步知道线程 A修改了 volatile 变量</span><br><span class="line">3. 线程A修改了 volatile 变量后，进行写入操作，即退出了该同步代码块</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="2-5-局限性"><a href="#2-5-局限性" class="headerlink" title="2.5 局限性"></a>2.5 局限性</h2><p><code>volatile</code> 关键字通常用做某个 <code>操作完成</code>、<code>发生中断</code>、<code>状态</code> 的标志。如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo8</span> &#123;</span><br><span class="line">    <span class="comment">/** 状态的标志 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> aSleep;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mainMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        startDoSomething();</span><br><span class="line">        <span class="keyword">while</span> (!aSleep) &#123;</span><br><span class="line">            stopDoSomething();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startDoSomething</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;开始 ------ 做某些事&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stopDoSomething</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;停止 ------ 做某些事&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>volatile</code> 关键字不足以确保递增操作 <code>i++</code> 的原子性，因为我们不能确保只有一个线程对变量执行写操作。</p>
<h1 id="3-发布与逸出"><a href="#3-发布与逸出" class="headerlink" title="3. 发布与逸出"></a>3. 发布与逸出</h1><h2 id="3-1-发布-Publish"><a href="#3-1-发布-Publish" class="headerlink" title="3.1 发布(Publish)"></a>3.1 发布(Publish)</h2><ul>
<li><p>发布一个对象指的是，是对象能够再当前作用域之外的代码中使用。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sun.nio.ch.Secrets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PublishObject</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Secrets&gt; publishSecrets = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Secrets&gt; <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> publishSecrets;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="3-2-逸出-Escape"><a href="#3-2-逸出-Escape" class="headerlink" title="3.2 逸出(Escape)"></a>3.2 逸出(Escape)</h2><p>逸出：不应该发布的对象被发布</p>
<p>对于上面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PublishObject</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Secrets&gt; publishSecrets = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Secrets&gt; <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> publishSecrets;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当我们发布某个对象时，可能会间接地发布其他对象。</li>
<li>如我们不是发布 Set 对象，而是 <code>Secrets</code> 对象</li>
<li>如将别的 <code>Secrets</code> 对象添加到 <code>publishSecrets</code> 集合中，那么同样的，被添加的这个 <code>Secrets</code> 对象也会被发布。</li>
<li>因为任何使用者都能遍历这个集合，并且获得这个新 <code>Secrets</code> 对象的引用。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnsafeStates</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String[] states = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String[] getStates() &#123;</span><br><span class="line">        <span class="keyword">return</span> states;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>任何调用者都可能会修改发布的对象，如上 <code>states</code> 对象，该数组已经逸出了它所在的作用域。</li>
<li>当发布一个对象时，在该对象的非私有域应用的对象同样会被发布。</li>
<li>一般来说，如果一个已经发布的对象能够通过非私有的变量<code>引用</code>和<code>方法</code>调用到其他对象，那么这些对象也都会被发布。</li>
</ul>
<h2 id="3-3-安全地对象构造"><a href="#3-3-安全地对象构造" class="headerlink" title="3.3 安全地对象构造"></a>3.3 安全地对象构造</h2><p>隐式地是由 this 引用逸出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThisEscape</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThisEscape</span><span class="params">(EventSource source)</span> &#123;</span><br><span class="line">        source.registerListener(<span class="keyword">new</span> <span class="title class_">EventListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">                doSomething(event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 事件源 */</span></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">EventSource</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 注册事件监听</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> eventListener 事件监听</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">registerListener</span><span class="params">(EventListener eventListener)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 事件监听 */</span></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 一个事件</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> event 一个事件</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(Event event)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 事件 */</span></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Event</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ThisEscape</code> 中给出了逸出地一个特殊示例，即 <code>this</code> 引用在构造函数中逸出。</li>
<li>当内部地 <code>EventListener</code> 实例发布时，在外部封装的 <code>ThisEscape</code> 实例逸出了。</li>
<li>当从对象的构造函数中发布对象时，只是发布了一个尚未构造完成的对象。即使发布对象的语句位于构造函数的最后一行也是如此。</li>
<li>如果 <code>this</code> 引用在构造过程中逸出，那么这种对象就被认为是不正确的构造。</li>
</ul>
<p>使用工厂方法来防止 <code>this</code> 引用在构造过程中逸出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SafeListener</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventListener listener;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">SafeListener</span><span class="params">()</span> &#123;</span><br><span class="line">        listener = <span class="keyword">new</span> <span class="title class_">EventListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">                doSomething(event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SafeListener <span class="title function_">newInstance</span><span class="params">(EventSource source)</span> &#123;</span><br><span class="line">        <span class="type">SafeListener</span> <span class="variable">safeListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SafeListener</span>();</span><br><span class="line">        source.registerListener(safeListener.listener);</span><br><span class="line">        <span class="keyword">return</span> safeListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 事件源 */</span></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">EventSource</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 注册事件监听</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> eventListener 事件监听</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">registerListener</span><span class="params">(EventListener eventListener)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 事件监听 */</span></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 一个事件</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> event 一个事件</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(Event event)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 事件 */</span></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Event</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果想在构造函数中注册一个事件监听器或启动线程，那么可以使用一个使用的构造函数和一个公共的工程方法，从而避免不正确的构造过程。</p>
<h1 id="4-线程封闭"><a href="#4-线程封闭" class="headerlink" title="4. 线程封闭"></a>4. 线程封闭</h1><h2 id="4-1-线程封闭"><a href="#4-1-线程封闭" class="headerlink" title="4.1 线程封闭"></a>4.1 线程封闭</h2><ul>
<li>当访问共享数据时，通常是要使用同步。</li>
<li>如果要避免使用同步，就是不提供共享数据。</li>
<li>如果仅在单线程中访问数据，就不需要同步。</li>
</ul>
<h2 id="4-2-Ad-hoc-线程封闭"><a href="#4-2-Ad-hoc-线程封闭" class="headerlink" title="4.2 Ad-hoc 线程封闭"></a>4.2 Ad-hoc 线程封闭</h2><p>Ad-hoc 线程封闭：线程封闭性的职责完全由程序实现来承担。</p>
<p>Ad-hoc 非常脆弱，因为它没有一种语言特性，例如可见性修饰符或局部变量，能将对象封闭到特定的线程上。</p>
<h2 id="4-3-栈封闭（线程局部使用）"><a href="#4-3-栈封闭（线程局部使用）" class="headerlink" title="4.3 栈封闭（线程局部使用）"></a>4.3 栈封闭（线程局部使用）</h2><p>栈封闭是线程封闭的一种特例，在栈封闭中，只能通过局部变量才能访问对象。</p>
<p>局部变量的固有属性之一就是封闭在执行线程中。它们位于执行线程的栈中，其他线程无法访问这个栈。</p>
<p>基本类型的局部变量与引用变量的线程封闭性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.SortedSet;</span><br><span class="line"><span class="keyword">import</span> java.util.TreeSet;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Animals</span> &#123;</span><br><span class="line">    Ark ark;</span><br><span class="line">    Species species;</span><br><span class="line">    Gender gender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载动物对 载体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> candidates 候选动物</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 动物对数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">loadTheArk</span><span class="params">(Collection&lt;Animal&gt; candidates)</span> &#123;</span><br><span class="line">        SortedSet&lt;Animal&gt; animals;</span><br><span class="line">        <span class="type">int</span> <span class="variable">numPairs</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 候选</span></span><br><span class="line">        <span class="type">Animal</span> <span class="variable">candidate</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        animals = <span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;Animal&gt;(<span class="keyword">new</span> <span class="title class_">SpeciesGenderComparator</span>());</span><br><span class="line">        animals.addAll(candidates);</span><br><span class="line">        <span class="comment">// 依次循环所有候选动物，存在同物种，不同性别的动物，加入动物对中</span></span><br><span class="line">        <span class="keyword">for</span> (Animal animal : animals) &#123;</span><br><span class="line">            <span class="keyword">if</span> (candidate == <span class="literal">null</span> || !candidate.isPotentialMate(animal)) &#123;</span><br><span class="line">                candidate = animal;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 同物种，不同性别。向【动物对】载体中添加这两个动物</span></span><br><span class="line">                ark.load(<span class="keyword">new</span> <span class="title class_">AnimalPair</span>(candidate, animal));</span><br><span class="line">                ++numPairs;</span><br><span class="line">                candidate = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//动物对数</span></span><br><span class="line">        <span class="keyword">return</span> numPairs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 动物 */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">        <span class="comment">/** 物种 */</span></span><br><span class="line">        Species species;</span><br><span class="line">        <span class="comment">/** 性别 */</span></span><br><span class="line">        Gender gender;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 是否是同物种，不同性别 */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isPotentialMate</span><span class="params">(Animal other)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.species == other.species &amp;&amp; <span class="built_in">this</span>.gender != other.gender;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span> == o) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Animal)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Animal</span> <span class="variable">animal</span> <span class="operator">=</span> (Animal) o;</span><br><span class="line">            <span class="type">return</span> <span class="variable">species</span> <span class="operator">=</span>= animal.species &amp;&amp; gender == animal.gender;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Objects.hash(species, gender);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物种 */</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Species</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 土豚、孟加拉虎、驯鹿、野狗、大象、青蛙、GNU、土狼、</span></span><br><span class="line">        AARDVARK, BENGAL_TIGER, CARIBOU, DINGO, ELEPHANT, FROG, GNU, HYENA,</span><br><span class="line">        <span class="comment">// 鬣蜥、美洲虎、猕猴桃、美洲豹、马斯塔顿、蝾螈、章鱼、</span></span><br><span class="line">        IGUANA, JAGUAR, KIWI, LEOPARD, MASTADON, NEWT, OCTOPUS,</span><br><span class="line">        <span class="comment">// 食人鱼、格查尔、犀牛、蝾螈、三趾树懒、</span></span><br><span class="line">        PIRANHA, QUETZAL, RHINOCEROS, SALAMANDER, THREE_TOED_SLOTH,</span><br><span class="line">        <span class="comment">// 独角兽、毒蛇、狼人、黄蜂、牦牛、斑马</span></span><br><span class="line">        UNICORN, VIPER, WEREWOLF, XANTHUS_HUMMINBIRD, YAK, ZEBRA</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 性别 */</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Gender</span> &#123;</span><br><span class="line">        <span class="comment">// 雄性、雌性</span></span><br><span class="line">        MALE, FEMALE</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**一对动物 */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AnimalPair</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Animal one, two;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">AnimalPair</span><span class="params">(Animal one, Animal two)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.one = one;</span><br><span class="line">            <span class="built_in">this</span>.two = two;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span> == o) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> AnimalPair)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">AnimalPair</span> <span class="variable">that</span> <span class="operator">=</span> (AnimalPair) o;</span><br><span class="line">            <span class="keyword">return</span> Objects.equals(one, that.one) &amp;&amp; Objects.equals(two, that.two);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Objects.hash(one, two);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物种性别比较 */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SpeciesGenderComparator</span> <span class="keyword">implements</span> <span class="title class_">Comparator</span>&lt;Animal&gt; &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 先进行物种比较，物种比较相同，再进行性别比较</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> one 动物1</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> two 动物2</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> 0为物种相同，且</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(Animal one, Animal two)</span> &#123;</span><br><span class="line">            <span class="comment">// Enum.compareTo()</span></span><br><span class="line">            <span class="comment">// 将此枚举与订单的指定对象进行比较。当此对象小于、等于或大于指定对象时，返回负整数、零或正整数。</span></span><br><span class="line">            <span class="comment">// 枚举常量只能与同一枚举类型的其他枚举常量进行比较。该方法实现的自然顺序是常量的声明顺序。</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">speciesCompare</span> <span class="operator">=</span> one.species.compareTo(two.species);</span><br><span class="line">            <span class="keyword">return</span> (speciesCompare != <span class="number">0</span>)</span><br><span class="line">                    ? speciesCompare</span><br><span class="line">                    : one.gender.compareTo(two.gender);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 动物对 载体 */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Ark</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Set&lt;AnimalPair&gt; loadedAnimals = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 向 【动物对】 载体中添加 【动物对】 */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(AnimalPair pair)</span> &#123;</span><br><span class="line">            loadedAnimals.add(pair);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>loadTheArk</code> 中的 <code>animals</code> 变量为局部变量，它被限制在保存本地变量的线程中。</p>
<h1 id="5-ThreadLocal"><a href="#5-ThreadLocal" class="headerlink" title="5. ThreadLocal"></a>5. ThreadLocal</h1><ul>
<li><p><code>ThreadLocal</code> 允许 <code>每个线程</code> 与<code>特有数值的对象</code> 关联在一起。</p>
</li>
<li><p><code>ThreadLocal</code> 提供了 get 和 set 访问器，为每个使用 <code>ThreadLoacl</code> 的线程维护一份单独的拷贝。</p>
</li>
<li><p>因此 get 总是返回由当前只想线程通过 set 设置的最新值。</p>
</li>
</ul>
<p>线程本地（ThreadLocal）变量通常用于防止基于<code>可变的单例</code>（Singleton）或<code>全局变量</code>的设计中，出现（不正确的）共享。</p>
<h2 id="5-1-使用-ThreadLocal-确保线程封闭性"><a href="#5-1-使用-ThreadLocal-确保线程封闭性" class="headerlink" title="5.1 使用 ThreadLocal 确保线程封闭性"></a>5.1 使用 ThreadLocal 确保线程封闭性</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionDispenser</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">DB_URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost/test&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ThreadLocal&lt;Connection&gt; connectionHolder = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Connection&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Connection <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> DriverManager.getConnection(DB_URL);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;无法获取连接, e&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> connectionHolder.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setConnection</span><span class="params">(ThreadLocal&lt;Connection&gt; connection)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.connectionHolder = connection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以将 <code>ThreadLocal&lt;T&gt;</code> 看作 <code>Map&lt;Thread, T&gt;</code> 它存储了与线程相关的值（不过事实上它并非这样实现的）。</p>
<p>与线程相关的值存储在线程对象自身中，线程终止后，这些值会被垃圾回收。</p>
<h1 id="6-不可变性"><a href="#6-不可变性" class="headerlink" title="6. 不可变性"></a>6. 不可变性</h1><p>多个线程总试图访问相同的可变状态，可能会出现未及时更新、访问的数据为过期数据。</p>
<p>如果对象的状态不能被修改，那么这些风险与复杂度就自然而然的消失了。</p>
<h2 id="6-1-对象的不可变"><a href="#6-1-对象的不可变" class="headerlink" title="6.1 对象的不可变"></a>6.1 对象的不可变</h2><p>不可变性病不生简单地等于将对中的所有域都声明为 <code>final</code> 类型，所有域都是 <code>finel</code> 类型的对象仍然是可变的，因为 <code>final</code> 域可以获得一个可变对象的引用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">不可变对象需要满足：</span><br><span class="line">1. 对象创建后，状态不能被修改</span><br><span class="line">2. 所有域都是 final 类型</span><br><span class="line">3. 对象创建期间没有发生 this 引用的逸出</span><br></pre></td></tr></table></figure>



<h2 id="6-2-构造于底层可变对象之上的不可变类"><a href="#6-2-构造于底层可变对象之上的不可变类" class="headerlink" title="6.2 构造于底层可变对象之上的不可变类"></a>6.2 构造于底层可变对象之上的不可变类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.Immutable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.Vector;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Immutable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ThreeStooges</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; stooges = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreeStooges</span><span class="params">()</span> &#123;</span><br><span class="line">        stooges.add(<span class="string">&quot;Moe&quot;</span>);</span><br><span class="line">        stooges.add(<span class="string">&quot;Larry&quot;</span>);</span><br><span class="line">        stooges.add(<span class="string">&quot;Curly&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isStooge</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> stooges.contains(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStoogeNames</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; stooges = <span class="keyword">new</span> <span class="title class_">Vector</span>&lt;&gt;();</span><br><span class="line">        stooges.add(<span class="string">&quot;Moe&quot;</span>);</span><br><span class="line">        stooges.add(<span class="string">&quot;Larry&quot;</span>);</span><br><span class="line">        stooges.add(<span class="string">&quot;Curly&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> stooges.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ThreeStooges</span> <span class="variable">threeStooges</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreeStooges</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;threeStooges.stooges = &quot;</span> + threeStooges.stooges);</span><br><span class="line">        <span class="comment">// threeStooges.stooges = [Moe, Larry, Curly]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尽管存储 <code>String</code> 的 <code>Set</code> 是可变的，不过 <code>ThreeStooges</code> 的设计使得 <code>ThreeStooges</code> 对象被创建后，就不能再修改 <code>set</code>。</p>
<p><code>stooges</code> 引用是 <code>final</code> 类型的，所以所有的对象状态只能通过 final 域进行询问（满足不可变对象的要求）</p>
<h2 id="6-3-使用-volatile-发布不可变对象"><a href="#6-3-使用-volatile-发布不可变对象" class="headerlink" title="6.3 使用 volatile 发布不可变对象"></a>6.3 使用 volatile 发布不可变对象</h2><p>在不可变的容器中混存数字和它的因数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.Immutable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 不可变容器，混存值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Immutable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OneValueCache</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BigInteger lastNumber;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BigInteger[] lastFactors;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OneValueCache</span><span class="params">(BigInteger i,</span></span><br><span class="line"><span class="params">                         BigInteger[] factors)</span> &#123;</span><br><span class="line">        lastNumber = i;</span><br><span class="line">        lastFactors = Arrays.copyOf(factors, factors.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BigInteger[] getFactors(BigInteger i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastNumber == <span class="literal">null</span> || !lastNumber.equals(i)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Arrays.copyOf(lastFactors, lastFactors.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过使用不可变对象来持有所有的变量，可以消除在访问和更新这些变量时的竟争条件。</p>
<p>若使用可变的容器对象，须使用锁以确保原子性。</p>
<p>使用不可变对象，一旦有一个线程获得了它的引用，永远不必担心其他线程会修改它的状态。</p>
<h1 id="7-安全发布"><a href="#7-安全发布" class="headerlink" title="7. 安全发布"></a>7. 安全发布</h1><h2 id="7-1-不可变容器的-volatile-类型引用"><a href="#7-1-不可变容器的-volatile-类型引用" class="headerlink" title="7.1 不可变容器的 volatile 类型引用"></a>7.1 不可变容器的 volatile 类型引用</h2><p>不可变容器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.Immutable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 不可变容器，混存值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Immutable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OneValueCache</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BigInteger lastNumber;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BigInteger[] lastFactors;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OneValueCache</span><span class="params">(BigInteger i,</span></span><br><span class="line"><span class="params">                         BigInteger[] factors)</span> &#123;</span><br><span class="line">        lastNumber = i;</span><br><span class="line">        <span class="comment">// 防止空指针异常</span></span><br><span class="line">        <span class="keyword">if</span> (factors == <span class="literal">null</span>) &#123;</span><br><span class="line">            lastFactors = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            lastFactors = Arrays.copyOf(factors, factors.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BigInteger[] getFactors(BigInteger i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastNumber == <span class="literal">null</span> || !lastNumber.equals(i)) &#123;</span><br><span class="line">            <span class="comment">// lastNumber = null 或 lastNumber != i</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Arrays.copyOf(lastFactors, lastFactors.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>使用到不可变容器对象的 volatile 类型引用，缓存最新的结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.GenericServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.Servlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用到不可变容器对象的 volatile 类型引用，缓存最新的结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VolatileCachedFactories</span> <span class="keyword">extends</span> <span class="title class_">GenericServlet</span> <span class="keyword">implements</span> <span class="title class_">Servlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">OneValueCache</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OneValueCache</span>(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest req, ServletResponse resp)</span> &#123;</span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">i</span> <span class="operator">=</span> extractFromRequest(req);</span><br><span class="line">        BigInteger[] factors = cache.getFactors(i);</span><br><span class="line">        <span class="keyword">if</span> (factors == <span class="literal">null</span>) &#123;</span><br><span class="line">            factors = factor(i);</span><br><span class="line">            cache = <span class="keyword">new</span> <span class="title class_">OneValueCache</span>(i, factors);</span><br><span class="line">        &#125;</span><br><span class="line">        encodeIntoResponse(resp, factors);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">encodeIntoResponse</span><span class="params">(ServletResponse resp, BigInteger[] factors)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BigInteger <span class="title function_">extractFromRequest</span><span class="params">(ServletRequest req)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="string">&quot;7&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BigInteger[] factor(BigInteger i) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigInteger</span>[]&#123;i&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>VolatileCachedFactories</code> 利用 <code>OneValuecache</code> 存储缓存的数字及其因数。</p>
<p>当一个线程设置 <code>volatile</code> 类型的 <code>cache</code> 域引用到一个新的 OnevalueCache 后，新数据会立即对其他线程可见。</p>
<h2 id="7-2-在没有适当的同步的情况下就发布对象"><a href="#7-2-在没有适当的同步的情况下就发布对象" class="headerlink" title="7.2 在没有适当的同步的情况下就发布对象"></a>7.2 在没有适当的同步的情况下就发布对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Holder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Holder</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.n = n;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StuffIntoPublic</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Holder holder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> &#123;</span><br><span class="line">        holder = <span class="keyword">new</span> <span class="title class_">Holder</span>(<span class="number">42</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>holder</code> 容器还是会在其他线程中被设置为一个不一致的状态。</p>
<p>即使它的不变约束已经在构造函数中得以正确创建。如多个线程都调用 <code>initialize()</code>，其 <code>holder</code> 成员变量的引用会发生多次改变。</p>
<h2 id="7-3-安全发布的模式"><a href="#7-3-安全发布的模式" class="headerlink" title="7.3 安全发布的模式"></a>7.3 安全发布的模式</h2><p>为了安全地发布对象，<code>对象的引用</code>以及<code>对象的状态</code>必须同时<code>对其他线程可见</code>。</p>
<p>一个正确创建的对象可以通过下列条件安全地发布：</p>
<ul>
<li>通过静态初始化器初始化对象的引用；</li>
<li>将它的引用存储到 <code>volatile域</code> 或 <code>AtomicReference</code>；</li>
<li>将它的引用存储到正确创建的对象的 <code>final 域</code>中；</li>
<li>或者将它的引用存储到由锁正确保护的域中。</li>
</ul>
<h2 id="7-4-高效不可变对象"><a href="#7-4-高效不可变对象" class="headerlink" title="7.4 高效不可变对象"></a>7.4 高效不可变对象</h2><p>被安全发布后，状态不能被修改的对象，叫作高效不可变对象。不可变对象是线程安全的。它们的常量（变量）是在构造函数中创建的。</p>
<p>如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo9</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Map&lt;String, Date&gt; lastLogin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Demo9</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Date&gt; stringDate = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        stringDate.put(<span class="string">&quot;LeeHua&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        stringDate.put(<span class="string">&quot;Rainbow&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        lastLogin = Collections.synchronizedMap(stringDate);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果 <code>Date</code> 值在置入 <code>Map</code> 中后就不会改变，那么 <code>synchronizedMap</code> 中同步的实现，对于安全地发布 <code>Date</code> 值，是至关重要的。而访问这些 <code>Date</code> 值时就不再需要额外的同步。</p>
<h2 id="7-5-可变对象"><a href="#7-5-可变对象" class="headerlink" title="7.5 可变对象"></a>7.5 可变对象</h2><p>发布对象的必要条件依赖于对象的可变性：</p>
<ul>
<li><p>不可变对象可以通过任意机制发布；</p>
</li>
<li><p>高效不可变对象必须要安全发布；</p>
</li>
<li><p>可变对象必须要安全发布，同时必须要线程安全或者是被锁保护。</p>
</li>
</ul>
<h2 id="7-6-安全地共享对象"><a href="#7-6-安全地共享对象" class="headerlink" title="7.6 安全地共享对象"></a>7.6 安全地共享对象</h2><p>在并发程序中，使用和共享对象的一些最有效的策略如下：</p>
<ul>
<li><code>线程限制</code>：一个线程限制的对象，通过限制在线程中，而被线程独占，且只能被占有它的线程修改。</li>
<li><code>共享只读(shared read-only)</code>：一个共享的只读对象，在没有额外同步的情况下，可以被多个线程并发地访问 ，但是任何线程都不能修改它。共享只读对象包括可变对象与高效不可变对象。</li>
<li><code>共享线程安全(shared thread-safe)</code>：一个线程安全的对象在内部进行同步，所以共他线程无须额外同步，就可以通过公共接口随意地访问它。</li>
<li><code>被守护的(Guarded)</code>：一个被守护的对象只能通过特定的锁来访问。被守护的对象包括那些被线程安全对象封装的对象，和已知被特定的锁保护起来的已发布对象。</li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>Java并发编程实战：第3章 对象的共享</p><p><a href="https://osys.github.io/posts/fff0.html">https://osys.github.io/posts/fff0.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Osys</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022年08月29日</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022年08月29日</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/posts/f8f2.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Java并发编程实战：第4章 组合对象</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/posts/406e.html"><span class="level-item">Java并发编程实战：第2章 线程安全性</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "5daae911962812389a8ae4f656e699d3",
            repo: "osys.github.io",
            owner: "osys",
            clientID: "e0f10cf0c934d445e79f",
            clientSecret: "3dad6d25224fe45db31a3a912756bd5175e3a70f",
            admin: ["osys"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-8-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#1-可见性"><span class="level-left"><span class="level-item">1. 可见性</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-可见性"><span class="level-left"><span class="level-item">1.1 可见性</span></span></a></li><li><a class="level is-mobile" href="#1-2-在没有同步的情况下共享变量"><span class="level-left"><span class="level-item">1.2 在没有同步的情况下共享变量</span></span></a></li><li><a class="level is-mobile" href="#1-3-失效数据"><span class="level-left"><span class="level-item">1.3 失效数据</span></span></a></li><li><a class="level is-mobile" href="#1-4-非原子的-64-位操作"><span class="level-left"><span class="level-item">1.4 非原子的 64 位操作</span></span></a></li><li><a class="level is-mobile" href="#1-5-加锁与可见性"><span class="level-left"><span class="level-item">1.5 加锁与可见性</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-Volatile-关键字"><span class="level-left"><span class="level-item">2. Volatile 关键字</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-什么是重排序"><span class="level-left"><span class="level-item">2.1 什么是重排序</span></span></a></li><li><a class="level is-mobile" href="#2-2-可见性"><span class="level-left"><span class="level-item">2.2 可见性</span></span></a></li><li><a class="level is-mobile" href="#2-3-volatile-关键字"><span class="level-left"><span class="level-item">2.3 volatile 关键字</span></span></a></li><li><a class="level is-mobile" href="#2-4-分析-volatile-变量"><span class="level-left"><span class="level-item">2.4 分析 volatile 变量</span></span></a></li><li><a class="level is-mobile" href="#2-5-局限性"><span class="level-left"><span class="level-item">2.5 局限性</span></span></a></li></ul></li><li><a class="level is-mobile" href="#3-发布与逸出"><span class="level-left"><span class="level-item">3. 发布与逸出</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-发布-Publish"><span class="level-left"><span class="level-item">3.1 发布(Publish)</span></span></a></li><li><a class="level is-mobile" href="#3-2-逸出-Escape"><span class="level-left"><span class="level-item">3.2 逸出(Escape)</span></span></a></li><li><a class="level is-mobile" href="#3-3-安全地对象构造"><span class="level-left"><span class="level-item">3.3 安全地对象构造</span></span></a></li></ul></li><li><a class="level is-mobile" href="#4-线程封闭"><span class="level-left"><span class="level-item">4. 线程封闭</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-1-线程封闭"><span class="level-left"><span class="level-item">4.1 线程封闭</span></span></a></li><li><a class="level is-mobile" href="#4-2-Ad-hoc-线程封闭"><span class="level-left"><span class="level-item">4.2 Ad-hoc 线程封闭</span></span></a></li><li><a class="level is-mobile" href="#4-3-栈封闭（线程局部使用）"><span class="level-left"><span class="level-item">4.3 栈封闭（线程局部使用）</span></span></a></li></ul></li><li><a class="level is-mobile" href="#5-ThreadLocal"><span class="level-left"><span class="level-item">5. ThreadLocal</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#5-1-使用-ThreadLocal-确保线程封闭性"><span class="level-left"><span class="level-item">5.1 使用 ThreadLocal 确保线程封闭性</span></span></a></li></ul></li><li><a class="level is-mobile" href="#6-不可变性"><span class="level-left"><span class="level-item">6. 不可变性</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-1-对象的不可变"><span class="level-left"><span class="level-item">6.1 对象的不可变</span></span></a></li><li><a class="level is-mobile" href="#6-2-构造于底层可变对象之上的不可变类"><span class="level-left"><span class="level-item">6.2 构造于底层可变对象之上的不可变类</span></span></a></li><li><a class="level is-mobile" href="#6-3-使用-volatile-发布不可变对象"><span class="level-left"><span class="level-item">6.3 使用 volatile 发布不可变对象</span></span></a></li></ul></li><li><a class="level is-mobile" href="#7-安全发布"><span class="level-left"><span class="level-item">7. 安全发布</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#7-1-不可变容器的-volatile-类型引用"><span class="level-left"><span class="level-item">7.1 不可变容器的 volatile 类型引用</span></span></a></li><li><a class="level is-mobile" href="#7-2-在没有适当的同步的情况下就发布对象"><span class="level-left"><span class="level-item">7.2 在没有适当的同步的情况下就发布对象</span></span></a></li><li><a class="level is-mobile" href="#7-3-安全发布的模式"><span class="level-left"><span class="level-item">7.3 安全发布的模式</span></span></a></li><li><a class="level is-mobile" href="#7-4-高效不可变对象"><span class="level-left"><span class="level-item">7.4 高效不可变对象</span></span></a></li><li><a class="level is-mobile" href="#7-5-可变对象"><span class="level-left"><span class="level-item">7.5 可变对象</span></span></a></li><li><a class="level is-mobile" href="#7-6-安全地共享对象"><span class="level-left"><span class="level-item">7.6 安全地共享对象</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/basic/avatar.png" alt="Osys"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Osys</p><p class="is-size-6 is-block">追寻美好生活，书写人生精彩篇章。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>GuangZhou</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">31</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">5</p></a></div></div></nav></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">29</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%A1%B9%E7%9B%AE%E6%A1%88%E4%BE%8B/"><span class="level-start"><span class="level-item">项目案例</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><span class="tag">Java并发编程</span><span class="tag">29</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringBoot/"><span class="tag">SpringBoot</span><span class="tag">2</span></a></div></div></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/09/"><span class="level-start"><span class="level-item">九月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">29</span></span></a></li></ul></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.cnblogs.com/liyihua/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">我的博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/qq_44830823?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">我的CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="footer-content"><div class="footer-left"><div class="footer-logo-section"><a class="footer-logo" href="/"><div class="footer-logo-row"><img src="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png" alt="LeeHua&#039;s Blog" height="35"><span class="footer-tagline">LeeHua&#039;s Blog</span></div><div class="footer-runtime"><span class="footer-osys">OSYS</span><div class="footer-runtime-text" id="site-runtime">本站已安全运行1159 天 16 小时 11 分钟 57 秒</div></div></a></div><div class="footer-info"><p class="footer-statistics"><script src="https://sdk.51.la/perf/js-sdk-pro.min.js" crossorigin="anonymous"></script><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js?id=JoDQdGZeB7Cy04AN&amp;ck=JoDQdGZeB7Cy04AN"></script><a target="blank" title="网站统计" href="https://v6.51.la/land/JoDQdGZeB7Cy04AN"></a><script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoDQdGZeB7Cy04AN/quote.js?theme=0&amp;f=12&amp;display=0,1,1,1,1,1,0,1"></script></p><a href="https://beian.miit.gov.cn/" target="_blank"><div class="footer-card"><span class="footer-card-title">备案号:</span> 粤ICP备2022104988号</div></a><a href="https://github.com/" target="_blank"><div class="footer-card"><span class="footer-card-title">网站:</span> 挂载于 github + 腾讯云</div></a><a href="https://github.com/" target="_blank"><div class="footer-card"><span class="footer-card-title">图片:</span> 挂载于 github</div></a><a href="https://www.jsdelivr.com/github" target="_blank"><div class="footer-card"><span class="footer-card-title">CDN:</span> jsDelivr</div></a></div></div><div class="footer-right"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="粤ICP备2022104988号-1" href="https://beian.miit.gov.cn/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Blog on GitHub" href="https://github.com/osys/osys.github.io/"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container" id="algolia-input"></div><div id="algolia-poweredby" style="display:flex;margin:0 .5em 0 1em;align-items:center;line-height:0"></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div><div class="searchbox-footer"></div></div></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.0.3/dist/algoliasearch-lite.umd.js" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.3.1/dist/instantsearch.production.min.js" crossorigin="anonymous" defer></script><script src="/js/algolia.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadAlgolia({"applicationId":"8FPI8CDLJR","apiKey":"702cfc5bf8397419842065704ec39904","indexName":"github_pages_hexo_blog"}, {"hint":"想要查找什么...","no_result":"未找到搜索结果","untitled":"(无标题)","empty_preview":"(无内容预览)"});
        });</script></body></html>