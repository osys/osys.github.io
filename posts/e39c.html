<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Java并发编程实战：第6章 任务执行 - 数据开发猿</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="Osys&#039;s Blog"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Osys&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="1. 在线程中执行任务1.1 在线程中执行任务 多数并发程序是围绕任务进行管理的，所谓任务就是抽象、离散的工作单元。 正常情况下，服务器应该兼顾良好的吞吐量和快速的响应性。 在负荷状况下，应该平缓的劣化，不应该快速失败，为了达到这些策略，应该有一个明确的任务执行策略。"><meta property="og:type" content="blog"><meta property="og:title" content="Java并发编程实战：第6章 任务执行"><meta property="og:url" content="https://osys.github.io/"><meta property="og:site_name" content="Osys&#039;s Blog"><meta property="og:description" content="1. 在线程中执行任务1.1 在线程中执行任务 多数并发程序是围绕任务进行管理的，所谓任务就是抽象、离散的工作单元。 正常情况下，服务器应该兼顾良好的吞吐量和快速的响应性。 在负荷状况下，应该平缓的劣化，不应该快速失败，为了达到这些策略，应该有一个明确的任务执行策略。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20220829215558.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20220829215558.png"><meta property="article:published_time" content="2022-08-29T14:09:33.000Z"><meta property="article:modified_time" content="2022-08-29T14:40:44.801Z"><meta property="article:author" content="Osys"><meta property="article:tag" content="Java并发编程"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20220829215558.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://osys.github.io/"},"headline":"Osys's Blog","image":["https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20220829215558.png","https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20220829215558.png"],"datePublished":"2022-08-29T14:09:33.000Z","dateModified":"2022-08-29T14:40:44.801Z","author":{"@type":"Person","name":"Osys"},"publisher":{"@type":"Organization","name":"Osys","logo":{"@type":"ImageObject","url":"https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"}},"description":"编程路上的小学生。热爱电脑相关技术。对 Java 情有独钟"}</script><link rel="canonical" href="https://osys.github.io/posts/e39c.html"><link rel="alternate" href="/path/to/atom.xml" title="数据开发猿" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?44cd31785e14a1fdaad0921651759e0f";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 6.0.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png" alt="数据开发猿" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-08-29T14:09:33.000Z" title="8/29/2022, 10:09:33 PM">2022年08月29日</time>发表</span><span class="level-item"><time dateTime="2022-08-29T14:40:44.801Z" title="8/29/2022, 10:40:44 PM">2022年08月29日</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Java/">Java</a></span><span class="level-item">44 分钟读完 (大约6608个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Java并发编程实战：第6章 任务执行</h1><div class="content"><h1 id="1-在线程中执行任务"><a href="#1-在线程中执行任务" class="headerlink" title="1. 在线程中执行任务"></a>1. 在线程中执行任务</h1><h2 id="1-1-在线程中执行任务"><a href="#1-1-在线程中执行任务" class="headerlink" title="1.1 在线程中执行任务"></a>1.1 在线程中执行任务</h2><ul>
<li>多数并发程序是围绕任务进行管理的，所谓<code>任务</code>就是抽象、离散的工作单元。</li>
<li>正常情况下，服务器应该兼顾<strong>良好的吞吐量和快速的响应性</strong>。</li>
<li>在负荷状况下，应该<strong>平缓的劣化</strong>，不应该快速失败，为了达到这些策略，应该有一个明确的任务执行策略。</li>
</ul>
<span id="more"></span>

<h2 id="1-2-顺序地执行任务"><a href="#1-2-顺序地执行任务" class="headerlink" title="1.2 顺序地执行任务"></a>1.2 顺序地执行任务</h2><p>顺序化地 Web Server</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SingleThreadWebServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">80</span>);</span><br><span class="line">        <span class="comment">// 顺序执行，接受连接，处理连接</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">connection</span> <span class="operator">=</span> socket.accept();</span><br><span class="line">            handleRequest(connection);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleRequest</span><span class="params">(Socket connection)</span> &#123;</span><br><span class="line">        <span class="comment">// 处理逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>顺序处理<code>并发性能低</code>，必须等待一个请求结束才能响应下一个请求。其他线程在等待某个请求处理结束时，CPU可能较为空闲，因此导致资源利用率非常低。</p>
<h2 id="1-3-显式的为任务创建线程"><a href="#1-3-显式的为任务创建线程" class="headerlink" title="1.3 显式的为任务创建线程"></a>1.3 显式的为任务创建线程</h2><p>Web Server为每个请求启动一个新的线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPerTaskWebServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">80</span>);</span><br><span class="line">        <span class="comment">// 并发处理请求</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Socket</span> <span class="variable">connection</span> <span class="operator">=</span> socket.accept();</span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    handleRequest(connection);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(task).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleRequest</span><span class="params">(Socket connection)</span> &#123;</span><br><span class="line">        <span class="comment">// 处理逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主循环为每个连接都创建一个<code>新线程</code>以<code>处理请求</code>，而<code>不在主循环</code>的内部<code>处理请求</code>。</p>
<p>结论：</p>
<ol>
<li>执行任务的负载已经脱离了主线程</li>
<li>并行处理任务，使得可以多个请求同时得到服务</li>
<li>任务处理代码必须是线程安全的，因为有多个任务会并发地调用它。</li>
</ol>
<h2 id="1-4-无限制创建线程的缺点"><a href="#1-4-无限制创建线程的缺点" class="headerlink" title="1.4 无限制创建线程的缺点"></a>1.4 无限制创建线程的缺点</h2><p>显式的为任务创建线程实例中，为每个任务都创建一个线程，存在一些实际的缺陷：</p>
<ul>
<li><strong>线程生命周期的开销。</strong>创建和关闭线程都需要借助操作系统，花费大量时间。</li>
<li><strong>资源消耗高。</strong>如果可运行的线程数超过可用的处理器数，线程将会空闲。大量空闲线程会占用更多的内存。</li>
<li><strong>稳定性问题。</strong>应该限制可创建线程的数目。</li>
</ul>
<p>通常来说，在一定范围增加创建线程，可以提高系统的吞吐量，一旦超出范围，创建更多线程可能占用过多资源，导致程序出现各种问题。</p>
<h1 id="2-Executor-框架"><a href="#2-Executor-框架" class="headerlink" title="2. Executor 框架"></a>2. Executor 框架</h1><h2 id="2-1-Executor-框架"><a href="#2-1-Executor-框架" class="headerlink" title="2.1 Executor 框架"></a>2.1 Executor 框架</h2><p><strong>任务是逻辑上的工作单元，线程是使任务异步执行的机制。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.util.concurrent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Executor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在将来的某个时间执行给定的命令。该命令可以在新线程、池线程或调用线程中执行，具体取决于执行者实现。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> command 可运行的任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Executor为任务提交和任务执行提供了解耦的标准方法。</p>
<h2 id="2-2-使用-Executor-实现-Web-Server"><a href="#2-2-使用-Executor-实现-Web-Server" class="headerlink" title="2.2 使用 Executor 实现 Web Server"></a>2.2 使用 Executor 实现 Web Server</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskExecutionWebServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THEAD_NUM</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Executor</span> <span class="variable">EXEC</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(THEAD_NUM, THEAD_NUM, <span class="number">0</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="number">100</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">80</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Socket</span> <span class="variable">connection</span> <span class="operator">=</span> socket.accept();</span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    handleRequest(connection);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            EXEC.execute(task);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleRequest</span><span class="params">(Socket connection)</span> &#123;</span><br><span class="line">        <span class="comment">// 处理逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过Executor我们将任务<code>提交</code>和<code>执行</code>进行了解耦，代替了硬编码的创建线程。</p>
<h2 id="2-3-执行策略"><a href="#2-3-执行策略" class="headerlink" title="2.3 执行策略"></a>2.3 执行策略</h2><p>一个执行策略明确了需要在任务执行过程关注的点：</p>
<ul>
<li>任务在什么线程执行？</li>
<li>任务以什么方式执行？</li>
<li>可以有多少个任务并发执行？</li>
<li>可以有多少任务进入等待队列？</li>
<li>如果任务过载，需要放弃任务，怎么办？</li>
<li>一个任务执行前后，应该做什么？</li>
</ul>
<p>执行策略是对资源管理的工具，最佳策略取决于可用的计算资源和你对服务质量的要求。</p>
<h2 id="2-4-线程池"><a href="#2-4-线程池" class="headerlink" title="2.4 线程池"></a>2.4 线程池</h2><ul>
<li>线程池管理工作者线程，帮助我们管理工作线程的创建和销毁，工作队列的处理，可用让我们更加关注任务的编写上。</li>
<li>工作队列：其作用是持有所有等待执行的任务。</li>
</ul>
<p>使用线程池好处：</p>
<ul>
<li>重用存在的线程，而不是创建新的线程，这可以在处理多请求时抵消线程创建、消亡产生的开销。</li>
<li>在请求到达时，工作者线程通常已经存在，用于创建线程的等待时间并不会延迟任务的执行，因此提高了响应性。</li>
<li>通过适当地调整线程池的大小，你可以得到足够多的线程以保持处理器忙碌，同时可以还防止过多的线程相互竞争资源，导致应用程序耗尽内存或者失败。</li>
</ul>
<p>类库<code>Executors</code>提供了我们多种创建线程池的静态方法。</p>
<ol>
<li><p>定长线程池 <code>newCachedThreadPool()</code></p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建一个固定长度的线程池</span></span><br><span class="line"><span class="comment"> * 每次提交一个任务，就创建一个线程，直达达到线程池最大长度</span></span><br><span class="line"><span class="comment"> * 在需要创建线程时，使用提供的ThreadFactory创建新线程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads, ThreadFactory threadFactory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads,</span><br><span class="line">            <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(),</span><br><span class="line">            threadFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 使用的工作队列是<code>new LinkedBlockingQueue()</code>也就是<strong>工作队列是无限的，最好设置固定大小</strong>。</p>
</li>
<li><p>可缓存线程池 <code>newCachedThreadPool()</code></p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建一个可缓存的线程池</span></span><br><span class="line"><span class="comment"> * 如果当前线程池的长度超过了处理的需要时，它可以灵活地回收空闲的线程</span></span><br><span class="line"><span class="comment"> * 当需求增加时，它可以灵活地添加新的线程，而并不会对池的长度作任何限制</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">            <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p>单线程化的 executor <code>newSingleThreadExecutor()</code></p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建一个单线程化的 executor</span></span><br><span class="line"><span class="comment"> * 它只创建唯一的工作者线程来执行任务，如果这个线程异常结束，会有另一个取代它</span></span><br><span class="line"><span class="comment"> * executor 会保证任务，依照任务队列所规定的顺序执行。 --- (FIFO, LIFO,优先级)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Executors</span>.FinalizableDelegatedExecutorService(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0L</span>, </span><br><span class="line">                                   TimeUnit.MILLISECONDS, </span><br><span class="line">                                   <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()</span><br><span class="line">            )</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p>定时的线程池 <code>newScheduledThreadPool()</code></p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建一个定长的线程池</span></span><br><span class="line"><span class="comment"> * 支持定时的，以及周期性的任务执行。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title function_">newScheduledThreadPool</span><span class="params">(<span class="type">int</span> corePoolSize)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(corePoolSize);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在需要创建线程时，使用提供的ThreadFactory创建新线程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title function_">newScheduledThreadPool</span><span class="params">(<span class="type">int</span> corePoolSize, ThreadFactory threadFactory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(corePoolSize, threadFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="2-5-Executor-的生命周期"><a href="#2-5-Executor-的生命周期" class="headerlink" title="2.5 Executor 的生命周期"></a>2.5 Executor 的生命周期</h2><p>Executor 本身并没有解决生命周期问题，它的子接口 <code>ExecutorService</code> 提供了一些接口用于解决这个问题：</p>
<p><img src="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20220829215558.png" alt="1"></p>
<ul>
<li><p><code>shudown()</code> 方法</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 调用这个方法时，ExecutorService 停止接受任何新的任务</span></span><br><span class="line"><span class="comment"> * 且等待已经提交的任务执行完成，当所有已经提交的任务执行完毕后将会关闭ExecutorService</span></span><br><span class="line"><span class="comment"> * (已经提交的任务会分两类：一类是已经在执行的，另一类是还没有开始执行的)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

</li>
<li><p><code>shutdownNow()</code> 方法</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 调这个方法会强制关闭 ExecutorService，</span></span><br><span class="line"><span class="comment"> * 它将取消所有运行中的任务和在工作队列中等待的任务，</span></span><br><span class="line"><span class="comment"> * 这个方法返回一个 List 列表，列表中返回的是等待在工作队列中的任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;Runnable&gt; <span class="title function_">shutdownNow</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

</li>
<li><p><code>isShutdown()</code> 方法</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** ExecutorService 关闭后返回true，否则返回false */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isShutdown</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

</li>
<li><p><code>isTerminated()</code> 方法</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ExecutorService 关闭后所有任务都已完成，则返回true</span></span><br><span class="line"><span class="comment"> * 注意：除非先调用 shutdown() 或 shutdowNow()，否则 isTerminated 永远不会为 true</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isTerminated</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

</li>
<li><p><code>awaitTermination()</code> 方法</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在执行 shutdown() 后，阻塞 ExecutorService 关闭，</span></span><br><span class="line"><span class="comment"> * 直到所有任务都完成，或者直到 timeout，或者当前线程被中断。</span></span><br><span class="line"><span class="comment"> * 以先发生者为准。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeout 超时时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> unit 超时参数的时间单位。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 如果 ExecutorService 关闭，return true</span></span><br><span class="line"><span class="comment"> *         如果 timeout，ExecutorService 还未关闭，return false</span></span><br><span class="line"><span class="comment"> *         当前线程被中断，抛出 InterruptedException 异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">awaitTermination</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br></pre></td></tr></table></figure>

</li>
<li><p><code>submit()</code> 方法</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提交一个任务到 Executor 工作队列中，执行该任务，并返回 Future&lt;T&gt; 结果。</span></span><br><span class="line"><span class="comment"> * 参为 Runnable 时，执行 Runnable 的 run()方法</span></span><br><span class="line"><span class="comment"> *      返回值 Future.get() 的结果为 null。</span></span><br><span class="line"><span class="comment"> * 参为 Runnable 和 result 时，执行 Runnable 的 run()方法</span></span><br><span class="line"><span class="comment"> *      返回值 Future.get() 的结果为传入的 result。</span></span><br><span class="line"><span class="comment"> * 参为 Callable 时，则执行 Callable 的 call() 方法，</span></span><br><span class="line"><span class="comment"> *      返回值 Future.get() 的结果为 call() 的返回值。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> task 两种类型的 task：Callable&lt;T&gt;、Runnable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> result 返回的结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 执行后，返回的是 Future&lt;T&gt; 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">&lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;T&gt; task)</span>;</span><br><span class="line"></span><br><span class="line">&lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Runnable task, T result)</span>;</span><br><span class="line"></span><br><span class="line">Future&lt;?&gt; submit(Runnable task);</span><br></pre></td></tr></table></figure>

</li>
<li><p><code>invokeAll()</code> 方法</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提交任务集到 ExecutorService，返回所有任务的执行结果。</span></span><br><span class="line"><span class="comment"> * 该方法会阻塞，必须等待所有的任务执行完成后统一返回。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 如果全部任务在指定的时间内没有完成，则抛出异常。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tasks Collection&lt;? extends Callable&lt;T&gt;&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeout 超时时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> unit 时间单位</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 执行后，返回的是 &lt;T&gt; List&lt;Future&lt;T&gt;&gt; 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">&lt;T&gt; List&lt;Future&lt;T&gt;&gt; <span class="title function_">invokeAll</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">&lt;T&gt; List&lt;Future&lt;T&gt;&gt; <span class="title function_">invokeAll</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, <span class="type">long</span> timeout, TimeUnit unit)</span>  <span class="keyword">throws</span> InterruptedException;</span><br></pre></td></tr></table></figure>

</li>
<li><p><code>invokeAny()</code> 方法</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 提交任务集到 ExecutorService，返回第一个执行完的任务的结果值 */</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 提交任务集到 ExecutorService，在指定时间内，返回第一个执行完的任务的结果值，否则 Exception */</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, <span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>支持关闭操作的 Web Server 示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RejectedExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Level;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LifecycleWebServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">int</span> <span class="variable">THREAD_NUM</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="comment">/** 创建 ExecutorService */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">exec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(THREAD_NUM, THREAD_NUM, <span class="number">0</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="number">100</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 创建 socket 连接</span></span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">80</span>);</span><br><span class="line">        <span class="comment">// ExecutorService 未关闭</span></span><br><span class="line">        <span class="keyword">while</span> (!exec.isShutdown()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 接受Socket连接</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">Socket</span> <span class="variable">conn</span> <span class="operator">=</span> socket.accept();</span><br><span class="line">                <span class="comment">// 向 ExecutorService 提交任务</span></span><br><span class="line">                exec.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        handleRequest(conn);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!exec.isShutdown()) &#123;</span><br><span class="line">                    log(<span class="string">&quot;任务提交被拒绝&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        exec.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(String msg, Exception e)</span> &#123;</span><br><span class="line">        Logger.getAnonymousLogger().log(Level.WARNING, msg, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 处理逻辑 */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">handleRequest</span><span class="params">(Socket connection)</span> &#123;</span><br><span class="line">        <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> readRequest(connection);</span><br><span class="line">        <span class="keyword">if</span> (isShutdownRequest(req)) &#123;</span><br><span class="line">            stop();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dispatchRequest(req);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Request</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Request <span class="title function_">readRequest</span><span class="params">(Socket s)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dispatchRequest</span><span class="params">(Request r)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isShutdownRequest</span><span class="params">(Request r)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该实例，利用 <code>ExecutorService</code> 提供的生命周期管理方法进行处理</p>
<h2 id="2-6-延迟的、周期性的任务"><a href="#2-6-延迟的、周期性的任务" class="headerlink" title="2.6 延迟的、周期性的任务"></a>2.6 延迟的、周期性的任务</h2><p>在上面的 <code>线程池</code> 说明中，有描述到：<strong>定时的线程池 <code>newScheduledThreadPool()</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建一个定长的线程池</span></span><br><span class="line"><span class="comment"> * 支持定时的，以及周期性的任务执行。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title function_">newScheduledThreadPool</span><span class="params">(<span class="type">int</span> corePoolSize)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(corePoolSize);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在需要创建线程时，使用提供的ThreadFactory创建新线程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title function_">newScheduledThreadPool</span><span class="params">(<span class="type">int</span> corePoolSize, ThreadFactory threadFactory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(corePoolSize, threadFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ScheduledExecutorService</code> 接口继承了 <code>ExecutorService</code> 接口。其接口方法有：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建并执行在给定延迟后启用的单次操作。</span></span><br><span class="line"><span class="comment"> * command - 要执行的任务</span></span><br><span class="line"><span class="comment"> * delay - 从现在开始延迟执行的时间</span></span><br><span class="line"><span class="comment"> * unit - 延时参数的时间单位</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * return 表示任务等待完成，并且其的 ScheduledFuture get()方法将返回 null</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Exception</span></span><br><span class="line"><span class="comment"> *      RejectedExecutionException - 如果任务无法安排执行</span></span><br><span class="line"><span class="comment"> *      NullPointerException - 如果命令为空</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; schedule(Runnable command, <span class="type">long</span> delay, TimeUnit unit);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建并执行在给定延迟后启用的ScheduledFuture。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * callable - 执行的功能</span></span><br><span class="line"><span class="comment"> * delay - 从现在开始延迟执行的时间</span></span><br><span class="line"><span class="comment"> * unit - 延迟参数的时间单位</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * return 一个可用于提取结果或取消的ScheduledFuture</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Exception</span></span><br><span class="line"><span class="comment"> *      RejectedExecutionException - 如果该任务无法安排执行</span></span><br><span class="line"><span class="comment"> *      NullPointerException - 如果可调用为空</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;V&gt; ScheduledFuture&lt;V&gt; <span class="title function_">schedule</span><span class="params">(Callable&lt;V&gt; callable, <span class="type">long</span> delay, TimeUnit unit)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建并执行在给定的初始延迟之后，随后以给定的时间段首先启用的周期性动作; </span></span><br><span class="line"><span class="comment"> * 那就是执行将在 initialDelay 之后开始，然后 initialDelay + period ，然后是initialDelay + (2 * period) ......。 </span></span><br><span class="line"><span class="comment"> * 如果任务的执行遇到异常，则后续的执行被抑制。 否则，任务将仅通过取消或终止执行人终止。 </span></span><br><span class="line"><span class="comment"> * 如果任务执行时间比其周期长，则后续执行可能会迟到，但不会同时执行。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * command - 要执行的任务</span></span><br><span class="line"><span class="comment"> * initialDelay - 延迟第一次执行的时间</span></span><br><span class="line"><span class="comment"> * period - 连续执行之间的时期</span></span><br><span class="line"><span class="comment"> * unit - initialDelay和period参数的时间单位</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * return 一个ScheduledFuture代表待完成的任务，其 get()方法将在取消时抛出异常</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Exception</span></span><br><span class="line"><span class="comment"> *      RejectedExecutionException - 如果该任务无法安排执行</span></span><br><span class="line"><span class="comment"> *      NullPointerException - 如果可调用为空</span></span><br><span class="line"><span class="comment"> *      IllegalArgumentException - 如果周期小于或等于零</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command, <span class="type">long</span> initialDelay, <span class="type">long</span> period, TimeUnit unit);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建并执行在给定的初始延迟之后，首先启用的定期动作，随后在一个执行的终止和下一个执行的开始之间给定的延迟。 </span></span><br><span class="line"><span class="comment"> * 如果任务的执行遇到异常，则后续的执行被抑制。 否则，任务将仅通过取消或终止执行人终止。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * command - 要执行的任务</span></span><br><span class="line"><span class="comment"> * initialDelay - 延迟第一次执行的时间</span></span><br><span class="line"><span class="comment"> * period - 连续执行之间的时期</span></span><br><span class="line"><span class="comment"> * unit - initialDelay 和 period 参数的时间单位</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * return 一个 ScheduledFuture 代表待完成的任务，其 get() 方法将在取消时抛出异常</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Exception</span></span><br><span class="line"><span class="comment"> *      RejectedExecutionException - 如果该任务无法安排执行</span></span><br><span class="line"><span class="comment"> *      NullPointerException - 如果可调用为空</span></span><br><span class="line"><span class="comment"> *      IllegalArgumentException - 如果周期小于或等于零</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command, <span class="type">long</span> initialDelay, <span class="type">long</span> delay, TimeUnit unit);</span><br></pre></td></tr></table></figure>

<p>**对于延迟、周期任务可以考虑使用 <code>ScheduledThreadPoolExecutor</code> **</p>
<h1 id="3-寻找可强化的并行性"><a href="#3-寻找可强化的并行性" class="headerlink" title="3. 寻找可强化的并行性"></a>3. 寻找可强化的并行性</h1><h2 id="3-1-寻找可强化的并行性"><a href="#3-1-寻找可强化的并行性" class="headerlink" title="3.1 寻找可强化的并行性"></a>3.1 寻找可强化的并行性</h2><ul>
<li>Executor 框架让制定一个执行策略变得简单。不过想要使用 Executor，我们还必须能够将任务描述为 Runnable。</li>
<li>在大多数服务端程序中，基本都存在这样一个明显的任务边界：<code>单一的客户请求</code> 为任务边界。</li>
<li>但是，很多客户端程序中，任务边界有时并非如此显而易见。</li>
<li>即使在服务端程序中，<code>一个请求</code> 任务，内部仍然会有可以进一步细化的并行性。</li>
</ul>
<h2 id="3-2-顺序执行的页面渲染器"><a href="#3-2-顺序执行的页面渲染器" class="headerlink" title="3.2 顺序执行的页面渲染器"></a>3.2 顺序执行的页面渲染器</h2><ul>
<li><p><code>顺序处理</code></p>
<ol>
<li>处理 HTML 文档最简单的方法是<code>顺序处理</code>。 当遇到一个文本标签，就将它渲染到图像缓存里； </li>
<li>当遇到一个图像的引用时，先通过网络获取它，然后也将它渲染到图像缓存里。 </li>
<li>这样的顺序，可能会让用户等待很长时间，指导呈现出所有文本、图像</li>
</ol>
</li>
<li><p><code>预留占位符</code></p>
<ol>
<li>先渲染文本元素，并为图像预留出矩形的占位符</li>
<li>处理文本后，程序返回到开始，并下载图像，将它们绘制到相应的占位符上。</li>
</ol>
</li>
</ul>
<h2 id="3-3-示例：顺序的渲染页面元素"><a href="#3-3-示例：顺序的渲染页面元素" class="headerlink" title="3.3 示例：顺序的渲染页面元素"></a>3.3 示例：顺序的渲染页面元素</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">SingleThreadRenderer</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">renderPage</span><span class="params">(CharSequence source)</span> &#123;</span><br><span class="line">        <span class="comment">// 文本</span></span><br><span class="line">        renderText(source);</span><br><span class="line">        <span class="comment">// 图像</span></span><br><span class="line">        List&lt;ImageData&gt; imageData = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ImageInfo imageInfo : scanForImageInfo(source)) &#123;</span><br><span class="line">            imageData.add(imageInfo.downloadImage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (ImageData data : imageData) &#123;</span><br><span class="line">            renderImage(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">ImageData</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">ImageInfo</span> &#123;</span><br><span class="line">        ImageData <span class="title function_">downloadImage</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">renderText</span><span class="params">(CharSequence s)</span>;</span><br><span class="line">    <span class="keyword">abstract</span> List&lt;ImageInfo&gt; <span class="title function_">scanForImageInfo</span><span class="params">(CharSequence s)</span>;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">renderImage</span><span class="params">(ImageData i)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-4-可携带结果的任务：Callable-和-Future"><a href="#3-4-可携带结果的任务：Callable-和-Future" class="headerlink" title="3.4 可携带结果的任务：Callable 和 Future"></a>3.4 可携带结果的任务：<code>Callable</code> 和 <code>Future</code></h2><p>我们知道 Callable 接口有返回值，Runnable 接口没有返回值。</p>
<ul>
<li><p>我们可以将 <code>Runnable</code> 或 <code>Callable</code> 提交给 <code>Executor</code>，然后得到一个 <code>Future</code>，用得到的 <code>Future&lt;T&gt;</code> 来获得任务执行的结果，或者取消任务。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ExecutorService</span> <span class="keyword">extends</span> <span class="title class_">Executor</span> &#123;  &#125;</span><br></pre></td></tr></table></figure>

<p>  <img src="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20220829215558.png" alt="1"></p>
</li>
<li><p>也可以将 <code>Runnable</code> 实例化一个 <code>FutureTask</code>【如下，FutureTask 实现了 Runnable】</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FutureTask</span>&lt;V&gt; <span class="keyword">implements</span> <span class="title class_">RunnableFuture</span>&lt;V&gt; &#123;  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RunnableFuture</span>&lt;V&gt; <span class="keyword">extends</span> <span class="title class_">Runnable</span>, Future&lt;V&gt; &#123;  &#125;</span><br></pre></td></tr></table></figure>

<p>  <code>FutureTask</code> 既可以提交给 <code>Executor</code> 来执行，又可以直接调用 <code>run()</code> 方法运行。</p>
</li>
<li><p>Runnable 或其分支，将其提交给 <code>Executor</code> 执行，<code>Future.get()</code> 的值可以指定，无指定默认为 <code>null</code></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Runnable task, T result)</span>;</span><br><span class="line"></span><br><span class="line">Future&lt;?&gt; submit(Runnable task);</span><br></pre></td></tr></table></figure>

</li>
<li><p>将 Callable 提交给 <code>Executor</code> 执行，<code>Future.get()</code> 的值为 Callable 执行的返回值</p>
</li>
</ul>
<h2 id="3-5-示例：使用-Future-等待图像下载"><a href="#3-5-示例：使用-Future-等待图像下载" class="headerlink" title="3.5 示例：使用 Future 等待图像下载"></a>3.5 示例：使用 Future 等待图像下载</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Future;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">FutureRenderer</span> &#123;</span><br><span class="line">    <span class="comment">/** 创建线程池 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 页面资源渲染 */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">renderPage</span><span class="params">(CharSequence source)</span> &#123;</span><br><span class="line">        <span class="comment">// 图片信息集合</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;ImageInfo&gt; imageInfos = scanForImageInfo(source);</span><br><span class="line">        <span class="comment">// 创建一个 task，该 task 返回【图片数据】集合</span></span><br><span class="line">        Callable&lt;List&lt;ImageData&gt;&gt; task =</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Callable</span>&lt;List&lt;ImageData&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> List&lt;ImageData&gt; <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">                        List&lt;ImageData&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                        <span class="comment">// 从【图片信息集】中，下载所有的【图片数据】</span></span><br><span class="line">                        <span class="keyword">for</span> (ImageInfo imageInfo : imageInfos) &#123;</span><br><span class="line">                            result.add(imageInfo.downloadImage());</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> result;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">        <span class="comment">// 将 Callable 提交给 Executor</span></span><br><span class="line">        Future&lt;List&lt;ImageData&gt;&gt; future = executor.submit(task);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 文本渲染</span></span><br><span class="line">        renderText(source);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 如果 Executor 已经将 task 执行完成，返回【图片数据】</span></span><br><span class="line">            <span class="comment">// 那么将【图片数据】进行渲染</span></span><br><span class="line">            List&lt;ImageData&gt; imageData = future.get();</span><br><span class="line">            <span class="keyword">for</span> (ImageData data : imageData) &#123;</span><br><span class="line">                renderImage(data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">// 中断线程</span></span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            <span class="comment">// 取消任务</span></span><br><span class="line">            future.cancel(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> LaunderThrowable.launderThrowable(e.getCause());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 图片数据 */</span></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">ImageData</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 图片信息 */</span></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">ImageInfo</span> &#123;</span><br><span class="line">        <span class="comment">/** 下载图片数据 */</span></span><br><span class="line">        ImageData <span class="title function_">downloadImage</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 文本渲染 */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">renderText</span><span class="params">(CharSequence s)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 扫描图片 */</span></span><br><span class="line">    <span class="keyword">abstract</span> List&lt;ImageInfo&gt; <span class="title function_">scanForImageInfo</span><span class="params">(CharSequence s)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 图片渲染 */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">renderImage</span><span class="params">(ImageData i)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Throwable 强制转换为 RuntimeException */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LaunderThrowable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将未经检查的 Throwable 抛出。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 如果 throwable 是 RuntimeException 则返回 Throwable。</span></span><br><span class="line"><span class="comment">     * 如果 throwable 是 Error 则抛出 Error。</span></span><br><span class="line"><span class="comment">     * 否者抛出 IllegalStateException。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RuntimeException <span class="title function_">launderThrowable</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">            <span class="keyword">return</span> (RuntimeException) throwable;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (Error) throwable;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Not unchecked&quot;</span>, throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-6-Executor-和-BlockingQueue-功能的整合-—-CompletionService"><a href="#3-6-Executor-和-BlockingQueue-功能的整合-—-CompletionService" class="headerlink" title="3.6 Executor 和 BlockingQueue 功能的整合 —- CompletionService"></a>3.6 <code>Executor</code> 和 <code>BlockingQueue</code> 功能的整合 —- CompletionService</h2><p><code>CompletionService</code> 整合了 <code>Executor</code> 和 <code>BlockingQueue</code> 的功能。下面将从 <code>CompletionService</code> 实现上分析其功能。</p>
<p>CompletionService 将新异步<code>任务的生产</code>与已完成<code>任务的结果消耗</code>相分离</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CompletionService</span>&lt;V&gt; &#123;</span><br><span class="line">    Future&lt;V&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;V&gt; task)</span>;</span><br><span class="line">    </span><br><span class="line">    Future&lt;V&gt; <span class="title function_">submit</span><span class="params">(Runnable task, V result)</span>;</span><br><span class="line">    </span><br><span class="line">    Future&lt;V&gt; <span class="title function_">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    </span><br><span class="line">    Future&lt;V&gt; <span class="title function_">poll</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    Future&lt;V&gt; <span class="title function_">poll</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>回顾一下 <code>BlockingQueue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 阻寨队列(Blocking queue)提供了可阻塞的 put 和 take 方法</span><br><span class="line">2. 如果 Queue 己经满了，put 方法会被阻塞，直到有空间可用</span><br><span class="line">3. 如果 Queue是空的，那么 take 方法会被阻塞，直到有元素可用</span><br><span class="line">4. Queue 的长度可以有限，也可以无限，无限的 Queue 永远不会充满，所以它的 put 方法永远不会阻塞</span><br></pre></td></tr></table></figure>



<p><code>ExecutorCompletionservice</code> 是实现 <code>CompletionService</code> 接口的一个类，并将 <strong>计算任务</strong> 委托给一个 <code>Executor</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExecutorCompletionService</span>&lt;V&gt; <span class="keyword">implements</span> <span class="title class_">CompletionService</span>&lt;V&gt; &#123;</span><br><span class="line">    <span class="comment">// 线程池</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Executor executor;</span><br><span class="line">    <span class="comment">// 阻塞队列</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Future&lt;V&gt;&gt; completionQueue;</span><br><span class="line">    <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ExecutorCompletionservice 的构造函数中创建了一个 <code>BlockingQueue</code>，用来<code>保存完成的结果</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ExecutorCompletionService</span><span class="params">(Executor executor)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">this</span>.completionQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Future&lt;V&gt;&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ExecutorCompletionService</span><span class="params">(Executor executor, BlockingQueue&lt;Future&lt;V&gt;&gt; completionQueue)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">this</span>.completionQueue = completionQueue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在 <code>ExecutorCompletionservice</code> 中有一个内部类：QueueingFuture</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">QueueingFuture</span> <span class="keyword">extends</span> <span class="title class_">FutureTask</span>&lt;Void&gt; &#123;</span><br><span class="line">    QueueingFuture(RunnableFuture&lt;V&gt; task) &#123;</span><br><span class="line">        <span class="built_in">super</span>(task, <span class="literal">null</span>);</span><br><span class="line">        <span class="built_in">this</span>.task = task;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 重写了 FutureTask 的 done() 方法</span></span><br><span class="line">    <span class="comment">// completionQueue 为 ExecutorCompletionservice 的成员变量</span></span><br><span class="line">    <span class="comment">// task 执行完成时会调用 FutureTask 中 done 方法</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">done</span><span class="params">()</span> &#123; completionQueue.add(task); &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Future&lt;V&gt; task;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>当向 <code>ExecutorCompletionservice</code> 提交了一个任务后，首先把这个任务包装为一个 QueueingFuture</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 其中一个 submit() 方法 */</span></span><br><span class="line"><span class="keyword">public</span> Future&lt;V&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;V&gt; task)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    RunnableFuture&lt;V&gt; f = newTaskFor(task);</span><br><span class="line">    <span class="comment">// 执行 QueueingFuture</span></span><br><span class="line">    executor.execute(<span class="keyword">new</span> <span class="title class_">QueueingFuture</span>(f));</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>new QueueingFuture(f)</code>  —- 将 <code>task</code> 包装为一个 QueueingFuture。</p>
<p><strong>提交一个 task</strong>：</p>
<ul>
<li><p>如上，我们提交一个 <code>task</code>，该 <code>task</code> 会被包装为一个 <code>QueueingFuture</code></p>
</li>
<li><p>QueueingFuture 是 <code>FutureTask</code> 的子类，且 QueueingFuture 重写了父类的 done() 方法。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// completionQueue 为 ExecutorCompletionservice 的成员变量</span></span><br><span class="line"><span class="comment">// private final BlockingQueue&lt;Future&lt;V&gt;&gt; completionQueue;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">done</span><span class="params">()</span> &#123;</span><br><span class="line">    completionQueue.add(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>task 执行完成时，都会调用 FutureTask 中 done 方法</p>
</li>
<li><p>调用 done 方法，会将执行完 task 后的结果加入到阻塞队列中。</p>
</li>
</ul>
<p><code>ExecutorCompletionservice</code> 中的 <code>take()</code> 、<code>poll()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 删除并获取 */</span></span><br><span class="line"><span class="keyword">public</span> Future&lt;V&gt; <span class="title function_">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">return</span> completionQueue.take();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/** 删除并获取 */</span></span><br><span class="line"><span class="keyword">public</span> Future&lt;V&gt; <span class="title function_">poll</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> completionQueue.poll();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/** 删除并获取 */</span></span><br><span class="line"><span class="keyword">public</span> Future&lt;V&gt; <span class="title function_">poll</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">return</span> completionQueue.poll(timeout, unit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如上 <code>take()</code>和<code>poll()</code>方法，实际上是将获取结果委托给了<code>阻塞队列</code>。</li>
<li>在阻塞队列中，如果队列满了，put 方法会被阻塞，直到有空间可用。</li>
<li>如果队列是空的，那么 take 方法会被阻塞，直到有元素可用。</li>
</ul>
<h2 id="3-7-示例：使用-CompletionService-的页面渲染器"><a href="#3-7-示例：使用-CompletionService-的页面渲染器" class="headerlink" title="3.7 示例：使用 CompletionService 的页面渲染器"></a>3.7 示例：使用 CompletionService 的页面渲染器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CompletionService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorCompletionService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Future;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Renderer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService executor;</span><br><span class="line"></span><br><span class="line">    Renderer(ExecutorService executor) &#123;</span><br><span class="line">        <span class="comment">// 创建线程池</span></span><br><span class="line">        <span class="built_in">this</span>.executor = executor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">renderPage</span><span class="params">(CharSequence source)</span> &#123;</span><br><span class="line">        <span class="comment">// 图片信息集合</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;ImageInfo&gt; info = scanForImageInfo(source);</span><br><span class="line">        <span class="comment">// CompletionService 整合了 Executor 和 BlockingQueue 的功能，</span></span><br><span class="line">        <span class="comment">// 创建一个 CompletionService 对象，将新异步任务的生产与已完成任务的结果消耗相分离</span></span><br><span class="line">        CompletionService&lt;ImageData&gt; completionService = <span class="keyword">new</span> <span class="title class_">ExecutorCompletionService</span>&lt;&gt;(executor);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> ImageInfo imageInfo : info) &#123;</span><br><span class="line">            <span class="comment">// 提交任务</span></span><br><span class="line">            completionService.submit(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;ImageData&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> ImageData <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="comment">// 下载图片</span></span><br><span class="line">                    <span class="keyword">return</span> imageInfo.downloadImage();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 文本渲染</span></span><br><span class="line">        renderText(source);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 图片渲染</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">t</span> <span class="operator">=</span> <span class="number">0</span>, n = info.size(); t &lt; n; t++) &#123;</span><br><span class="line">                <span class="comment">// 在 CompletionService 中，task 会被其交给 Executor 进行执行</span></span><br><span class="line">                <span class="comment">// 执行后的的 Future 会放在 BlockingQueue 中，通过 take()、poll() 方法获取</span></span><br><span class="line">                <span class="comment">// 如果 Executor 已经将 task 执行完成，返回【图片数据】</span></span><br><span class="line">                <span class="comment">// 那么将【图片数据】进行渲染</span></span><br><span class="line">                Future&lt;ImageData&gt; f = completionService.take();</span><br><span class="line">                <span class="type">ImageData</span> <span class="variable">imageData</span> <span class="operator">=</span> f.get();</span><br><span class="line">                renderImage(imageData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">// 中断线程</span></span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> LaunderThrowable.launderThrowable(e.getCause());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 图片数据 */</span></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">ImageData</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 图片信息 */</span></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">ImageInfo</span> &#123;</span><br><span class="line">        <span class="comment">/** 下载图片数据 */</span></span><br><span class="line">        ImageData <span class="title function_">downloadImage</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 文本渲染 */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">renderText</span><span class="params">(CharSequence s)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 扫描图片 */</span></span><br><span class="line">    <span class="keyword">abstract</span> List&lt;ImageInfo&gt; <span class="title function_">scanForImageInfo</span><span class="params">(CharSequence s)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 图片渲染 */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">renderImage</span><span class="params">(ImageData i)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LaunderThrowable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将未经检查的 Throwable 抛出。</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 如果 throwable 是 RuntimeException 则返回 Throwable。</span></span><br><span class="line"><span class="comment">         * 如果 throwable 是 Error 则抛出 Error。</span></span><br><span class="line"><span class="comment">         * 否者抛出 IllegalStateException。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> RuntimeException <span class="title function_">launderThrowable</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                <span class="keyword">return</span> (RuntimeException) throwable;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (Error) throwable;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Not unchecked&quot;</span>, throwable);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-8-为任务设置时限"><a href="#3-8-为任务设置时限" class="headerlink" title="3.8 为任务设置时限"></a>3.8 为任务设置时限</h2><ul>
<li><p>有时候如果一个活动无法在某个确定时间内完成，那么它的结果就失效了，此时程序可以放弃该活动。</p>
</li>
<li><p><code>Future&lt;V&gt;</code> 有一个 <code>get()</code> 方法，可以在时限内获取结果，否者就抛出 <code>TimeoutException</code> 异常</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 等待计算完成，然后检索其结果。如果超时，则抛出异常</span></span><br><span class="line"><span class="comment"> * timeout - 等待的最长时间</span></span><br><span class="line"><span class="comment"> * unit - 超时参数的时间单位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">V <span class="title function_">get</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="3-9-示例：旅游预订门户网站"><a href="#3-9-示例：旅游预订门户网站" class="headerlink" title="3.9 示例：旅游预订门户网站"></a>3.9 示例：旅游预订门户网站</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Future;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.concurrent.TimeUnit.NANOSECONDS;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RenderWithTimeBudget</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Ad</span> <span class="variable">DEFAULT_AD</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Ad</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">TIME_BUDGET</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">exec</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">    Page <span class="title function_">renderPageWithAd</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">endNanos</span> <span class="operator">=</span> System.nanoTime() + TIME_BUDGET;</span><br><span class="line">        <span class="comment">// 提交任务</span></span><br><span class="line">        Future&lt;Ad&gt; adFuture = exec.submit(<span class="keyword">new</span> <span class="title class_">FetchAdTask</span>());</span><br><span class="line">        <span class="comment">// 在等待广告时，进行渲染页面</span></span><br><span class="line">        <span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> renderPageBody();</span><br><span class="line">        Ad ad;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">timeLeft</span> <span class="operator">=</span> endNanos - System.nanoTime();</span><br><span class="line">            <span class="comment">// 在规定时间内，获取广告。否则默认没有广告</span></span><br><span class="line">            ad = adFuture.get(timeLeft, NANOSECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            ad = DEFAULT_AD;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">            <span class="comment">// 没有在规定时间内获取到广告，取消任务</span></span><br><span class="line">            ad = DEFAULT_AD;</span><br><span class="line">            adFuture.cancel(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 广告渲染</span></span><br><span class="line">        page.setAd(ad);</span><br><span class="line">        <span class="keyword">return</span> page;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Page <span class="title function_">renderPageBody</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Page</span>(); &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 广告 */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Ad</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 页面 */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Page</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAd</span><span class="params">(Ad ad)</span> &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 添加广告的 task */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FetchAdTask</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;Ad&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Ad <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Ad</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-10-示例：在预订时间内请求旅游报价"><a href="#3-10-示例：在预订时间内请求旅游报价" class="headerlink" title="3.10 示例：在预订时间内请求旅游报价"></a>3.10 示例：在预订时间内请求旅游报价</h2><p> <code>ExecutorService.invokeAll()</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行给定的任务，返回在所有完成结果。</span></span><br><span class="line"><span class="comment"> * 通过 Future.isDone() 判断 task 是否已经完成。</span></span><br><span class="line"><span class="comment"> * 在规定时间内，如果在任务列表中，还有任务未被执行，那么通过 Future.cancel() 取消任务。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tasks - 收集任务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeout - 等待的最长时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> unit - 超时参数的时间单位</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 完成结果。如果操作没有超时，每个任务都会完成。 如果超时，其中一些任务将不会完成。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">&lt;T&gt; List&lt;Future&lt;T&gt;&gt; <span class="title function_">invokeAll</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></span><br><span class="line"><span class="params">                              <span class="type">long</span> timeout, </span></span><br><span class="line"><span class="params">                              TimeUnit unit)</span> </span><br><span class="line">    <span class="keyword">throws</span> InterruptedException;</span><br></pre></td></tr></table></figure>



<p><code>Future</code> 的 isDone() 方法和：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 如果任务已完成（正常终止、异常或取消），返回true */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isDone</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 尝试取消执行此任务。</span></span><br><span class="line"><span class="comment"> * 如果任务已完成、被取消、或由于某种无法取消，则此尝试将失败。 </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 如果成功，并且当 cancel 时，此任务尚未启动，则此任务不应运行。 </span></span><br><span class="line"><span class="comment"> * 如果任务已经开始，则 mayInterruptIfRunning 参数确定是否中断执行该 task 的线程，以尝试停止该 task</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mayInterruptIfRunning true如果执行该任务的线程应该被中断; 否则，正在进行的任务被允许完成</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 如果任务无法取消，返回 false，否则返回 true。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(<span class="type">boolean</span> mayInterruptIfRunning)</span>;</span><br></pre></td></tr></table></figure>



<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CancellationException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Future;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeBudget</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ExecutorService</span> <span class="variable">exec</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得旅游行情排名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> travelInfo 旅游资讯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> companies 公司 ---- set集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ranking 排行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit 时间单位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;TravelQuote&gt; <span class="title function_">getRankedTravelQuotes</span><span class="params">(TravelInfo travelInfo,</span></span><br><span class="line"><span class="params">                                                   Set&lt;TravelCompany&gt; companies,</span></span><br><span class="line"><span class="params">                                                   Comparator&lt;TravelQuote&gt; ranking,</span></span><br><span class="line"><span class="params">                                                   <span class="type">long</span> time,</span></span><br><span class="line"><span class="params">                                                   TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 将【每个公司 + 旅游资讯】封装成 task</span></span><br><span class="line">        List&lt;QuoteTask&gt; tasks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (TravelCompany company : companies) &#123;</span><br><span class="line">            tasks.add(<span class="keyword">new</span> <span class="title class_">QuoteTask</span>(company, travelInfo));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将所有 task 提交给 ExecutorService</span></span><br><span class="line">        <span class="comment">// 所有任务在规定时间内执行完任务</span></span><br><span class="line">        List&lt;Future&lt;TravelQuote&gt;&gt; quoteFutures = exec.invokeAll(tasks, time, unit);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 报价获取</span></span><br><span class="line">        List&lt;TravelQuote&gt; quotes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(tasks.size());</span><br><span class="line">        Iterator&lt;QuoteTask&gt; taskIter = tasks.iterator();</span><br><span class="line">        <span class="keyword">for</span> (Future&lt;TravelQuote&gt; quoteFuture : quoteFutures) &#123;</span><br><span class="line">            <span class="type">QuoteTask</span> <span class="variable">task</span> <span class="operator">=</span> taskIter.next();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 获取报价成功</span></span><br><span class="line">                quotes.add(quoteFuture.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">                <span class="comment">// 获取报价失败</span></span><br><span class="line">                quotes.add(task.getFailureQuote(e.getCause()));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (CancellationException e) &#123;</span><br><span class="line">                <span class="comment">// 获取报价超时</span></span><br><span class="line">                quotes.add(task.getTimeoutQuote(e));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Collections.sort(quotes, ranking);</span><br><span class="line">        <span class="keyword">return</span> quotes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QuoteTask</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;TravelQuote&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TravelCompany company;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TravelInfo travelInfo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">QuoteTask</span><span class="params">(TravelCompany company, TravelInfo travelInfo)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.company = company;</span><br><span class="line">        <span class="built_in">this</span>.travelInfo = travelInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 获取报价失败 */</span></span><br><span class="line">    TravelQuote <span class="title function_">getFailureQuote</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 获取报价超时 */</span></span><br><span class="line">    TravelQuote <span class="title function_">getTimeoutQuote</span><span class="params">(CancellationException e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TravelQuote <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 获取旅游报价</span></span><br><span class="line">        <span class="keyword">return</span> company.solicitQuote(travelInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 旅游公司 */</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">TravelCompany</span> &#123;</span><br><span class="line">    <span class="comment">/** 获取旅游报价 */</span></span><br><span class="line">    TravelQuote <span class="title function_">solicitQuote</span><span class="params">(TravelInfo travelInfo)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 旅游报价 */</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">TravelQuote</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 旅游资讯 */</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">TravelInfo</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div class="article-licensing box"><div class="licensing-title"><p>Java并发编程实战：第6章 任务执行</p><p><a href="https://osys.github.io/posts/e39c.html">https://osys.github.io/posts/e39c.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Osys</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022年08月29日</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022年08月29日</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/posts/d7d5.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Java并发编程实战：第6章 总结</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/posts/d008.html"><span class="level-item">Java并发编程实战：第1-5章 总结</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "1b4887ac6ef5780703362dfb6728312f",
            repo: "osys.github.io",
            owner: "osys",
            clientID: "e0f10cf0c934d445e79f",
            clientSecret: "3dad6d25224fe45db31a3a912756bd5175e3a70f",
            admin: ["osys"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#1-在线程中执行任务"><span class="level-left"><span class="level-item">1. 在线程中执行任务</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-在线程中执行任务"><span class="level-left"><span class="level-item">1.1 在线程中执行任务</span></span></a></li><li><a class="level is-mobile" href="#1-2-顺序地执行任务"><span class="level-left"><span class="level-item">1.2 顺序地执行任务</span></span></a></li><li><a class="level is-mobile" href="#1-3-显式的为任务创建线程"><span class="level-left"><span class="level-item">1.3 显式的为任务创建线程</span></span></a></li><li><a class="level is-mobile" href="#1-4-无限制创建线程的缺点"><span class="level-left"><span class="level-item">1.4 无限制创建线程的缺点</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-Executor-框架"><span class="level-left"><span class="level-item">2. Executor 框架</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-Executor-框架"><span class="level-left"><span class="level-item">2.1 Executor 框架</span></span></a></li><li><a class="level is-mobile" href="#2-2-使用-Executor-实现-Web-Server"><span class="level-left"><span class="level-item">2.2 使用 Executor 实现 Web Server</span></span></a></li><li><a class="level is-mobile" href="#2-3-执行策略"><span class="level-left"><span class="level-item">2.3 执行策略</span></span></a></li><li><a class="level is-mobile" href="#2-4-线程池"><span class="level-left"><span class="level-item">2.4 线程池</span></span></a></li><li><a class="level is-mobile" href="#2-5-Executor-的生命周期"><span class="level-left"><span class="level-item">2.5 Executor 的生命周期</span></span></a></li><li><a class="level is-mobile" href="#2-6-延迟的、周期性的任务"><span class="level-left"><span class="level-item">2.6 延迟的、周期性的任务</span></span></a></li></ul></li><li><a class="level is-mobile" href="#3-寻找可强化的并行性"><span class="level-left"><span class="level-item">3. 寻找可强化的并行性</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-寻找可强化的并行性"><span class="level-left"><span class="level-item">3.1 寻找可强化的并行性</span></span></a></li><li><a class="level is-mobile" href="#3-2-顺序执行的页面渲染器"><span class="level-left"><span class="level-item">3.2 顺序执行的页面渲染器</span></span></a></li><li><a class="level is-mobile" href="#3-3-示例：顺序的渲染页面元素"><span class="level-left"><span class="level-item">3.3 示例：顺序的渲染页面元素</span></span></a></li><li><a class="level is-mobile" href="#3-4-可携带结果的任务：Callable-和-Future"><span class="level-left"><span class="level-item">3.4 可携带结果的任务：Callable 和 Future</span></span></a></li><li><a class="level is-mobile" href="#3-5-示例：使用-Future-等待图像下载"><span class="level-left"><span class="level-item">3.5 示例：使用 Future 等待图像下载</span></span></a></li><li><a class="level is-mobile" href="#3-6-Executor-和-BlockingQueue-功能的整合-—-CompletionService"><span class="level-left"><span class="level-item">3.6 Executor 和 BlockingQueue 功能的整合 —- CompletionService</span></span></a></li><li><a class="level is-mobile" href="#3-7-示例：使用-CompletionService-的页面渲染器"><span class="level-left"><span class="level-item">3.7 示例：使用 CompletionService 的页面渲染器</span></span></a></li><li><a class="level is-mobile" href="#3-8-为任务设置时限"><span class="level-left"><span class="level-item">3.8 为任务设置时限</span></span></a></li><li><a class="level is-mobile" href="#3-9-示例：旅游预订门户网站"><span class="level-left"><span class="level-item">3.9 示例：旅游预订门户网站</span></span></a></li><li><a class="level is-mobile" href="#3-10-示例：在预订时间内请求旅游报价"><span class="level-left"><span class="level-item">3.10 示例：在预订时间内请求旅游报价</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/basic/avatar.png" alt="Osys"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Osys</p><p class="is-size-6 is-block">去喝粥吧，无情的Bug。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>GuangZhou</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">29</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">1</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">1</p></a></div></div></nav></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">29</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><span class="tag">Java并发编程</span><span class="tag">29</span></a></div></div></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">29</span></span></a></li></ul></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png" alt="数据开发猿" height="28"></a><p class="is-size-7"><span>&copy; 2022 Osys</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Blog on GitHub" href="https://github.com/osys/osys.github.io/"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'folded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container" id="algolia-input"></div><div id="algolia-poweredby" style="display:flex;margin:0 .5em 0 1em;align-items:center;line-height:0"></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div><div class="searchbox-footer"></div></div></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.0.3/dist/algoliasearch-lite.umd.js" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.3.1/dist/instantsearch.production.min.js" crossorigin="anonymous" defer></script><script src="/js/algolia.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadAlgolia({"applicationId":"8FPI8CDLJR","apiKey":"702cfc5bf8397419842065704ec39904","indexName":"github_pages_hexo_blog"}, {"hint":"想要查找什么...","no_result":"未找到搜索结果","untitled":"(无标题)","empty_preview":"(无内容预览)"});
        });</script></body></html>