<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Java并发编程实战：第8章 应用线程池 - LeeHua&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="LeeHua&#039;s Blog"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="LeeHua&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="1. 应用线程池1.1 在任务与执行策略之间的隐性耦合Executor 框架可以将任务的提交与任务的执行策略解耦开来。Executor 框架为制定和修改执行策略提供了相当大的灵活性，但并非所有的任务都能适用所有的执行策略。 有些类型的任 务需要明确地指定执行策略， 包括：  依赖性任务：简单来说就是，提交的 task 是需要依赖 其它任务 的， task 就类似有某种枷锁一样，浑身不自在。  大多"><meta property="og:type" content="blog"><meta property="og:title" content="Java并发编程实战：第8章 应用线程池"><meta property="og:url" content="https://osys.github.io/"><meta property="og:site_name" content="Osys&#039;s Blog"><meta property="og:description" content="1. 应用线程池1.1 在任务与执行策略之间的隐性耦合Executor 框架可以将任务的提交与任务的执行策略解耦开来。Executor 框架为制定和修改执行策略提供了相当大的灵活性，但并非所有的任务都能适用所有的执行策略。 有些类型的任 务需要明确地指定执行策略， 包括：  依赖性任务：简单来说就是，提交的 task 是需要依赖 其它任务 的， task 就类似有某种枷锁一样，浑身不自在。  大多"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://osys.github.io/img/og_image.png"><meta property="article:published_time" content="2022-08-29T14:13:01.000Z"><meta property="article:modified_time" content="2022-08-29T14:40:44.000Z"><meta property="article:author" content="Osys"><meta property="article:tag" content="Java并发编程"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://osys.github.io/"},"headline":"LeeHua's Blog","image":["https://osys.github.io/img/og_image.png"],"datePublished":"2022-08-29T14:13:01.000Z","dateModified":"2022-08-29T14:40:44.000Z","author":{"@type":"Person","name":"Osys"},"publisher":{"@type":"Organization","name":"Osys","logo":{"@type":"ImageObject","url":"https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"}},"description":"一路生花"}</script><link rel="canonical" href="https://osys.github.io/posts/9a9d.html"><link rel="alternate" href="/path/to/atom.xml" title="LeeHua&#039;s Blog" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?44cd31785e14a1fdaad0921651759e0f";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><script src="/js/runtime.js"></script><meta name="generator" content="Hexo 6.0.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png" alt="LeeHua&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-08-29T14:13:01.000Z" title="8/29/2022, 2:13:01 PM">2022年08月29日</time>发表</span><span class="level-item"><time dateTime="2022-08-29T14:40:44.000Z" title="8/29/2022, 2:40:44 PM">2022年08月29日</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Java/">Java</a></span><span class="level-item">36 分钟读完 (大约5452个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Java并发编程实战：第8章 应用线程池</h1><div class="content"><h1 id="1-应用线程池"><a href="#1-应用线程池" class="headerlink" title="1. 应用线程池"></a>1. 应用线程池</h1><h2 id="1-1-在任务与执行策略之间的隐性耦合"><a href="#1-1-在任务与执行策略之间的隐性耦合" class="headerlink" title="1.1 在任务与执行策略之间的隐性耦合"></a>1.1 在任务与执行策略之间的隐性耦合</h2><p>Executor 框架可以将<code>任务的提交</code>与<code>任务的执行</code>策略解耦开来。Executor 框架为制定和修改执行策略提供了相当大的灵活性，但<strong>并非所有的任务都能适用所有的执行策略</strong>。 有些类型的任 务需要明确地指定执行策略， 包括：</p>
<ol>
<li><p>依赖性任务：简单来说就是，提交的 <code>task</code> 是需要依赖 <code>其它任务</code> 的， <code>task</code> 就类似有某种枷锁一样，浑身不自在。</p>
<ul>
<li>大多数任务都是独立的，它们不依赖于其他任务的执行时序、 执行结果或其他效果。 </li>
<li>当在线程池中执行独立的任务时， 可以随意地改变线程池的大小和配置，这些修改只会对执行性能产生影响。</li>
<li>如果提交给线程池的任务需要依赖其他的任务， 那么就隐含地给执行策略带来了约束， 此时必须小心地维持这些执行策略，以避免产生活跃性问题。</li>
</ul>
 <span id="more"></span>
</li>
<li><p>采用线程封闭机制的任务：</p>
<ul>
<li>在单线程中的 Executor：能够对并发性做出更强的承诺。 它们能确保任务不会并发地执行， 使我们能够放宽代码对线程安全的要求。<code>对象</code>可以封闭在 <code>task 所在的线程</code>中， 使得在<code>该线程</code>中执行的 task 在访问该对象时不需要同步， 即使这些资源不是线程安全的也没有问题。 </li>
<li>Executor 从单线程环境改为线程池环境，任务可能会被并发地执行，失去了线程安全性。</li>
</ul>
</li>
<li><p>对响应时间敏感的任务：</p>
<ul>
<li><p>GUI应用程序对于响应时间是敏感的：如果用户在点击按钮后需要很长延迟才能得到可见的反馈， 那么他们会感到不满。</p>
</li>
<li><p>如果将一个运行时间较长的任务提交到单线程的Executor中， 或者将多个运行时间较长的任务提交到一个只包含少量线程的线程池 中， 那么将降低由该Executor管理的服务的响应性。</p>
<p>  ​</p>
</li>
</ul>
</li>
<li><p>使用ThreadLocal的任务：</p>
<ul>
<li>ThreadLocal使每个线程都可以拥有某个变量的一个私有<code>版本</code>。然而，只要条件允许，Executor可以自由地重用这些线程。</li>
<li>在标准的Executor实现中，当执行需求较低时将回收空闲线程，而当需求增加时将添加新的线程，并且如果从任务中抛出了一个未检查异常，那么将用一个新的工作者线程来替代抛出异常的线程。</li>
<li>只有当线程本地值的生命周期受限于任务的生命周期时，在线程池的线程中使用ThreadLocal才有意义。</li>
<li>在线程池的线程中不应该使用 ThreadLocal在任务之间传递值。</li>
</ul>
</li>
</ol>
<p>只有当任务都是同类型的并且相互独立时，线程池的性能才能达到最佳。如果将运行时间较长的与运行时间较短的任务混合在一起，那么除非线程池很大，否则将可能造成<code>拥塞</code>。如果提交的任务依赖于其他任务，那么除非线程池无限大，否则将可能造成<code>死锁</code>。</p>
<h3 id="1-1-1-线程饥饿死锁"><a href="#1-1-1-线程饥饿死锁" class="headerlink" title="1.1.1 线程饥饿死锁"></a>1.1.1 线程饥饿死锁</h3><ul>
<li><p>在多线程中，如果某个线程任务，依赖于其它任务的执行，那么就有可能会产生线程死锁。</p>
</li>
<li><p>在单线程的 Executor 中，如果一个任务将另一个任务提交到同一个 Executor，并且等待这个被提交任务的结果，那么通常会引发死锁。</p>
<p>  第二个任务停留在工作队列中，并等待第一个任务完成，而第一个任务又无法完成，因为它在等待第二个任务的完成。</p>
</li>
</ul>
<blockquote>
<p>在单线程化的 Executor 中死锁的任务</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Future;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadDeadlock</span> &#123;</span><br><span class="line">    <span class="comment">// single executor</span></span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">exec</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoadFileTask</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;String&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String fileName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">LoadFileTask</span><span class="params">(String fileName)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.fileName = fileName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">// 读取文件</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RenderPageTask</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;String&gt; &#123;</span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            Future&lt;String&gt; header, footer;</span><br><span class="line">            header = exec.submit(<span class="keyword">new</span> <span class="title class_">LoadFileTask</span>(<span class="string">&quot;header.html&quot;</span>));</span><br><span class="line">            footer = exec.submit(<span class="keyword">new</span> <span class="title class_">LoadFileTask</span>(<span class="string">&quot;footer.html&quot;</span>));</span><br><span class="line">            <span class="type">String</span> <span class="variable">page</span> <span class="operator">=</span> renderBody();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> header.get() + page + footer.get();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String <span class="title function_">renderBody</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// 页面渲染</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RenderPageTask</span> <span class="variable">mainTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RenderPageTask</span>();</span><br><span class="line">        exec.submit(mainTask);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例子 <code>ThreadDeadlock.RenderPageTask</code> 将两个 LoadFileTask 添加到单例的 ExecutorService 中。在 <code>tast()</code> 中，我们将 <code>RenderPageTask</code> 添加到单例的 ExecutorService 中，那么会出现 mainTask 等待其他两个 LoadFileTask 的结果，久久不能结束，而那两个 LoadFileTask 却需要等待 mainTask 结束才能被单例的 ExecutorService 执行（久久不能开始）。</p>
<h3 id="1-1-2-耗时操作"><a href="#1-1-2-耗时操作" class="headerlink" title="1.1.2 耗时操作"></a>1.1.2 耗时操作</h3><ul>
<li><p>执行时间较长的任务不仅会造成线程池堵塞，甚至还会增加执行时间较短任务的服务时间。</p>
</li>
<li><p>如果线程池中线程的数量远小于在稳定状态下执行时间较长任务的数量， 那么到最后可能所有的线程都会运行这些执行时间较长的任务， 从而影响整体的响应性。</p>
</li>
<li><p>限定任务等待资源的时间， 而不要无限制地等待。</p>
<p>  例如 Thread.join、BlockingQueue.put、CountDownLatch.await 以及 Selector.select 等。</p>
</li>
</ul>
<h2 id="1-2-定制线程池的大小"><a href="#1-2-定制线程池的大小" class="headerlink" title="1.2 定制线程池的大小"></a>1.2 定制线程池的大小</h2><p>在代码中通常不会固定线程池的大小。线程池的长度应该通过某种配置机制来提供，或者根据 <code>Runtime.availableProcessors()</code> 来动态计算。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Runtime</span> &#123;</span><br><span class="line">    <span class="comment">// 返回 Java 虚拟机可用的处理器数量。 int &gt; 0</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">availableProcessors</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>要设置线程池的大小，需要避免【过大】和【过小】这两种极端情况。</li>
<li>如果线程池过大，那么大量的线程将在相对很少的CPU和内存资源上发生竞争，这不仅会导致更高的内存使用量，而且还可能耗尽资源。</li>
<li>如果线程池过小，那么将导致许多空闲的处理器无法执行工作，从而降低吞吐率。</li>
<li>如果需要执行不同类别的任务，井且它们之间的行为相差很大，那么应该考虑使用多个线程池，从而使每个线程池可以根据各自的工作负载来调整。</li>
</ul>
<blockquote>
<p>大小设定公式</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">最佳线程数目 = （（线程等待时间+线程CPU时间）/线程CPU时间 ）* CPU数目</span><br></pre></td></tr></table></figure>



<h2 id="1-3-配置-ThreadPoolExecutor"><a href="#1-3-配置-ThreadPoolExecutor" class="headerlink" title="1.3 配置 ThreadPoolExecutor"></a>1.3 配置 ThreadPoolExecutor</h2><p>ThreadPoolExecutor 为一些 Executor 提供了基本的实现，这些 Executor 是由 <code>Executors</code> 中 的 newCachedThreadPool、newFixedThreadPool 和 newScheduledThreadExecutor 等工厂方法返回的。</p>
<h3 id="1-3-1-线程的创建与销毁"><a href="#1-3-1-线程的创建与销毁" class="headerlink" title="1.3.1 线程的创建与销毁"></a>1.3.1 线程的创建与销毁</h3><ul>
<li><p>核心池大小(core pool size)、最大池的大小(maximum pool size)和存活时间(keep-alive time)共同管理着线程的创建与销段。</p>
</li>
<li><p>核心池大小是目标的大小；线程池的实现试图维护池的大小：即使没有任务执行，池的大小也等于核心池的大小，并且直到工作队列充满前，池都不会创建更多的线程。</p>
</li>
<li><p>最大池的大小是可同时活动的线程数的上限。如果一个线程已经闲置的时间超过了存活时间，它将成为一个被回收的候选者，如果当前的池的大小超过了核心池的大小，线程池会终止它。</p>
</li>
<li><p><code>Executors.newFixedThreadPool()</code></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Executors</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads,			<span class="comment">// 核心池大小</span></span><br><span class="line">                                      nThreads,			<span class="comment">// 最大池的大小</span></span><br><span class="line">                                      <span class="number">0L</span>,				<span class="comment">// 存活时间</span></span><br><span class="line">                                      TimeUnit.MILLISECONDS,<span class="comment">// 时间单位</span></span><br><span class="line">                                      <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());<span class="comment">// 执行任务之前保存任务的队列</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads, ThreadFactory threadFactory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads,			<span class="comment">// 核心池大小</span></span><br><span class="line">                                      nThreads,			<span class="comment">// 最大池的大小</span></span><br><span class="line">                                      <span class="number">0L</span>,				<span class="comment">// 存活时间</span></span><br><span class="line">                                      TimeUnit.MILLISECONDS,<span class="comment">// 时间单位</span></span><br><span class="line">                                      <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(),<span class="comment">// 执行任务之前保存任务的队列</span></span><br><span class="line">                                      threadFactory);<span class="comment">// Executor创建新线程时使用的工厂</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p><code>ThreadPoolExecutor</code> 其中一个构造方法：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用给定的初始参数创建一个新的ThreadPoolExecutor 。</span></span><br><span class="line"><span class="comment"> * 参数：</span></span><br><span class="line"><span class="comment"> * corePoolSize - 保留在池中的线程数，即使它们是空闲的，除非设置allowCoreThreadTimeOut</span></span><br><span class="line"><span class="comment"> * maximumPoolSize – 池中允许的最大线程数</span></span><br><span class="line"><span class="comment"> * keepAliveTime – 当线程数大于核心时，这是多余的空闲线程在终止前等待新任务的最长时间。</span></span><br><span class="line"><span class="comment"> * unit – keepAliveTime参数的时间单位</span></span><br><span class="line"><span class="comment"> * workQueue – 用于在执行任务之前保存任务的队列。此队列将仅保存由execute方法提交的Runnable任务。</span></span><br><span class="line"><span class="comment"> * threadFactory – 执行器创建新线程时使用的工厂</span></span><br><span class="line"><span class="comment"> * handler – 由于达到线程边界和队列容量而阻塞执行时使用的处理程序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize,</span></span><br><span class="line"><span class="params">                      <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                      <span class="type">long</span> keepAliveTime,</span></span><br><span class="line"><span class="params">                      TimeUnit unit,</span></span><br><span class="line"><span class="params">                      BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                      ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                      RejectedExecutionHandler handler)</span> &#123;</span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-3-2-管理队列任务"><a href="#1-3-2-管理队列任务" class="headerlink" title="1.3.2 管理队列任务"></a>1.3.2 管理队列任务</h3><ul>
<li><p>有限线程池限制了可以并发执行的任务的数量。</p>
</li>
<li><p>如果新增任务的频率超过了线程池能过处理它们的速度，任务将在队列中等候。</p>
</li>
<li><p>即使通车平均任务新增都很稳定，也难免会出现突然的激增。尽管队列有助于缓和瞬时的任务激增，但是如果任务持续快速地到来，队列中很多任务等待被执行，这可能会耗尽内存。</p>
</li>
<li><p>ThreadPoolExecutor 允许提供一个 BlockingQueue 来保存等待执行的任务。 基本的任务排队方法有 3 种： <code>无界队列</code>、<code>有界队列</code>和<code>同步移交</code> (Synchronous Handoff)。</p>
</li>
<li><p>对于庞大或者无限的池，可以使用 <code>SynchronousQueue</code>，完全绕开队列，将任务直接从生产者<code>移交</code>给工作者线程。</p>
<ul>
<li>SynchronousQueue 并不是一个真正的队列，而是一种管理直接在线程间移交信息的机制。</li>
<li>把一个元素放入到 SynchronousQueue 中，必须有另一个线程正在等待接受移交的任务。</li>
<li>如果没有这样一个线程，只要当前池的大小还小于最大值，ThreadPoolBxecutor 就会创建一个新的线程；否则根据饱和策略，任务会被拒绝。</li>
<li>只有当池是无限的，或者可以接受任务被拒绝，SynchronousQueue 才是一个有实际价值的选揮。</li>
</ul>
</li>
<li><p>对于先进先出的队列（如：LinkedBlockingQueue、ArrayBlockingQueue），都是顺序执行任务的。如果想要控制任务的执行顺序，可以使用优先队列（PriorityBlockingQueue），通过 Comparator 定义任务优先级。</p>
</li>
</ul>
<h3 id="1-3-3-饱和策略"><a href="#1-3-3-饱和策略" class="headerlink" title="1.3.3 饱和策略"></a>1.3.3 饱和策略</h3><p>当一个有限队列充满后，<strong>饱和策略</strong>开始起作用。ThreadPoolExecutor 的饱和策略可以通过 <code>setRejectedExecutionHandler()</code> 来修改。JDK提供的实现有：AbortPolicy、CallerRunsPolicy、DiscardPolicy 和 DiscardOldestPolicy。</p>
<ul>
<li><p>中止(Abort)策略：</p>
<p>  默认的饱和策略，该策略将抛出未检查的 RejectedExecutionException。</p>
</li>
<li><p>抛弃最旧的(Discard-Oldest)策略</p>
<p>  该策略则会抛弃下一个将被执行的任务，然后尝试重新提交新的任务。</p>
</li>
<li><p>调用者运行(Caller-Runs)策略：</p>
<p>  该策略实现了一种调节机制，该策略既不会抛弃任务，也不会抛出异常，而是将某些任务回退到调用者，从而降低新任务的流量。它不会在线程池的某个线程中执行新提交的任务，而是在一个调用了execute的线程中执行该任务。</p>
</li>
</ul>
<blockquote>
<p>创建一个可变长的线程池，使用受限队列和 “调用者运行” 饱和策略</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">CORE_POOL_SIZE</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">MAXIMUM_POOL_SIZE</span> <span class="operator">=</span> <span class="number">2000</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">KEEP_ALIVE_TIME</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">CAPACITY</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">        CORE_POOL_SIZE,                              <span class="comment">// 保留在池中的线程数</span></span><br><span class="line">        MAXIMUM_POOL_SIZE,                           <span class="comment">// 池中允许的最大线程数</span></span><br><span class="line">        KEEP_ALIVE_TIME,                             <span class="comment">// 多余的空闲线程在终止前等待新任务的最长时间</span></span><br><span class="line">        TimeUnit.MILLISECONDS,                       <span class="comment">// 时间单位</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">LinkedBlockingDeque</span>&lt;Runnable&gt;(CAPACITY), <span class="comment">// 用于在执行任务之前保存任务的队列</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()    <span class="comment">// 调用者运行(Caller-Runs)策略</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<blockquote>
<p>使用 Semaphore 来遏制任务的提交</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RejectedExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BoundedExecutor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Executor exec;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Semaphore semaphore;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BoundedExecutor</span><span class="params">(Executor exec, <span class="type">int</span> bound)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.exec = exec;</span><br><span class="line">        <span class="built_in">this</span>.semaphore = <span class="keyword">new</span> <span class="title class_">Semaphore</span>(bound);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">submitTask</span><span class="params">(<span class="keyword">final</span> Runnable command)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        semaphore.acquire();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            exec.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        command.run();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        semaphore.release();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">            semaphore.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-3-4-线程工厂"><a href="#1-3-4-线程工厂" class="headerlink" title="1.3.4 线程工厂"></a>1.3.4 线程工厂</h3><ul>
<li>每当线程池需要创建一个线程时，都是通过线程工厂方法来完成的。</li>
<li>默认的线程工厂方法将创建一个新的、非守护的线程，并且没有特殊的配置。</li>
<li>通过指定一个线程工厂方法，可以定制线程池的配置信息。</li>
<li>在 ThreadFactory 中只定义了一个方法 newThread()，每当线程池需要创建一个新线程时都会调用这个方法。</li>
</ul>
<blockquote>
<p>定制的线程工厂</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Level;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThreadFactory</span> <span class="keyword">implements</span> <span class="title class_">ThreadFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String poolName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyThreadFactory</span><span class="params">(String poolName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolName = poolName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable runnable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyAppThread</span>(runnable, poolName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>自定义的线程基类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyAppThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="comment">/** 线程默认名称 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_NAME</span> <span class="operator">=</span> <span class="string">&quot;MyAppThread&quot;</span>;</span><br><span class="line">    <span class="comment">/** 是否调用 debug 调试生命周期 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">debugLifecycle</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">/** 线程名称的一部分：这里使用递增数命名线程 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">created</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">    <span class="comment">/** 运行的线程数 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">alive</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">    <span class="comment">/** 日志 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> Logger.getAnonymousLogger();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyAppThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(r, DEFAULT_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyAppThread</span><span class="params">(Runnable runnable, String name)</span> &#123;</span><br><span class="line">        <span class="comment">// 线程初始化</span></span><br><span class="line">        <span class="built_in">super</span>(runnable, name + <span class="string">&quot;-&quot;</span> + created.incrementAndGet());</span><br><span class="line">        <span class="comment">// 未捕获的异常处理</span></span><br><span class="line">        setUncaughtExceptionHandler(<span class="keyword">new</span> <span class="title class_">UncaughtExceptionHandler</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uncaughtException</span><span class="params">(Thread t, Throwable e)</span> &#123;</span><br><span class="line">                log.log(Level.SEVERE, <span class="string">&quot;未捕获的异常线程：&quot;</span> + t.getName(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 复制 debug 调试断言，以确保始终一致的值。</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">debug</span> <span class="operator">=</span> debugLifecycle;</span><br><span class="line">        <span class="keyword">if</span> (debug) log.log(Level.FINE, <span class="string">&quot;Created &quot;</span> + getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            alive.incrementAndGet();</span><br><span class="line">            <span class="built_in">super</span>.run();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            alive.decrementAndGet();</span><br><span class="line">            <span class="keyword">if</span> (debug) log.log(Level.FINE, <span class="string">&quot;Exiting &quot;</span> + getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getThreadsCreated</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> created.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getThreadsAlive</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> alive.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">getDebug</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> debugLifecycle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setDebug</span><span class="params">(<span class="type">boolean</span> b)</span> &#123;</span><br><span class="line">        debugLifecycle = b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-3-5-构造后再定制-ThreadPoolExecutor"><a href="#1-3-5-构造后再定制-ThreadPoolExecutor" class="headerlink" title="1.3.5 构造后再定制 ThreadPoolExecutor"></a>1.3.5 构造后再定制 ThreadPoolExecutor</h3><ul>
<li><p>大多数通过构造函数传递给 ThreadPoolExecutor 的参数（比如核心池大小，最大池大小，存活时间，线程工厂和拒绝执行处理器(rejected execution handler)），都可以在创建 Executor 后通过 <code>setters</code> 进行修改。<code>Executors.newSingleThreadExecutor()</code> 创建的 Executor 除外。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span></span><br><span class="line">        (<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  newSingleThreadExecutor() 与其他方法的实现不同，它按 <code>FinalizableDelegatedExecutorService</code> 方式封装的 ExecutorService，而不是原始的 ThreadPoolExecutor。</p>
</li>
<li><p>在 Executors中包含一个 unconfigurableExecutorService() 工厂方法：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">unconfigurableExecutorService</span><span class="params">(ExecutorService executor)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (executor == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DelegatedExecutorService</span>(executor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  它返回一个现有的 ExecutorService，并对它进行包装。它只暴露出 ExecutorService 的方法，不能进行进一步的配置。</p>
</li>
</ul>
<h2 id="1-4-扩展-ThreadPoolExecutor"><a href="#1-4-扩展-ThreadPoolExecutor" class="headerlink" title="1.4 扩展 ThreadPoolExecutor"></a>1.4 扩展 ThreadPoolExecutor</h2><p>ThreadPoolExecutor 是可扩展的， 它提供了几个 “钩子” 方法让子类去复写：</p>
<ul>
<li><p>beforeExecute()</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在给定线程中，执行给定 Runnable 之前调用的方法。</span></span><br><span class="line"><span class="comment"> * 此方法由将执行 【Runnable r】 的线程 【Thread t】 调用，并可用于重新初始化 ThreadLocals，或执行日志记录</span></span><br><span class="line"><span class="comment"> * 这个实现什么都不做，但可以在子类中定制。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 参数：</span></span><br><span class="line"><span class="comment"> * t - 将运行【Runnable r】的线程</span></span><br><span class="line"><span class="comment"> * r - 将要执行的任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeExecute</span><span class="params">(Thread t, Runnable r)</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p>afteExecute()</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在完成给定 Runnable 的执行时调用的方法。</span></span><br><span class="line"><span class="comment"> * 如果 【Throwable != null】，则 Throwable 是导致执行突然终止的未捕获的 RuntimeException 或 Error</span></span><br><span class="line"><span class="comment"> * 这个实现什么都不做，但可以在子类中定制。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 参数：</span></span><br><span class="line"><span class="comment"> * t - 导致终止的异常，如果执行正常完成，则返回 null</span></span><br><span class="line"><span class="comment"> * r - 已完成的任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterExecute</span><span class="params">(Runnable r, Throwable t)</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p>terminated()</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Executor 终止时调用的方法。这个实现什么都不做，但可以在子类中定制。 */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">terminated</span><span class="params">()</span> &#123; &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>扩展线程池，以提供日志和计时功能</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimingThreadPool</span> <span class="keyword">extends</span> <span class="title class_">ThreadPoolExecutor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TimingThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0L</span>, TimeUnit.SECONDS, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Long&gt; startTime = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Long&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> Logger.getLogger(String.valueOf(TimingThreadPool.class));</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">numTasks</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">totalTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeExecute</span><span class="params">(Thread t, Runnable r)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.beforeExecute(t, r);</span><br><span class="line">        logger.fine(String.format(<span class="string">&quot;Thread %s: start %s&quot;</span>, t, r));</span><br><span class="line">        startTime.set(System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterExecute</span><span class="params">(Runnable r, Throwable t)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            <span class="type">long</span> <span class="variable">taskTime</span> <span class="operator">=</span> endTime - startTime.get();</span><br><span class="line">            numTasks.incrementAndGet();</span><br><span class="line">            totalTime.addAndGet(taskTime);</span><br><span class="line">            logger.fine(String.format(<span class="string">&quot;Thread %s: end %s, time=%dns&quot;</span>,</span><br><span class="line">                    t, r, taskTime));</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.afterExecute(r, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">terminated</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            logger.info(String.format(<span class="string">&quot;Terminated: avg time=%dns&quot;</span>,</span><br><span class="line">                    totalTime.get() / numTasks.get()));</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.terminated();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="2-并行递归算法"><a href="#2-并行递归算法" class="headerlink" title="2. 并行递归算法"></a>2. 并行递归算法</h1><h2 id="2-1-并行递归算法"><a href="#2-1-并行递归算法" class="headerlink" title="2.1 并行递归算法"></a>2.1 并行递归算法</h2><p><strong>如果每一个循环的每次迭代都睡觉哦独立的，并且我们不必等待所有的迭代都完成后再一次处理，那么我们可以使用 Executor 把一个顺序的循环转化为并行的循环。</strong></p>
<blockquote>
<p>把顺序执行转换为并行执行</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentLinkedQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">TransformingSequential</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 顺序执行 */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">processSequentially</span><span class="params">(List&lt;Element&gt; elements)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Element e : elements) &#123;</span><br><span class="line">            process(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 并行执行 */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">processInParallel</span><span class="params">(Executor exec, List&lt;Element&gt; elements)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Element e : elements) &#123;</span><br><span class="line">            exec.execute(() -&gt; process(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(Element e)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Element</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当每个选代彼此独立，并且完成循环体中每个送代的工作，意义都足够重大，足以弥补管理一个新任务的开销时，这个顺序循环是适合并行化的。</p>
<blockquote>
<p>把顺序递归转化为并行递归</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentLinkedQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">TransformingSequential</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 顺序递归 */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">sequentialRecursive</span><span class="params">(List&lt;Node&lt;T&gt;&gt; nodes,</span></span><br><span class="line"><span class="params">                                        Collection&lt;T&gt; results)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;T&gt; n : nodes) &#123;</span><br><span class="line">            results.add(n.compute());</span><br><span class="line">            sequentialRecursive(n.getChildren(), results);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 并行递归 */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">parallelRecursive</span><span class="params">(<span class="keyword">final</span> Executor exec,</span></span><br><span class="line"><span class="params">                                      List&lt;Node&lt;T&gt;&gt; nodes,</span></span><br><span class="line"><span class="params">                                      <span class="keyword">final</span> Collection&lt;T&gt; results)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Node&lt;T&gt; n : nodes) &#123;</span><br><span class="line">            exec.execute(() -&gt; results.add(n.compute()));</span><br><span class="line">            parallelRecursive(exec, n.getChildren(), results);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 执行并行递归，获取结果 */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Collection&lt;T&gt; <span class="title function_">getParallelResults</span><span class="params">(List&lt;Node&lt;T&gt;&gt; nodes)</span></span><br><span class="line">            <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">exec</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        Queue&lt;T&gt; resultQueue = <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;T&gt;();</span><br><span class="line">        parallelRecursive(exec, nodes, resultQueue);</span><br><span class="line">        exec.shutdown();</span><br><span class="line">        exec.awaitTermination(Long.MAX_VALUE, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> resultQueue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Node</span> &lt;T&gt; &#123;</span><br><span class="line">        T <span class="title function_">compute</span><span class="params">()</span>;</span><br><span class="line">        List&lt;Node&lt;T&gt;&gt; <span class="title function_">getChildren</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-2-示例：谜题框架"><a href="#2-2-示例：谜题框架" class="headerlink" title="2.2 示例：谜题框架"></a>2.2 示例：谜题框架</h2><blockquote>
<p>“搬箱子” 谜题的抽象</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * “搬箱子” 谜题的抽象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;P&gt; 位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;M&gt; 移动</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Puzzle</span> &lt;P, M&gt; &#123;</span><br><span class="line">    <span class="comment">/** 初始化 */</span></span><br><span class="line">    P <span class="title function_">initialPosition</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 移动位置是否为本位置 */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isGoal</span><span class="params">(P position)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 合法移动 */</span></span><br><span class="line">    Set&lt;M&gt; <span class="title function_">legalMoves</span><span class="params">(P position)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 搬箱子 */</span></span><br><span class="line">    P <span class="title function_">move</span><span class="params">(P position, M move)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>谜题解决者框架的链节点</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.Immutable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Immutable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PuzzleNode</span> &lt;P, M&gt; &#123;</span><br><span class="line">    <span class="comment">/** 位置 */</span></span><br><span class="line">    <span class="keyword">final</span> P pos;</span><br><span class="line">    <span class="comment">/** 移动位置 */</span></span><br><span class="line">    <span class="keyword">final</span> M move;</span><br><span class="line">    <span class="comment">/** 上一个位置 */</span></span><br><span class="line">    <span class="keyword">final</span> PuzzleNode&lt;P, M&gt; prev;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PuzzleNode</span><span class="params">(P pos, M move, PuzzleNode&lt;P, M&gt; prev)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.pos = pos;</span><br><span class="line">        <span class="built_in">this</span>.move = move;</span><br><span class="line">        <span class="built_in">this</span>.prev = prev;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 链表转集合 */</span></span><br><span class="line">    List&lt;M&gt; <span class="title function_">asMoveList</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;M&gt; solution = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;M&gt;();</span><br><span class="line">        <span class="keyword">for</span> (PuzzleNode&lt;P, M&gt; node = <span class="built_in">this</span>; node.move != <span class="literal">null</span>; node = node.prev) &#123;</span><br><span class="line">            solution.add(<span class="number">0</span>, node.move);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> solution;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>顺序话版的谜题解决者</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SequentialPuzzleSolver</span> &lt;P, M&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Puzzle&lt;P, M&gt; puzzle;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;P&gt; seen = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;P&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SequentialPuzzleSolver</span><span class="params">(Puzzle&lt;P, M&gt; puzzle)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.puzzle = puzzle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 解决者 */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;M&gt; <span class="title function_">solve</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">P</span> <span class="variable">pos</span> <span class="operator">=</span> puzzle.initialPosition();</span><br><span class="line">        <span class="keyword">return</span> search(<span class="keyword">new</span> <span class="title class_">PuzzleNode</span>&lt;P, M&gt;(pos, <span class="literal">null</span>, <span class="literal">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 箱子移动 */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;M&gt; <span class="title function_">search</span><span class="params">(PuzzleNode&lt;P, M&gt; node)</span> &#123;</span><br><span class="line">        <span class="comment">// 该位置不存在箱子，或者箱子没有到过这个位置</span></span><br><span class="line">        <span class="keyword">if</span> (!seen.contains(node.pos)) &#123;</span><br><span class="line">            seen.add(node.pos);</span><br><span class="line">            <span class="comment">// 移动位置是否为本位置</span></span><br><span class="line">            <span class="keyword">if</span> (puzzle.isGoal(node.pos)) &#123;</span><br><span class="line">                <span class="keyword">return</span> node.asMoveList();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取每个合法移动</span></span><br><span class="line">            <span class="keyword">for</span> (M move : puzzle.legalMoves(node.pos)) &#123;</span><br><span class="line">                <span class="comment">// 当前箱子位置移动</span></span><br><span class="line">                <span class="type">P</span> <span class="variable">pos</span> <span class="operator">=</span> puzzle.move(node.pos, move);</span><br><span class="line">                <span class="comment">// 下一个箱子移动</span></span><br><span class="line">                PuzzleNode&lt;P, M&gt; child = <span class="keyword">new</span> <span class="title class_">PuzzleNode</span>&lt;&gt;(pos, move, node);</span><br><span class="line">                List&lt;M&gt; result = <span class="built_in">this</span>.search(child);</span><br><span class="line">                <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>并发版的谜题解决者</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.GuardedBy;</span><br><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcurrentPuzzleSolver</span> &lt;P, M&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 搬箱子谜题 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Puzzle&lt;P, M&gt; puzzle;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService exec;</span><br><span class="line">    <span class="comment">/** 箱子是否存在该位置 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;P, Boolean&gt; seen;</span><br><span class="line">    <span class="comment">/** 可携带结果的闭锁 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> ValueLatch&lt;PuzzleNode&lt;P, M&gt;&gt; solution = <span class="keyword">new</span> <span class="title class_">ValueLatch</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConcurrentPuzzleSolver</span><span class="params">(Puzzle&lt;P, M&gt; puzzle)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.puzzle = puzzle;</span><br><span class="line">        <span class="comment">// Return ThreadPoolExecutor Object</span></span><br><span class="line">        <span class="built_in">this</span>.exec = initThreadPool();</span><br><span class="line">        <span class="built_in">this</span>.seen = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;P, Boolean&gt;();</span><br><span class="line">        <span class="keyword">if</span> (exec <span class="keyword">instanceof</span> ThreadPoolExecutor) &#123;</span><br><span class="line">            <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> (ThreadPoolExecutor) exec;</span><br><span class="line">            <span class="comment">// 被拒绝任务，它默默地丢弃被拒绝的任务。</span></span><br><span class="line">            threadPoolExecutor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.DiscardPolicy());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ExecutorService <span class="title function_">initThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Executors.newCachedThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 解决者 */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;M&gt; <span class="title function_">solve</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">P</span> <span class="variable">p</span> <span class="operator">=</span> puzzle.initialPosition();</span><br><span class="line">            exec.execute(newTask(p, <span class="literal">null</span>, <span class="literal">null</span>));</span><br><span class="line">            <span class="comment">// 阻塞，知道找到一个方案</span></span><br><span class="line">            PuzzleNode&lt;P, M&gt; solutionPuzzleNode = solution.getValue();</span><br><span class="line">            <span class="keyword">return</span> (solutionPuzzleNode == <span class="literal">null</span>) ? <span class="literal">null</span> : solutionPuzzleNode.asMoveList();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            exec.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Runnable <span class="title function_">newTask</span><span class="params">(P position, M move, PuzzleNode&lt;P, M&gt; puzzleNode)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SolverTask</span>(position, move, puzzleNode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">class</span> <span class="title class_">SolverTask</span> <span class="keyword">extends</span> <span class="title class_">PuzzleNode</span>&lt;P, M&gt; <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        SolverTask(P pos, M move, PuzzleNode&lt;P, M&gt; prev) &#123;</span><br><span class="line">            <span class="built_in">super</span>(pos, move, prev);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// 已找到一个解决方案，或者该位置曾经到达过</span></span><br><span class="line">            <span class="keyword">if</span> (solution.isSet() || seen.putIfAbsent(pos, <span class="literal">true</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 移动位置是否为本位置</span></span><br><span class="line">            <span class="keyword">if</span> (!puzzle.isGoal(pos)) &#123;</span><br><span class="line">                <span class="comment">// 获取每个合法移动</span></span><br><span class="line">                <span class="keyword">for</span> (M move : puzzle.legalMoves(pos)) &#123;</span><br><span class="line">                    exec.execute(</span><br><span class="line">                            <span class="comment">// 创建一个新的 task 进行位置移动</span></span><br><span class="line">                            newTask(puzzle.move(pos, move),</span><br><span class="line">                                    move,</span><br><span class="line">                                    <span class="built_in">this</span>)</span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 移动位置为本位置</span></span><br><span class="line">                solution.setValue(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ConcurrentPuzzleSolver 使用可携带结果的闭锁</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValueLatch</span> &lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">T</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">/** 一种同步辅助，允许一个或多个线程等待，直到在其他线程中执行的一组操作完成。 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">done</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (done.getCount() == <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(T newValue)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isSet()) &#123;</span><br><span class="line">            value = newValue;</span><br><span class="line">            <span class="comment">// Decrease ---&gt; 【done.getCount() - 1】</span></span><br><span class="line">            done.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getValue</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 当前线程等待直到锁存器倒计时到零</span></span><br><span class="line">        done.await();</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div class="article-licensing box"><div class="licensing-title"><p>Java并发编程实战：第8章 应用线程池</p><p><a href="https://osys.github.io/posts/9a9d.html">https://osys.github.io/posts/9a9d.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Osys</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022年08月29日</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022年08月29日</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/posts/3fe1.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Java并发编程实战：第8章 总结</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/posts/2bd1.html"><span class="level-item">Java并发编程实战：第7章 总结</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "dbcb3f371c4a968f9b00c2cbf107899d",
            repo: "osys.github.io",
            owner: "osys",
            clientID: "e0f10cf0c934d445e79f",
            clientSecret: "3dad6d25224fe45db31a3a912756bd5175e3a70f",
            admin: ["osys"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-8-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#1-应用线程池"><span class="level-left"><span class="level-item">1. 应用线程池</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-在任务与执行策略之间的隐性耦合"><span class="level-left"><span class="level-item">1.1 在任务与执行策略之间的隐性耦合</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-1-线程饥饿死锁"><span class="level-left"><span class="level-item">1.1.1 线程饥饿死锁</span></span></a></li><li><a class="level is-mobile" href="#1-1-2-耗时操作"><span class="level-left"><span class="level-item">1.1.2 耗时操作</span></span></a></li></ul></li><li><a class="level is-mobile" href="#1-2-定制线程池的大小"><span class="level-left"><span class="level-item">1.2 定制线程池的大小</span></span></a></li><li><a class="level is-mobile" href="#1-3-配置-ThreadPoolExecutor"><span class="level-left"><span class="level-item">1.3 配置 ThreadPoolExecutor</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-3-1-线程的创建与销毁"><span class="level-left"><span class="level-item">1.3.1 线程的创建与销毁</span></span></a></li><li><a class="level is-mobile" href="#1-3-2-管理队列任务"><span class="level-left"><span class="level-item">1.3.2 管理队列任务</span></span></a></li><li><a class="level is-mobile" href="#1-3-3-饱和策略"><span class="level-left"><span class="level-item">1.3.3 饱和策略</span></span></a></li><li><a class="level is-mobile" href="#1-3-4-线程工厂"><span class="level-left"><span class="level-item">1.3.4 线程工厂</span></span></a></li><li><a class="level is-mobile" href="#1-3-5-构造后再定制-ThreadPoolExecutor"><span class="level-left"><span class="level-item">1.3.5 构造后再定制 ThreadPoolExecutor</span></span></a></li></ul></li><li><a class="level is-mobile" href="#1-4-扩展-ThreadPoolExecutor"><span class="level-left"><span class="level-item">1.4 扩展 ThreadPoolExecutor</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-并行递归算法"><span class="level-left"><span class="level-item">2. 并行递归算法</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-并行递归算法"><span class="level-left"><span class="level-item">2.1 并行递归算法</span></span></a></li><li><a class="level is-mobile" href="#2-2-示例：谜题框架"><span class="level-left"><span class="level-item">2.2 示例：谜题框架</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/basic/avatar.png" alt="Osys"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Osys</p><p class="is-size-6 is-block">追寻美好生活，书写人生精彩篇章。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>GuangZhou</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">31</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">5</p></a></div></div></nav></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">29</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%A1%B9%E7%9B%AE%E6%A1%88%E4%BE%8B/"><span class="level-start"><span class="level-item">项目案例</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><span class="tag">Java并发编程</span><span class="tag">29</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringBoot/"><span class="tag">SpringBoot</span><span class="tag">2</span></a></div></div></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/09/"><span class="level-start"><span class="level-item">九月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">29</span></span></a></li></ul></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.cnblogs.com/liyihua/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">我的博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/qq_44830823?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">我的CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="footer-content"><div class="footer-left"><div class="footer-logo-section"><a class="footer-logo" href="/"><div class="footer-logo-row"><img src="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png" alt="LeeHua&#039;s Blog" height="35"><span class="footer-tagline">LeeHua&#039;s Blog</span></div><div class="footer-runtime"><span class="footer-osys">OSYS</span><div class="footer-runtime-text" id="site-runtime">本站已安全运行1159 天 16 小时 11 分钟 57 秒</div></div></a></div><div class="footer-info"><p class="footer-statistics"><script src="https://sdk.51.la/perf/js-sdk-pro.min.js" crossorigin="anonymous"></script><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js?id=JoDQdGZeB7Cy04AN&amp;ck=JoDQdGZeB7Cy04AN"></script><a target="blank" title="网站统计" href="https://v6.51.la/land/JoDQdGZeB7Cy04AN"></a><script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoDQdGZeB7Cy04AN/quote.js?theme=0&amp;f=12&amp;display=0,1,1,1,1,1,0,1"></script></p><a href="https://beian.miit.gov.cn/" target="_blank"><div class="footer-card"><span class="footer-card-title">备案号:</span> 粤ICP备2022104988号</div></a><a href="https://github.com/" target="_blank"><div class="footer-card"><span class="footer-card-title">网站:</span> 挂载于 github + 腾讯云</div></a><a href="https://github.com/" target="_blank"><div class="footer-card"><span class="footer-card-title">图片:</span> 挂载于 github</div></a><a href="https://www.jsdelivr.com/github" target="_blank"><div class="footer-card"><span class="footer-card-title">CDN:</span> jsDelivr</div></a></div></div><div class="footer-right"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="粤ICP备2022104988号-1" href="https://beian.miit.gov.cn/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Blog on GitHub" href="https://github.com/osys/osys.github.io/"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container" id="algolia-input"></div><div id="algolia-poweredby" style="display:flex;margin:0 .5em 0 1em;align-items:center;line-height:0"></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div><div class="searchbox-footer"></div></div></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.0.3/dist/algoliasearch-lite.umd.js" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.3.1/dist/instantsearch.production.min.js" crossorigin="anonymous" defer></script><script src="/js/algolia.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadAlgolia({"applicationId":"8FPI8CDLJR","apiKey":"702cfc5bf8397419842065704ec39904","indexName":"github_pages_hexo_blog"}, {"hint":"想要查找什么...","no_result":"未找到搜索结果","untitled":"(无标题)","empty_preview":"(无内容预览)"});
        });</script></body></html>