<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>SpringBoot项目连接多源MySQL数据库 - LeeHua的博客</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="LeeHua&#039;s Blog"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="LeeHua&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="说明(主要是实现的思路)  对于使用 SpringBoot 中使用 MySQL 的项目来说，可能会面临一个 SpringBoot 项目连接多个不同的 MySQL 数据库。这里针对普通的 SpringBoot 项目进行实现。关注点在查询前，数据库选择上进行定义。Demo 项目代码已经放到了我的 GitHub，是 SpringBoot + MyBatis 的测试项目。通过注解，选择不同的数据库。可能"><meta property="og:type" content="blog"><meta property="og:title" content="SpringBoot项目连接多源MySQL数据库"><meta property="og:url" content="https://osys.github.io/"><meta property="og:site_name" content="Osys&#039;s Blog"><meta property="og:description" content="说明(主要是实现的思路)  对于使用 SpringBoot 中使用 MySQL 的项目来说，可能会面临一个 SpringBoot 项目连接多个不同的 MySQL 数据库。这里针对普通的 SpringBoot 项目进行实现。关注点在查询前，数据库选择上进行定义。Demo 项目代码已经放到了我的 GitHub，是 SpringBoot + MyBatis 的测试项目。通过注解，选择不同的数据库。可能"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20221031195816.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20221031195853.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20221031195915.png"><meta property="article:published_time" content="2022-10-31T11:53:06.000Z"><meta property="article:modified_time" content="2022-10-31T12:14:38.000Z"><meta property="article:author" content="Osys"><meta property="article:tag" content="SpringBoot"><meta property="article:tag" content="Java"><meta property="article:tag" content="MySQL"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20221031195816.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://osys.github.io/"},"headline":"LeeHua's Blog","image":["https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20221031195816.png","https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20221031195853.png","https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20221031195915.png"],"datePublished":"2022-10-31T11:53:06.000Z","dateModified":"2022-10-31T12:14:38.000Z","author":{"@type":"Person","name":"Osys"},"publisher":{"@type":"Organization","name":"Osys","logo":{"@type":"ImageObject","url":"https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"}},"description":"一路生花"}</script><link rel="canonical" href="https://osys.github.io/posts/b56a.html"><link rel="alternate" href="/path/to/atom.xml" title="LeeHua的博客" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?44cd31785e14a1fdaad0921651759e0f";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 6.0.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png" alt="LeeHua的博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-10-31T11:53:06.000Z" title="10/31/2022, 11:53:06 AM">2022年10月31日</time>发表</span><span class="level-item"><time dateTime="2022-10-31T12:14:38.000Z" title="10/31/2022, 12:14:38 PM">2022年10月31日</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E9%A1%B9%E7%9B%AE%E6%A1%88%E4%BE%8B/">项目案例</a></span><span class="level-item">35 分钟读完 (大约5226个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">SpringBoot项目连接多源MySQL数据库</h1><div class="content"><blockquote>
<p>说明(主要是实现的思路)</p>
</blockquote>
<p>对于使用 SpringBoot 中使用 MySQL 的项目来说，可能会面临一个 SpringBoot 项目连接多个不同的 MySQL 数据库。这里针对普通的 SpringBoot 项目进行实现。关注点在查询前，数据库选择上进行定义。Demo 项目代码已经放到了我的 <a target="_blank" rel="noopener" href="https://github.com/osys/DataSourcePoint">GitHub</a>，是 SpringBoot + MyBatis 的测试项目。通过注解，选择不同的数据库。可能大家在参考的时候会出现各种奇奇怪怪的问题（细心能解决大部分问题哈）</p>
<span id="more"></span>

<h2 id="1-普通的-SpringBoot-项目"><a href="#1-普通的-SpringBoot-项目" class="headerlink" title="1. 普通的 SpringBoot 项目"></a>1. 普通的 SpringBoot 项目</h2><p><img src="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20221031195816.png" alt="20221031195816"></p>
<p>datasource 目录中的代码为主要实现代码。example 目录下的代码只是用作测试不同MySQL数据源的连接。</p>
<h2 id="2-实现思路"><a href="#2-实现思路" class="headerlink" title="2. 实现思路"></a>2. 实现思路</h2><blockquote>
<p>数据源连接信息实体类(<strong>getter、setter、constructer省略</strong>)</p>
</blockquote>
<p>该实体类的字段信息，根据自己项目特定情况而定。不一定按照如此定义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.datasource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.StringJoiner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceProperty</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 数据库连接类型，后边使用 com.zaxxer.hikari.HikariDataSource 数据库连接池。使用别的数据库连接池思想也一样 */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">DataSource</span>&gt; clazzType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 数据库连接驱动：com.mysql.cj.jdbc.Driver、com.mysql.jdbc.Driver。不同的版本用的驱动可能是不一样的 */</span></span><br><span class="line">    <span class="keyword">private</span> String driverClassName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 数据库连接用户名 */</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 数据库连接密码 */</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 数据库ip */</span></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 数据库端口 */</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 数据库名 */</span></span><br><span class="line">    <span class="keyword">private</span> String dataSourceName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 后边获取该连接信息对应的 key */</span></span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>数据库连接构建类</p>
</blockquote>
<p>对于上面的 DataSourceProperty 保存的是数据库连接信息，这里创建一个构建工具类，用于构建数据库连接。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.datasource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.MutablePropertyValues;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.convert.ConversionService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.convert.support.DefaultConversionService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.DataBinder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSourceBuilder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DataSourceProperty property;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ConversionService</span> <span class="variable">conversionService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConversionService</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 默认 DataSource 类型 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">DataSource</span>&gt; DEFAULT_DATASOURCE_TYPE = com.zaxxer.hikari.HikariDataSource.class;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DynamicDataSourceBuilder <span class="title function_">create</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DynamicDataSourceBuilder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 添加数据库连接信息 */</span></span><br><span class="line">    <span class="keyword">public</span> DynamicDataSourceBuilder <span class="title function_">setPropertyValues</span><span class="params">(DataSourceProperty dataSourceProperty)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.property = dataSourceProperty;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 构建数据库连接 */</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> buildDataSource(<span class="built_in">this</span>.property);</span><br><span class="line">        <span class="keyword">return</span> propertySet(dataSource, <span class="built_in">this</span>.property);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 数据库连接 */</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">buildDataSource</span><span class="params">(DataSourceProperty dataSourceProperty)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">driverClassName</span> <span class="operator">=</span> dataSourceProperty.getDriverClassName();</span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">DataSource</span>&gt; dataSourceType = dataSourceProperty.getClazzType();</span><br><span class="line">        <span class="keyword">if</span> (dataSourceType == <span class="literal">null</span>) &#123;</span><br><span class="line">            dataSourceType = DEFAULT_DATASOURCE_TYPE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">dataSourceName</span> <span class="operator">=</span> dataSourceProperty.getDataSourceName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> dataSourceProperty.getHost();</span><br><span class="line">        <span class="type">String</span> <span class="variable">port</span> <span class="operator">=</span> dataSourceProperty.getPort();</span><br><span class="line">        <span class="type">String</span> <span class="variable">userName</span> <span class="operator">=</span> dataSourceProperty.getUserName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> dataSourceProperty.getPassword();</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://&quot;</span> +</span><br><span class="line">                host + <span class="string">&quot;:&quot;</span> + port +</span><br><span class="line">                <span class="string">&quot;/&quot;</span> + dataSourceName +</span><br><span class="line">                <span class="string">&quot;?&quot;</span> + <span class="string">&quot;useUnicode=true&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&amp;characterEncoding=utf-8&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&amp;serverTimezone=Asia/Shanghai&quot;</span>;</span><br><span class="line">        DataSourceBuilder&lt;? <span class="keyword">extends</span> <span class="title class_">DataSource</span>&gt; dataSourceBuilder = DataSourceBuilder.create()</span><br><span class="line">                .driverClassName(driverClassName)</span><br><span class="line">                .url(url)</span><br><span class="line">                .username(userName)</span><br><span class="line">                .password(password)</span><br><span class="line">                .type(dataSourceType);</span><br><span class="line">        <span class="keyword">return</span> dataSourceBuilder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 数据库连接池的一些配置，也可以不用，正常没什么影响。连接池都有默认配置的。 */</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">propertySet</span><span class="params">(DataSource dataSource, DataSourceProperty dataSourceProperty)</span> &#123;</span><br><span class="line">        <span class="type">DataBinder</span> <span class="variable">dataBinder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataBinder</span>(dataSource);</span><br><span class="line">        dataBinder.setConversionService(conversionService);</span><br><span class="line">        dataBinder.setIgnoreInvalidFields(<span class="literal">true</span>);</span><br><span class="line">        dataBinder.setIgnoreUnknownFields(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 新加连接池配置</span></span><br><span class="line">        Map&lt;String, Object&gt; values = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        values.put(<span class="string">&quot;max-pool-size&quot;</span>, <span class="number">10</span>);</span><br><span class="line">        values.put(<span class="string">&quot;connection-timeout&quot;</span>, <span class="number">50000</span>);</span><br><span class="line">        values.put(<span class="string">&quot;min-idle&quot;</span>, <span class="number">5</span>);</span><br><span class="line">        values.put(<span class="string">&quot;idle-timeout&quot;</span>, <span class="number">500000</span>);</span><br><span class="line">        values.put(<span class="string">&quot;max-lifetime&quot;</span>, <span class="number">540000</span>);</span><br><span class="line">        dataBinder.bind(<span class="keyword">new</span> <span class="title class_">MutablePropertyValues</span>(values));</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>多数据源连接信息实体类</p>
</blockquote>
<p>上面的 <code>DataSourceProperty</code> 保存的时某个数据源的连接信息，由于是多数据源的，会存在多个 <code>DataSourceProperty</code> 对象，这里通过数据源 key 来获取对应的数据源连接信息，编写一个保存数据源信息的配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.datasource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration(value = &quot;dynamicDataSourceConfig&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSourceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 数据源 key 和配置属性实体类的键值对 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, DataSourceProperty&gt; dataSourceProps = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 保存一个数据源连接信息 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerDataSource</span><span class="params">(DataSourceProperty dataSourceProperty)</span> &#123;</span><br><span class="line">        dataSourceProps.put(dataSourceProperty.getKey(), dataSourceProperty);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 移除一个数据源连接信息 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeDataSource</span><span class="params">(String dataSourceKey)</span> &#123;</span><br><span class="line">        dataSourceProps.remove(dataSourceKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 获取一个数据源连接信息 */</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceProperty <span class="title function_">getDataSourceProperty</span><span class="params">(String dataSourceKey)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dataSourceProps.get(dataSourceKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p><strong>多数据源的选择</strong></p>
</blockquote>
<p><code>AbstractRoutingDataSource</code> 是 SpringBoot 基于查找 key 将 getConnection() 调用路由到各种目标 DataSource 之一的抽象 DataSource 实现。</p>
<p>选择数据源解决方案：编写一个类，继承 <code>AbstractRoutingDataSource</code>，实现它的 <code>determineCurrentLookupKey()</code> 方法和 <code>determineTargetDataSource()</code> 方法，来选择使用哪一个数据源。<code>DynamicDataSourceConfig</code> 中 Map 保存到创建的数据连接。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.datasource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;b&gt;&#123;<span class="doctag">@link</span> DynamicDataSourceResolver&#125; Description&lt;/b&gt;: 在进行查询时，选择需要的 DataSource。</span></span><br><span class="line"><span class="comment"> * 默认为主数据源。key = null 时，为主数据源。</span></span><br><span class="line"><span class="comment"> * key != null 时，如果 dynamicDataSources 中存在对应的数据源，直接取出使用。</span></span><br><span class="line"><span class="comment"> * 如果 dynamicDataSources 中不存在 key 对应的数据源，那么从 dynamicDataSourceConfig 中获取 key 对应的数据源配置(如果存在)，</span></span><br><span class="line"><span class="comment"> * 创建新的数据源，保存在 dynamicDataSources 中，并在查询中使用，否则使用默认数据源(主数据源)。</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Created by osys on 2022/08/30 11:09.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSourceResolver</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutingDataSource</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 保存动态数据库连接的 Map， dataSourceKey -&gt; DataSource */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;String, DataSource&gt; dynamicDataSources = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DynamicDataSourceConfig dynamicDataSourceConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;dynamicDataSourceConfig&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDynamicDataSourceConfig</span><span class="params">(DynamicDataSourceConfig dynamicDataSourceConfig)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dynamicDataSourceConfig = dynamicDataSourceConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 确定当前查找 key。这通常会被实现来检查线程绑定的事务上下文。</span></span><br><span class="line"><span class="comment">     * 允许任意键。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> target dataSource key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 往下看【线程隔离的 key】处说明</span></span><br><span class="line">        <span class="keyword">return</span> DynamicDataSourceContextHolder.getDataSourceKey();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检索当前目标数据源。</span></span><br><span class="line"><span class="comment">     * 确定 current lookup key，在 targetDataSources 映射中执行查找，必要时回退到指定的default target DataSource。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> DataSource <span class="title function_">determineTargetDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">lookupKey</span> <span class="operator">=</span> determineCurrentLookupKey();</span><br><span class="line">        <span class="keyword">if</span> (lookupKey == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">super</span>.logger.info(<span class="string">&quot;使用默认数据源&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.determineTargetDataSource();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> dynamicDataSources.get(String.valueOf(lookupKey));</span><br><span class="line">        <span class="keyword">if</span> (dataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">super</span>.logger.info(<span class="string">&quot;使用数据源:&quot;</span> + lookupKey);</span><br><span class="line">            <span class="keyword">return</span> dataSource;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">DataSourceProperty</span> <span class="variable">dataSourceProperty</span> <span class="operator">=</span> dynamicDataSourceConfig.getDataSourceProperty(String.valueOf(lookupKey));</span><br><span class="line">        <span class="keyword">if</span> (dataSourceProperty == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">super</span>.logger.info(<span class="string">&quot;使用默认数据源&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.determineTargetDataSource();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">createDataSource</span> <span class="operator">=</span> DynamicDataSourceBuilder</span><br><span class="line">                .create()</span><br><span class="line">                .setPropertyValues(dataSourceProperty)</span><br><span class="line">                .build();</span><br><span class="line">        dynamicDataSources.put(String.valueOf(lookupKey), createDataSource);</span><br><span class="line">        <span class="built_in">super</span>.logger.info(<span class="string">&quot;使用数据源:&quot;</span> + lookupKey);</span><br><span class="line">        <span class="keyword">return</span> createDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeDataSource</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        dynamicDataSources.remove(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addDataSource</span><span class="params">(String key, DataSource dataSource)</span> &#123;</span><br><span class="line">        dynamicDataSources.put(key, dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>线程隔离的 key</p>
</blockquote>
<p>上面的 <code>DynamicDataSourceResolver#determineTargetDataSource()</code> 方法中，确定的是 dataSource 的 key。SpringBoot 项目中，CRUD 操作是在不同线程中进行的，不同的需求，连接的MySQL数据库可能是不一样的，因此不同线程之间的 Key 是不能够被其它线程影响到的。使用 <code>ThreadLocal</code> 防止任务在共享资源上产生冲突</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.datasource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用 ThreadLocal 来指定 DataSource 的 key</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSourceContextHolder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; contextHolder = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setDataSourceKey</span><span class="params">(String dataSourceKey)</span> &#123;</span><br><span class="line">        contextHolder.set(dataSourceKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDataSourceKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> contextHolder.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clearDataSourceKey</span><span class="params">()</span> &#123;</span><br><span class="line">        contextHolder.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>将数据源注册为 bean</p>
</blockquote>
<p>前面一件基本实现了不同数据源的选择，在此还有一件比较重要的事情要完成，那就是将我们项目中的数据库连接注册为 bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.datasource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.MutablePropertyValues;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.GenericBeanDefinition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.EnvironmentAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ImportBeanDefinitionRegistrar;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotationMetadata;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将主数据源、动态数据源注册为 Bean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration(value = &quot;dynamicDataSourceRegister&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSourceRegister</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>, EnvironmentAware &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DataSource defaultDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// 所有数据源</span></span><br><span class="line">        Map&lt;String, Object&gt; targetDataSources = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 将主数据源添加到 targetDataSources 中</span></span><br><span class="line">        targetDataSources.put(<span class="string">&quot;dataSource&quot;</span>, defaultDataSource);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 DynamicDataSource 路由类，并注册到容器里做数据源</span></span><br><span class="line">        <span class="type">GenericBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericBeanDefinition</span>();</span><br><span class="line">        beanDefinition.setBeanClass(DynamicDataSourceResolver.class);</span><br><span class="line">        beanDefinition.setSynthetic(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">MutablePropertyValues</span> <span class="variable">propertyValues</span> <span class="operator">=</span> beanDefinition.getPropertyValues();</span><br><span class="line">        <span class="comment">// 命名要求如此：</span></span><br><span class="line">        <span class="comment">// 默认(主)数据源 -&gt; defaultTargetDataSource</span></span><br><span class="line">        <span class="comment">// 目标(其它)数据源 -&gt; targetDataSources</span></span><br><span class="line">        <span class="comment">// 详情请看：AbstractRoutingDataSource.determineTargetDataSource() 方法</span></span><br><span class="line">        propertyValues.addPropertyValue(<span class="string">&quot;defaultTargetDataSource&quot;</span>, defaultDataSource);</span><br><span class="line">        propertyValues.addPropertyValue(<span class="string">&quot;targetDataSources&quot;</span>, targetDataSources);</span><br><span class="line"></span><br><span class="line">        registry.registerBeanDefinition(<span class="string">&quot;dataSources&quot;</span>, beanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnvironment</span><span class="params">(Environment environment)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取 SpringBoot 配置文件中的数据库连接信息(主数据源)</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">mainUrl</span> <span class="operator">=</span> environment.getProperty(<span class="string">&quot;spring.datasource.url&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">mainUser</span> <span class="operator">=</span> environment.getProperty(<span class="string">&quot;spring.datasource.username&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">mainPassword</span> <span class="operator">=</span> environment.getProperty(<span class="string">&quot;spring.datasource.password&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">mainDriverClassName</span> <span class="operator">=</span> environment.getProperty(<span class="string">&quot;spring.datasource.driver-class-name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 主数据源</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> mainUrl.split(<span class="string">&quot;//&quot;</span>)[<span class="number">1</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">hostPort</span> <span class="operator">=</span> uri.split(<span class="string">&quot;/&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">        String[] dsNameParma = uri.split(<span class="string">&quot;/&quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot;\\?&quot;</span>);</span><br><span class="line">        String[] parma = dsNameParma[<span class="number">1</span>].split(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">        <span class="type">DataSourceProperty</span> <span class="variable">defaultDataSourceProperty</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DataSourceProperty</span>(</span><br><span class="line">                        mainDriverClassName,</span><br><span class="line">                        mainUser,</span><br><span class="line">                        mainPassword,</span><br><span class="line">                        hostPort.split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>],</span><br><span class="line">                        hostPort.split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>],</span><br><span class="line">                        dsNameParma[<span class="number">0</span>],</span><br><span class="line">                        <span class="string">&quot;defaultDataSource&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.defaultDataSource = DynamicDataSourceBuilder.create()</span><br><span class="line">                .setPropertyValues(defaultDataSourceProperty).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于不同的 SpringBoot 项目，数据库连接的方式大概率是不一样的，如果采用本思想实现连接不同MySQL的数据库，应该将主数据源的连接方式改为如此。</p>
<blockquote>
<p>数据源连接信息</p>
</blockquote>
<p>项目中会用到的多源MySQL数据库连接，在项目启动的时候需要将这些数据库的连接信息保存到前边创建的 <code>DynamicDataSourceConfig</code> 中，以便后续使用。在 SpringBoot 中可以通过继承 CommandLineRunner 接口，实现 run() 方法，在项目启动的时候，将多个数据库连接信息加载到程序中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.datasource.runner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.datasource.DataSourceProperty;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.datasource.DynamicDataSourceConfig;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.datasource.service.RegisterConnectService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将所有的数据源连接信息，从数据库中读取出来，并保存在 &#123;<span class="doctag">@link</span> DynamicDataSourceConfig&#125; 中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(value = &quot;initializeRunner&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InitializeRunner</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 假设数据库连接信息保存在项目主数据库的表中 */</span></span><br><span class="line">    <span class="keyword">private</span> RegisterConnectService registerConnectService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> DynamicDataSourceConfig dynamicDataSourceConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;registerConnectService&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRegisterConnectService</span><span class="params">(RegisterConnectService registerConnectService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.registerConnectService = registerConnectService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;dynamicDataSourceConfig&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDynamicDataSourceConfig</span><span class="params">(DynamicDataSourceConfig dynamicDataSourceConfig)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dynamicDataSourceConfig = dynamicDataSourceConfig;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> &#123;</span><br><span class="line">        registerDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 从主数据库的表中获取多源数据库连接信息（可能你的项目的数据库连接信息不是保存在主数据库中，而是保存在别的数据库中、保存在文件中.......，只需要将信息加载进来即可）</span></span><br><span class="line">        List&lt;DataSourceProperty&gt; dataSourcePropertyList = registerConnectService.selectProperty();</span><br><span class="line">        <span class="keyword">for</span> (DataSourceProperty dataSourceProperty : dataSourcePropertyList) &#123;</span><br><span class="line">            <span class="comment">// 默认使用 com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line">            dataSourceProperty.setClazzType(com.zaxxer.hikari.HikariDataSource.class);</span><br><span class="line">            dynamicDataSourceConfig.registerDataSource(dataSourceProperty);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例如：这里的数据库连接信息是保存在主数据源中的，那么 RegisterConnectService 的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.datasource.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.datasource.DataSourceProperty;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.datasource.mapper.RegisterConnectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多数据源连接信息 service</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(value = &quot;registerConnectService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterConnectService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RegisterConnectMapper registerConnectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;registerConnectMapper&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRegisterConnectMapper</span><span class="params">(RegisterConnectMapper registerConnectMapper)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.registerConnectMapper = registerConnectMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;DataSourceProperty&gt; <span class="title function_">selectProperty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> registerConnectMapper.selectProperty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.datasource.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.datasource.DataSourceProperty;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Result;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Results;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多数据源连接信息 mapper</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Repository(value = &quot;registerConnectMapper&quot;)</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RegisterConnectMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;SELECT * FROM connect_property&quot;)</span></span><br><span class="line">    <span class="meta">@Results(value = &#123;</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;key&quot;, property = &quot;key&quot;, javaType = java.lang.String.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;data_source_name&quot;, property = &quot;dataSourceName&quot;, javaType = java.lang.String.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;port&quot;, property = &quot;port&quot;, javaType = java.lang.String.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;host&quot;, property = &quot;host&quot;, javaType = java.lang.String.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;password&quot;, property = &quot;password&quot;, javaType = java.lang.String.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;user_name&quot;, property = &quot;userName&quot;, javaType = java.lang.String.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;driver_class_name&quot;, property = &quot;driverClassName&quot;, javaType = java.lang.String.class)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    List&lt;DataSourceProperty&gt; <span class="title function_">selectProperty</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在前面多数据源的加载并创建功能已经基本实现，需要在 SpringApplication 中导入 DynamicDataSourceRegister 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.datasource.DynamicDataSourceRegister;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ConfigurableApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Import;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Import(DynamicDataSourceRegister.class)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourcePointApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        context = SpringApplication.run(DataSourcePointApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里，项目连接不同数据源的数据库代码主体已经基本是实现了。下面需要实现数据源使用。</p>
<h2 id="3-项目连接不同数据源MySQL"><a href="#3-项目连接不同数据源MySQL" class="headerlink" title="3. 项目连接不同数据源MySQL"></a>3. 项目连接不同数据源MySQL</h2><blockquote>
<p>创建注解</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.datasource.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态使用数据源注解。</span></span><br><span class="line"><span class="comment"> * 作用在方法上，以方法的首个参数为 DataSource 的key，来进行选择 DataSource，</span></span><br><span class="line"><span class="comment"> * 如果首个参数不符合，那么将选择项目默认的(主)数据库</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DynamicDataSource &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">name</span><span class="params">()</span> <span class="keyword">default</span> MASTER;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MASTER</span> <span class="operator">=</span> <span class="string">&quot;master&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.datasource.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态使用数据源注解。</span></span><br><span class="line"><span class="comment"> * 作用在方法上，以注解传入的参数 name 为 key，来进行选择 DataSource，</span></span><br><span class="line"><span class="comment"> 如果参数 name 不符合，那么将选择项目默认的(主)数据库</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TargetDataSource &#123;</span><br><span class="line">    String <span class="title function_">name</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>编写切面</p>
</blockquote>
<p>虽然注解已经写好，不过对于这两个注解，还没关联到选择不同的数据源。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.datasource.aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.datasource.DynamicDataSourceContextHolder;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.datasource.annotation.DynamicDataSource;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在查询前，在查询前，根据注解 DynamicDataSource 的 name 设置为 DataSource 的 key，查询时获取到对应的 DataSource</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component(value = &quot;dynamicDataSourceAspect&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSourceAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(dataSource) &amp;&amp; args(dataSourceKey,..)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">datasource</span><span class="params">(DynamicDataSource dataSource, String dataSourceKey)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;datasource(dataSource, dataSourceKey)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">selectDataSource</span><span class="params">(ProceedingJoinPoint pjp, DynamicDataSource dataSource, String dataSourceKey)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DynamicDataSourceContextHolder.setDataSourceKey(dataSourceKey);</span><br><span class="line">            <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            DynamicDataSourceContextHolder.clearDataSourceKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.datasource.aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.datasource.DynamicDataSourceContextHolder;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.datasource.annotation.TargetDataSource;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.After;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在查询前，根据注解 TargetDataSource 的 name 设置为 DataSource 的 key，查询时获取到对应的 DataSource</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TargetDataSourceAspect</span> &#123;</span><br><span class="line">    <span class="meta">@Before(&quot;@annotation(ds)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeDataSource</span><span class="params">(JoinPoint point, TargetDataSource ds)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        DynamicDataSourceContextHolder.setDataSourceKey(ds.name());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;@annotation(ds)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">restoreDataSource</span><span class="params">(JoinPoint point, TargetDataSource ds)</span> &#123;</span><br><span class="line">        DynamicDataSourceContextHolder.clearDataSourceKey();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>SpringApplication 添加切面代理支持</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.datasource.DynamicDataSourceRegister;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ConfigurableApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Import;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Import(DynamicDataSourceRegister.class)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourcePointApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        context = SpringApplication.run(DataSourcePointApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里，对于项目使用多源数据库的实现思路已经基本定型（完成），下面编写几个测试接口，获取不同数据源下的信息。</p>
<h2 id="4-不同数据源连接测试"><a href="#4-不同数据源连接测试" class="headerlink" title="4. 不同数据源连接测试"></a>4. 不同数据源连接测试</h2><p>上面定义的 <code>TargetDataSource</code> 和 <code>DynamicDataSource</code> 注解，在 Repository 层&#x2F;Service 层 的方法中使用即可。这里测试例子是在 Repository 中使用的。</p>
<blockquote>
<p>创建实体类：getter、setter、constuctor等省略</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.example.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long birthday;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.example.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserLoveGame</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> userId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String gameName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.example.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserQq</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> userId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String account;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.example.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserSchool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer schoolId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String className;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String course;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.example.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserShopping</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> userId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String platform;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String shopName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> price;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>Repository</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.example.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.datasource.annotation.DynamicDataSource;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.datasource.annotation.TargetDataSource;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.example.dto.User;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.example.dto.UserLoveGame;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.example.dto.UserQq;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.example.dto.UserSchool;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.example.dto.UserShopping;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Result;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Results;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用不同数据源查询的 mapper</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Repository(value = &quot;userMapper&quot;)</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 默认数据源 */</span></span><br><span class="line">    <span class="meta">@Select(&quot;SELECT * FROM user&quot;)</span></span><br><span class="line">    List&lt;User&gt; <span class="title function_">selectUsers</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** dbKey 参数对应的数据源 */</span></span><br><span class="line">    <span class="meta">@Select(&quot;SELECT user_id, platform, shop_name, product_name, price FROM user_shopping&quot;)</span></span><br><span class="line">    <span class="meta">@Results(value = &#123;</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;user_id&quot;, property = &quot;userId&quot;, javaType = java.lang.Integer.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;platform&quot;, property = &quot;platform&quot;, javaType = java.lang.String.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;shop_name&quot;, property = &quot;shopName&quot;, javaType = java.lang.String.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;product_name&quot;, property = &quot;productName&quot;, javaType = java.lang.String.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;price&quot;, property = &quot;price&quot;, javaType = java.lang.Float.class)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="meta">@DynamicDataSource</span></span><br><span class="line">    List&lt;UserShopping&gt; <span class="title function_">selectAllUserShopping</span><span class="params">(String dbKey)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** dbKey 参数对应的数据源 */</span></span><br><span class="line">    <span class="meta">@Select(&quot;SELECT user_id, account, password, create_time, update_time FROM user_qq&quot;)</span></span><br><span class="line">    <span class="meta">@Results(value = &#123;</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;user_id&quot;, property = &quot;userId&quot;, javaType = java.lang.Integer.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;account&quot;, property = &quot;account&quot;, javaType = java.lang.String.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;password&quot;, property = &quot;password&quot;, javaType = java.lang.String.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;create_time&quot;, property = &quot;createTime&quot;, javaType = java.lang.String.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;update_time&quot;, property = &quot;updateTime&quot;, javaType = java.lang.String.class)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="meta">@DynamicDataSource</span></span><br><span class="line">    List&lt;UserQq&gt; <span class="title function_">selectAllUserQq</span><span class="params">(String dbKey)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** dbKey 参数对应的数据源 */</span></span><br><span class="line">    <span class="meta">@Select(&quot;SELECT user_id, game_name FROM user_love_game&quot;)</span></span><br><span class="line">    <span class="meta">@Results(value = &#123;</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;user_id&quot;, property = &quot;userId&quot;, javaType = java.lang.Integer.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;game_name&quot;, property = &quot;gameName&quot;, javaType = java.lang.String.class)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="meta">@DynamicDataSource</span></span><br><span class="line">    List&lt;UserLoveGame&gt; <span class="title function_">selectAllUserLoveGame</span><span class="params">(String dbKey)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** db_four 数据源 */</span></span><br><span class="line">    <span class="meta">@Select(&quot;SELECT name, school_id, user_id, class_name, course FROM school&quot;)</span></span><br><span class="line">    <span class="meta">@Results(value = &#123;</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;user_id&quot;, property = &quot;userId&quot;, javaType = java.lang.Integer.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;name&quot;, property = &quot;name&quot;, javaType = java.lang.String.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;school_id&quot;, property = &quot;schoolId&quot;, javaType = java.lang.Integer.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;class_name&quot;, property = &quot;className&quot;, javaType = java.lang.String.class),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;course&quot;, property = &quot;course&quot;, javaType = java.lang.String.class)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="meta">@TargetDataSource(name = &quot;db_four&quot;)</span></span><br><span class="line">    List&lt;UserSchool&gt; <span class="title function_">selectAllUserSchool</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>Service</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.example.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.example.dto.User;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.example.dto.UserLoveGame;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.example.dto.UserQq;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.example.dto.UserSchool;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.example.dto.UserShopping;</span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用不同数据源查询的 service</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(value = &quot;userService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;userMapper&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserMapper</span><span class="params">(UserMapper userMapper)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JSONArray <span class="title function_">selectUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectUsers();</span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        <span class="keyword">for</span> (User user : users) &#123;</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">jsonObj</span> <span class="operator">=</span> JSONObject.parseObject(JSONObject.toJSONString(user));</span><br><span class="line">            <span class="type">long</span> <span class="variable">birthday</span> <span class="operator">=</span> Long.parseLong(String.valueOf(jsonObj.get(<span class="string">&quot;birthday&quot;</span>))) * <span class="number">1000</span>;</span><br><span class="line">            jsonObj.put(<span class="string">&quot;birthday&quot;</span>, <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>(birthday)));</span><br><span class="line">            jsonArray.add(jsonObj);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jsonArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JSON <span class="title function_">selectAllUserShopping</span><span class="params">(String dbKey)</span> &#123;</span><br><span class="line">        List&lt;UserShopping&gt; userShoppingList = userMapper.selectAllUserShopping(dbKey);</span><br><span class="line">        <span class="type">String</span> <span class="variable">toJSONString</span> <span class="operator">=</span> JSONObject.toJSONString(userShoppingList);</span><br><span class="line">        <span class="keyword">return</span> (JSON) JSON.parse(toJSONString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JSON <span class="title function_">selectAllUserQq</span><span class="params">(String dbKey)</span> &#123;</span><br><span class="line">        List&lt;UserQq&gt; userQqs = userMapper.selectAllUserQq(dbKey);</span><br><span class="line">        <span class="type">String</span> <span class="variable">toJSONString</span> <span class="operator">=</span> JSONObject.toJSONString(userQqs);</span><br><span class="line">        <span class="keyword">return</span> (JSON) JSON.parse(toJSONString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JSONArray <span class="title function_">selectAllUserLoveGame</span><span class="params">(String dbKey)</span> &#123;</span><br><span class="line">        List&lt;UserLoveGame&gt; userLoveGameList = userMapper.selectAllUserLoveGame(dbKey);</span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">jsonArr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        <span class="keyword">for</span> (UserLoveGame userLoveGame : userLoveGameList) &#123;</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">jsonObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">            jsonObj.put(<span class="string">&quot;userId&quot;</span>, userLoveGame.getUserId());</span><br><span class="line">            jsonObj.put(<span class="string">&quot;loveGame&quot;</span>, JSONObject.parseObject(userLoveGame.getGameName()));</span><br><span class="line">            jsonArr.add(jsonObj);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jsonArr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JSONArray <span class="title function_">selectAllUserSchool</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;UserSchool&gt; userSchoolList = userMapper.selectAllUserSchool();</span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">jsonArr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        <span class="keyword">for</span> (UserSchool userSchool : userSchoolList) &#123;</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">jsonObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">            jsonObj.put(<span class="string">&quot;userId&quot;</span>, userSchool.getUserId());</span><br><span class="line">            jsonObj.put(<span class="string">&quot;schoolId&quot;</span>, userSchool.getSchoolId());</span><br><span class="line">            jsonObj.put(<span class="string">&quot;name&quot;</span>, userSchool.getName());</span><br><span class="line">            jsonObj.put(<span class="string">&quot;className&quot;</span>, userSchool.getClassName());</span><br><span class="line">            List&lt;String&gt; courseArr = JSON.parseArray(userSchool.getCourse(), String.class);</span><br><span class="line">            jsonObj.put(<span class="string">&quot;course&quot;</span>, JSONArray.toJSON(courseArr));</span><br><span class="line">            jsonArr.add(jsonObj);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jsonArr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>Controller</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.osys.dynamic.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.osys.dynamic.example.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;b&gt;&#123;<span class="doctag">@link</span> UserController&#125; Description&lt;/b&gt;: 测试查询</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;接口与数据源：</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;/user/select    ----&gt; 主数据源&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;/user/shopping  ----&gt; db_one 数据源&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;/user/qq        ----&gt; db_two 数据源&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;/user/game      ----&gt; db_three 数据源&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;/user/school      ----&gt; db_four 数据源&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Created by osys on 2022/08/29 16:59.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;userService&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserService</span><span class="params">(UserService userService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userService = userService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(method = RequestMethod.POST, path = &quot;/select&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">selectUser</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="comment">// 默认数据库</span></span><br><span class="line">        <span class="keyword">return</span> userService.selectUsers().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(method = RequestMethod.POST, path = &quot;/shopping&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">selectAllUserShopping</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="comment">// 数据库 key：db_one</span></span><br><span class="line">        <span class="keyword">return</span> userService.selectAllUserShopping(<span class="string">&quot;db_one&quot;</span>).toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(method = RequestMethod.POST, path = &quot;/qq&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">selectAllUserQq</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="comment">// 数据库 key：db_two</span></span><br><span class="line">        <span class="keyword">return</span> userService.selectAllUserQq(<span class="string">&quot;db_two&quot;</span>).toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(method = RequestMethod.POST, path = &quot;/game&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">selectAllUserLoveGame</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="comment">// 数据库 key：db_three</span></span><br><span class="line">        <span class="keyword">return</span> userService.selectAllUserLoveGame(<span class="string">&quot;db_three&quot;</span>).toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(method = RequestMethod.POST, path = &quot;/school&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">selectAllUserSchool</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="comment">// 数据库 key：db_four</span></span><br><span class="line">        <span class="keyword">return</span> userService.selectAllUserSchool().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>测试</p>
</blockquote>
<p>项目启动成功：</p>
<p><img src="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20221031195853.png" alt="20221031195853"></p>
<p>先后调用接口：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8888/user/select">http://localhost:8888/user/select</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:8888/user/shopping">http://localhost:8888/user/shopping</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:8888/user/qq">http://localhost:8888/user/qq</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:8888/user/game">http://localhost:8888/user/game</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:8888/user/school">http://localhost:8888/user/school</a></li>
</ul>
<p>控制台查看使用的数据源：</p>
<p><img src="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/posts/20221031195915.png" alt="20221031195915"></p>
<p>使用的数据源都是不一样的。去不同的MySQL数据库查询数据。</p>
<blockquote>
<p>附数据库信息</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">USE mysql;</span><br><span class="line">-- 主数据源</span><br><span class="line">CREATE SCHEMA IF NOT EXISTS point_connect_demo COLLATE utf8_general_ci;</span><br><span class="line">-- 其它数据源 ...</span><br><span class="line">CREATE SCHEMA IF NOT EXISTS dynamic_one_db COLLATE utf8_general_ci;</span><br><span class="line">CREATE SCHEMA IF NOT EXISTS dynamic_two_db COLLATE utf8_general_ci;</span><br><span class="line">CREATE SCHEMA IF NOT EXISTS dynamic_three_db COLLATE utf8_general_ci;</span><br><span class="line">CREATE SCHEMA IF NOT EXISTS dynamic_four_db COLLATE utf8_general_ci;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">USE point_connect_demo;</span><br><span class="line">CREATE TABLE IF NOT EXISTS user</span><br><span class="line">(</span><br><span class="line">    `id`        INT,</span><br><span class="line">    `user_name` VARCHAR(25),</span><br><span class="line">    `sex`       VARCHAR(5),</span><br><span class="line">    `birthday`  BIGINT,</span><br><span class="line">    `address`   VARCHAR(255)</span><br><span class="line">);</span><br><span class="line">INSERT INTO user(`id`, `user_name`, `sex`, `birthday`, `address`)</span><br><span class="line">VALUES (1, &#x27;name1&#x27;, &#x27;男&#x27;, 974698564, &#x27;中国*****1&#x27;),</span><br><span class="line">       (2, &#x27;name2&#x27;, &#x27;女&#x27;, 989658124, &#x27;中国*****2&#x27;),</span><br><span class="line">       (3, &#x27;name3&#x27;, &#x27;男&#x27;, 984088979, &#x27;中国*****3&#x27;),</span><br><span class="line">       (4, &#x27;name4&#x27;, &#x27;女&#x27;, 1031007815, &#x27;中国*****4&#x27;),</span><br><span class="line">       (5, &#x27;name5&#x27;, &#x27;男&#x27;, 936551363, &#x27;中国*****5&#x27;);</span><br><span class="line">-- 数据库连接信息</span><br><span class="line">CREATE TABLE IF NOT EXISTS connect_property</span><br><span class="line">(</span><br><span class="line">    `key`               VARCHAR(50) PRIMARY KEY,</span><br><span class="line">    `data_source_name`  VARCHAR(100),</span><br><span class="line">    `port`              VARCHAR(20),</span><br><span class="line">    `host`              VARCHAR(50),</span><br><span class="line">    `password`          VARCHAR(255),</span><br><span class="line">    `user_name`         VARCHAR(100),</span><br><span class="line">    `driver_class_name` VARCHAR(100)</span><br><span class="line">);</span><br><span class="line">INSERT INTO connect_property(`key`, `data_source_name`, `port`, `host`, `password`, `user_name`, `driver_class_name`)</span><br><span class="line">VALUES (&#x27;db_one&#x27;, &#x27;dynamic_one_db&#x27;, &#x27;3306&#x27;, &#x27;127.0.0.1&#x27;, &#x27;123456&#x27;, &#x27;root&#x27;, &#x27;com.mysql.cj.jdbc.Driver&#x27;),</span><br><span class="line">       (&#x27;db_two&#x27;, &#x27;dynamic_two_db&#x27;, &#x27;3306&#x27;, &#x27;127.0.0.1&#x27;, &#x27;123456&#x27;, &#x27;root&#x27;, &#x27;com.mysql.cj.jdbc.Driver&#x27;),</span><br><span class="line">       (&#x27;db_three&#x27;, &#x27;dynamic_three_db&#x27;, &#x27;3306&#x27;, &#x27;127.0.0.1&#x27;, &#x27;123456&#x27;, &#x27;root&#x27;, &#x27;com.mysql.cj.jdbc.Driver&#x27;),</span><br><span class="line">       (&#x27;db_four&#x27;, &#x27;dynamic_four_db&#x27;, &#x27;3306&#x27;, &#x27;127.0.0.1&#x27;, &#x27;123456&#x27;, &#x27;root&#x27;, &#x27;com.mysql.cj.jdbc.Driver&#x27;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">USE dynamic_one_db;</span><br><span class="line">CREATE TABLE IF NOT EXISTS user_shopping</span><br><span class="line">(</span><br><span class="line">    `user_id`      INT,</span><br><span class="line">    `platform`     VARCHAR(255),</span><br><span class="line">    `shop_name`    VARCHAR(255),</span><br><span class="line">    `product_name` VARCHAR(255),</span><br><span class="line">    `price`        FLOAT</span><br><span class="line">);</span><br><span class="line">INSERT INTO user_shopping(`user_id`, `platform`, `shop_name`, `product_name`, `price`)</span><br><span class="line">VALUES (1, &#x27;淘宝&#x27;, &#x27;**玩具店&#x27;, &#x27;奥特曼&#x27;, 20.99),</span><br><span class="line">       (2, &#x27;京东&#x27;, &#x27;**书店&#x27;, &#x27;钢铁是怎么练废的&#x27;, 19.49),</span><br><span class="line">       (3, &#x27;拼多多&#x27;, &#x27;**手机店&#x27;, &#x27;华为 mate plus max 50&#x27;, 6666.66),</span><br><span class="line">       (4, &#x27;天猫&#x27;, &#x27;**时装店&#x27;, &#x27;旺仔套装&#x27;, 199.9),</span><br><span class="line">       (5, &#x27;闲鱼&#x27;, &#x27;&#x27;, &#x27;闲置男朋友&#x27;, 99.99);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">USE dynamic_two_db;</span><br><span class="line">CREATE TABLE IF NOT EXISTS user_qq</span><br><span class="line">(</span><br><span class="line">    `user_id`     INT,</span><br><span class="line">    `account`     VARCHAR(255),</span><br><span class="line">    `password`    VARCHAR(255),</span><br><span class="line">    `create_time` VARCHAR(50),</span><br><span class="line">    `update_time` VARCHAR(50)</span><br><span class="line">);</span><br><span class="line">INSERT INTO user_qq(`user_id`, `account`, `password`, `create_time`, `update_time`)</span><br><span class="line">VALUES (1, &#x27;1***1&#x27;, &#x27;password1&#x27;, &#x27;2021-02-20 20:30:45&#x27;, &#x27;2022-08-16 17:58:11&#x27;),</span><br><span class="line">       (2, &#x27;1***2&#x27;, &#x27;password2&#x27;, &#x27;2021-10-23 05:30:01&#x27;, &#x27;2022-09-01 19:26:35&#x27;),</span><br><span class="line">       (3, &#x27;1***3&#x27;, &#x27;password3&#x27;, &#x27;2021-05-28 14:17:05&#x27;, &#x27;2022-08-31 14:19:59&#x27;),</span><br><span class="line">       (4, &#x27;1***4&#x27;, &#x27;password4&#x27;, &#x27;2020-09-06 18:45:45&#x27;, &#x27;2022-07-01 12:42:33&#x27;),</span><br><span class="line">       (5, &#x27;1***5&#x27;, &#x27;password5&#x27;, &#x27;2018-06-08 19:30:00&#x27;, &#x27;2022-09-02 15:37:27&#x27;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">USE dynamic_three_db;</span><br><span class="line">CREATE TABLE IF NOT EXISTS user_love_game</span><br><span class="line">(</span><br><span class="line">    `user_id`   INT,</span><br><span class="line">    `game_name` JSON</span><br><span class="line">);</span><br><span class="line">INSERT INTO user_love_game(`user_id`, `game_name`)</span><br><span class="line">VALUES (1, &#x27;&#123;&quot;game1:&quot;: &quot;lol&quot;, &quot;game2&quot;: &quot;dnf&quot;&#125;&#x27;),</span><br><span class="line">       (2, &#x27;&#123;&quot;game1:&quot;: &quot;cf&quot;, &quot;game2&quot;: &quot;dnf&quot;&#125;&#x27;),</span><br><span class="line">       (3, &#x27;&#123;&quot;game1:&quot;: &quot;lol&quot;, &quot;game2&quot;: &quot;cs&quot;&#125;&#x27;),</span><br><span class="line">       (4, &#x27;&#123;&quot;game1:&quot;: &quot;cs&quot;, &quot;game2&quot;: &quot;dnf&quot;&#125;&#x27;),</span><br><span class="line">       (5, &#x27;&#123;&quot;game1:&quot;: &quot;cs&quot;, &quot;game2&quot;: &quot;cf&quot;&#125;&#x27;);</span><br><span class="line"></span><br><span class="line">USE dynamic_four_db;</span><br><span class="line">CREATE TABLE IF NOT EXISTS school</span><br><span class="line">(</span><br><span class="line">    `name`       VARCHAR(64) NOT NULL,</span><br><span class="line">    `school_id`  INT         NOT NULL,</span><br><span class="line">    `user_id`    INT         NOT NULL,</span><br><span class="line">    `class_name` VARCHAR(64) NOT NULL,</span><br><span class="line">    `course`     TEXT        NULL</span><br><span class="line">);</span><br><span class="line">INSERT INTO school(`name`, `school_id`, `user_id`, `class_name`, `course`)</span><br><span class="line">VALUES (&#x27;第一中学&#x27;, 10001, 1, &#x27;高一(1)班&#x27;, &#x27;[&quot;Java&quot;,&quot;Python&quot;]&#x27;),</span><br><span class="line">       (&#x27;第一中学&#x27;, 10001, 2, &#x27;高二(3)班&#x27;, &#x27;[&quot;C&quot;,&quot;C++&quot;]&#x27;),</span><br><span class="line">       (&#x27;第二中学&#x27;, 10001, 3, &#x27;高一(5)班&#x27;, &#x27;[&quot;Linux&quot;,&quot;Scala&quot;]&#x27;),</span><br><span class="line">       (&#x27;第二中学&#x27;, 10001, 4, &#x27;高二(7)班&#x27;, &#x27;[&quot;语数英&quot;,&quot;数理化&quot;,&quot;德智体美劳&quot;]&#x27;),</span><br><span class="line">       (&#x27;第二中学&#x27;, 10001, 5, &#x27;高三(9)班&#x27;, &#x27;[&quot;大数据&quot;,&quot;人工智能&quot;]&#x27;);</span><br></pre></td></tr></table></figure>


</div><div class="article-licensing box"><div class="licensing-title"><p>SpringBoot项目连接多源MySQL数据库</p><p><a href="https://osys.github.io/posts/b56a.html">https://osys.github.io/posts/b56a.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Osys</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022年10月31日</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022年10月31日</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/SpringBoot/">SpringBoot</a><a class="link-muted mr-2" rel="tag" href="/tags/Java/">Java</a><a class="link-muted mr-2" rel="tag" href="/tags/MySQL/">MySQL</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/posts/6ccd.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Redis 分布式锁的实现</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/posts/661c.html"><span class="level-item">Java并发编程实战</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "947651d035300375e816d712adca16eb",
            repo: "osys.github.io",
            owner: "osys",
            clientID: "e0f10cf0c934d445e79f",
            clientSecret: "3dad6d25224fe45db31a3a912756bd5175e3a70f",
            admin: ["osys"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-8-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#1-普通的-SpringBoot-项目"><span class="level-left"><span class="level-item">1. 普通的 SpringBoot 项目</span></span></a></li><li><a class="level is-mobile" href="#2-实现思路"><span class="level-left"><span class="level-item">2. 实现思路</span></span></a></li><li><a class="level is-mobile" href="#3-项目连接不同数据源MySQL"><span class="level-left"><span class="level-item">3. 项目连接不同数据源MySQL</span></span></a></li><li><a class="level is-mobile" href="#4-不同数据源连接测试"><span class="level-left"><span class="level-item">4. 不同数据源连接测试</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/basic/avatar.png" alt="Osys"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Osys</p><p class="is-size-6 is-block">去喝粥吧，无情的Bug。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>GuangZhou</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">31</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">5</p></a></div></div></nav></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">29</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%A1%B9%E7%9B%AE%E6%A1%88%E4%BE%8B/"><span class="level-start"><span class="level-item">项目案例</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><span class="tag">Java并发编程</span><span class="tag">29</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringBoot/"><span class="tag">SpringBoot</span><span class="tag">2</span></a></div></div></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">29</span></span></a></li></ul></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.cnblogs.com/liyihua/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">我的博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/qq_44830823?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">我的CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><p><img src="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png" alt="LeeHua的博客" height="28"><href src="https://osyss.com"> 数据开发猿</href>  ~~~~~~~~~~~~~~~~~~~~~~~~~  @世间美好与大家环环相扣@  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</p>---------------------------------------------------------------------------------------------------------------------------------------------------------------------------<p><a href="https://beian.miit.gov.cn/" target="_blank">备案号: 粤ICP备2022104988号</a>【<a href="https://github.com/" target="_blank">网站: 挂载于 github + 腾讯云</a>】 【<a href="https://github.com/" target="_blank">图片: 挂载于 github</a>】 【<a href="https://www.jsdelivr.com/github" target="_blank">CDN: jsDelivr</a>】</p></a><p class="is-size-7"><script src="https://sdk.51.la/perf/js-sdk-pro.min.js" crossorigin="anonymous"></script><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js?id=JoDQdGZeB7Cy04AN&amp;ck=JoDQdGZeB7Cy04AN"></script><a target=" blank" title="网站统计" href="https://v6.51.la/land/JoDQdGZeB7Cy04AN"></a><script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoDQdGZeB7Cy04AN/quote.js?theme=0&amp;f=12&amp;display=0,1,1,1,1,1,0,1"></script></p>---------------------------------------------------------------------------------------------------------------------------------------------------------------------------</div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="粤ICP备2022104988号-1" href="https://beian.miit.gov.cn/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Blog on GitHub" href="https://github.com/osys/osys.github.io/"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container" id="algolia-input"></div><div id="algolia-poweredby" style="display:flex;margin:0 .5em 0 1em;align-items:center;line-height:0"></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div><div class="searchbox-footer"></div></div></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.0.3/dist/algoliasearch-lite.umd.js" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.3.1/dist/instantsearch.production.min.js" crossorigin="anonymous" defer></script><script src="/js/algolia.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadAlgolia({"applicationId":"8FPI8CDLJR","apiKey":"702cfc5bf8397419842065704ec39904","indexName":"github_pages_hexo_blog"}, {"hint":"想要查找什么...","no_result":"未找到搜索结果","untitled":"(无标题)","empty_preview":"(无内容预览)"});
        });</script></body></html>