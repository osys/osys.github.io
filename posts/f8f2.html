<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Java并发编程实战：第4章 组合对象 - LeeHua&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="LeeHua&#039;s Blog"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="LeeHua&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="1. 设计线程安全的类尽管将所有的状态都存储在公共静态域中，仍然能写出线程安全的程序。 在没有进行全局检查的情况下，封装能够保证类的线程安全性。 设计线程安全类的过程应该包括下面3个基本要素：  确定对象状态是由哪些变量构成的； 确定限制状态变量的不变约束； 制定一个管理并发访问对象状态的策略。"><meta property="og:type" content="blog"><meta property="og:title" content="Java并发编程实战：第4章 组合对象"><meta property="og:url" content="https://osys.github.io/"><meta property="og:site_name" content="Osys&#039;s Blog"><meta property="og:description" content="1. 设计线程安全的类尽管将所有的状态都存储在公共静态域中，仍然能写出线程安全的程序。 在没有进行全局检查的情况下，封装能够保证类的线程安全性。 设计线程安全类的过程应该包括下面3个基本要素：  确定对象状态是由哪些变量构成的； 确定限制状态变量的不变约束； 制定一个管理并发访问对象状态的策略。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://osys.github.io/img/og_image.png"><meta property="article:published_time" content="2022-08-29T14:07:04.000Z"><meta property="article:modified_time" content="2022-08-29T14:40:44.000Z"><meta property="article:author" content="Osys"><meta property="article:tag" content="Java并发编程"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://osys.github.io/"},"headline":"LeeHua's Blog","image":["https://osys.github.io/img/og_image.png"],"datePublished":"2022-08-29T14:07:04.000Z","dateModified":"2022-08-29T14:40:44.000Z","author":{"@type":"Person","name":"Osys"},"publisher":{"@type":"Organization","name":"Osys","logo":{"@type":"ImageObject","url":"https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"}},"description":"一路生花"}</script><link rel="canonical" href="https://osys.github.io/posts/f8f2.html"><link rel="alternate" href="/path/to/atom.xml" title="LeeHua&#039;s Blog" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?44cd31785e14a1fdaad0921651759e0f";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><script src="/js/runtime.js"></script><meta name="generator" content="Hexo 6.0.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png" alt="LeeHua&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-08-29T14:07:04.000Z" title="8/29/2022, 2:07:04 PM">2022年08月29日</time>发表</span><span class="level-item"><time dateTime="2022-08-29T14:40:44.000Z" title="8/29/2022, 2:40:44 PM">2022年08月29日</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Java/">Java</a></span><span class="level-item">34 分钟读完 (大约5100个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Java并发编程实战：第4章 组合对象</h1><div class="content"><h1 id="1-设计线程安全的类"><a href="#1-设计线程安全的类" class="headerlink" title="1. 设计线程安全的类"></a>1. 设计线程安全的类</h1><p>尽管将所有的状态都存储在公共静态域中，仍然能写出线程安全的程序。</p>
<p>在没有进行全局检查的情况下，封装能够保证类的线程安全性。</p>
<p>设计线程安全类的过程应该包括下面3个基本要素：</p>
<ul>
<li>确定对象状态是由哪些变量构成的；</li>
<li>确定限制状态变量的不变约束；</li>
<li>制定一个管理并发访问对象状态的策略。</li>
</ul>
<span id="more"></span>

<h2 id="1-1-同步策略-Synchronization-Policy"><a href="#1-1-同步策略-Synchronization-Policy" class="headerlink" title="1.1 同步策略(Synchronization Policy)"></a>1.1 同步策略(Synchronization Policy)</h2><p>定义了对象如何协调对其状态的访问，并且不会违反它的不便约束或验证条件。</p>
<p>使用 Java 监视器模式的简单线程安全计数器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.GuardedBy;</span><br><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value == Long.MAX_VALUE) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;counter overflow&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ++value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="1-2-收集同步需求"><a href="#1-2-收集同步需求" class="headerlink" title="1.2 收集同步需求"></a>1.2 收集同步需求</h2><p>对象与变量拥有一个 <strong>状态空间</strong> ：这个空间即 <code>它们可能处于状态的范围</code>。</p>
<p>例如上面的：<code>Counter</code> 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// long 类型数据限制其范围是 Long.MIN_VALUE 到 Long.MAX_VALUE</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">0</span>;			<span class="comment">// 限制了 value 的值必须是正值</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (value == Long.MAX_VALUE) &#123;			<span class="comment">// 是否非法</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;counter overflow&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ++value;</span><br></pre></td></tr></table></figure>

<p>类似地，操作的后验条件会指出某种 <strong>状态转换(state transitions)</strong> 是非法的</p>
<p><code>不变约束</code> 与 <code>后验条件</code> 施加在状态及状态转换上的约束，引入了额外的同步与封装的需要。</p>
<h2 id="1-3-状态依赖的操作"><a href="#1-3-状态依赖的操作" class="headerlink" title="1.3 状态依赖的操作"></a>1.3 状态依赖的操作</h2><ul>
<li>类的 <strong>不变约束</strong> 与方法的 <strong>后验条件</strong> 约束了对象 <code>合法的状态</code> 和 <code>合法状态转换</code></li>
<li>对象的方法也可以有 <code>先验条件</code>。如无法从空队列中移除一个条目。</li>
<li>单线程中，操作如果无法满足 <code>先验条件</code> 必然失败。</li>
<li>多线程中，原本为 <code>假</code> 的先验条件，可能会由于其它线程的活动变为 <code>真</code>。</li>
</ul>
<p>在并发程序中，有<strong>持续等待, 直到先验条件为真</strong>，再继续处理的操作。在 Java 中，等待特定条件成立的内置高效机制 <code>wait</code> 和 <code>notify</code> 与内部锁紧密地绑定在一起。</p>
<h2 id="1-4-状态所有权"><a href="#1-4-状态所有权" class="headerlink" title="1.4 状态所有权"></a>1.4 状态所有权</h2><ul>
<li><p>在很多情况下，<code>所有权</code>与<code>封裝性</code>总是在一起出现的。</p>
</li>
<li><p>对象封装它拥有的状态，且拥有它封装的状态。拥有给定状态的所有者决定了锁协议，该协议用于维护变量状态的完整性。</p>
</li>
<li><p>所有权意味着<code>控制权</code>，不过一旦将引用发布到一个可变对象上，就不再拥有独占的控制权，充其量只可能有<code>共享控制权</code>。</p>
</li>
<li><p>类通常不会拥有由构造函数或方法传递进来的对象，除非该方法是被明确设计用来转换传递对象的所有权的（比如同步容器的包装<code>工厂方法</code>)。</p>
</li>
</ul>
<h1 id="2-实例限制"><a href="#2-实例限制" class="headerlink" title="2. 实例限制"></a>2. 实例限制</h1><h2 id="2-1-实例限制"><a href="#2-1-实例限制" class="headerlink" title="2.1 实例限制"></a>2.1 实例限制</h2><p>即使一个对象不是线程安全的，仍然有许多技术可以让它安全地用于多线程程序。</p>
<p>比如，你可以确保它只被<code>单一线程访问</code>（线程限制），也可以确保所有的访问都<code>正确地被锁保护</code>。</p>
<p>通过使用<code>实例限制 (instance confinement)</code>，封装简化了类的线程安全化工作，这通常称为<code>限制</code>。</p>
<p>将数据封装在对象内部，把对数据的访问限制在对象的方法上，更易确保线程在访问数据时总能获得正确的锁。</p>
<p>使用限制确保线程安全：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.GuardedBy;</span><br><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PersonSet</span> &#123;</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Person&gt; mySet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">addPerson</span><span class="params">(Person p)</span> &#123;</span><br><span class="line">        mySet.add(p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">containsPerson</span><span class="params">(Person p)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mySet.contains(p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-2-Java-监视器模式-Java-monitor-pattern"><a href="#2-2-Java-监视器模式-Java-monitor-pattern" class="headerlink" title="2.2 Java 监视器模式(Java monitor pattern)"></a>2.2 Java 监视器模式(Java monitor pattern)</h2><ul>
<li><p><code>线程限制原则</code>的直接推论之一是<code>Java 监视器模式</code>。</p>
</li>
<li><p>遵循<code>Java监视器模式</code>的对象封裝了所有的可变状态，并由对象自己的内部锁保护。</p>
</li>
<li><p>Java的<code>内置锁</code>有时也被叫做<code>监视器锁</code>(monitor locks) 或<code>监视器</code>(monitors)</p>
</li>
<li><p><code>Counter</code> 演示了这个模式的典型案例：</p>
<p>  Counter 封裝了一个状态变量value，所有对该变最的访问都要通过 Counter 的方法，这些方法都是同步的。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.GuardedBy;</span><br><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value == Long.MAX_VALUE) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;counter overflow&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ++value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>私有锁保护状态：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> apple.laf.JRSUIConstants;</span><br><span class="line"><span class="keyword">import</span> net.jcip.annotations.GuardedBy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivateLock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">myLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;myLock&quot;)</span></span><br><span class="line">    JRSUIConstants.Widget widget;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">someMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (myLock) &#123;</span><br><span class="line">            <span class="comment">// 访问或修改 widget 的状态</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用私有锁对象，而不是对象的内部锁（或任何其他可公共访问的锁），有很多好处。</li>
<li>私有的锁对象可以封装锁，这样客户代码无法得到它。</li>
<li>可公共访问的锁允许客户代码涉足它的同步策略 —- 正确地或不正确地。<ul>
<li>客户不正确地得到另一个对象的锁，会引起活跃度方面的问题。</li>
<li>另外要验证程序是正确地使用着一个可公共访问的锁，需要检查完整的程序，而不是一个单独的类。</li>
</ul>
</li>
</ul>
<h2 id="2-3-机动车追踪器-tracking-fleet-vehicle"><a href="#2-3-机动车追踪器-tracking-fleet-vehicle" class="headerlink" title="2.3 机动车追踪器(tracking fleet vehicle)"></a>2.3 机动车追踪器(tracking fleet vehicle)</h2><p>每一辆机动车都有一个 string 标识，并有一个与之对应的位置(x，y)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.Point;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 机动车追踪器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelegatingVehicleTracker</span> &#123;</span><br><span class="line">    <span class="comment">/** 机动车位置 */</span></span><br><span class="line">    <span class="keyword">private</span> ConcurrentMap&lt;String, Point&gt; locations;</span><br><span class="line">    <span class="comment">/** 机动车位置(不可修改的，即最初位置) */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Point&gt; unmodifiableMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DelegatingVehicleTracker</span><span class="params">(Map&lt;String, Point&gt; points)</span> &#123;</span><br><span class="line">        locations = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, Point&gt;(points);</span><br><span class="line">        unmodifiableMap = Collections.unmodifiableMap(locations);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 所有机动车位置(不可变的) */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Point&gt; <span class="title function_">getLocations</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> unmodifiableMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 某机动车位置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 机动车 id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 机动车位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Point <span class="title function_">getLocation</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> locations.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改机动车位置(需要存在该机动车)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 机动车 id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x 机动车 x 坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> y 机动车 y 坐标</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLocation</span><span class="params">(String id, <span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (locations.replace(id, <span class="keyword">new</span> <span class="title class_">Point</span>(x, y)) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;车辆名称无效: &quot;</span> + id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 机动车移动</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> evt 机动车移动事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vehicleMoved</span><span class="params">(VehicleMovedEvent evt)</span> &#123;</span><br><span class="line">        <span class="comment">// 位置</span></span><br><span class="line">        <span class="type">Point</span> <span class="variable">local</span> <span class="operator">=</span> evt.point;</span><br><span class="line">        <span class="comment">// 修改机动车位置(需要存在该机动车)</span></span><br><span class="line">        setLocation(evt.vehicleId, local.x, local.y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 所有机动车位置(可变的) */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Point&gt; <span class="title function_">getLocationsAsStatic</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableMap(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Point&gt;(locations));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打印机动车位置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> vehicleId 机动车id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> local 机动车位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">renderVehicle</span><span class="params">(String vehicleId, Point local)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;机动车 &quot;</span> + vehicleId + <span class="string">&quot; 位置：&quot;</span> + local);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 机动车移动事件 */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">VehicleMovedEvent</span> &#123;</span><br><span class="line">        Point point;</span><br><span class="line">        String vehicleId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">VehicleMovedEvent</span><span class="params">(Point point, String vehicleId)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.point = point;</span><br><span class="line">            <span class="built_in">this</span>.vehicleId = vehicleId;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="3-委托线程安全"><a href="#3-委托线程安全" class="headerlink" title="3. 委托线程安全"></a>3. 委托线程安全</h1><h2 id="3-1-基于监视器的机动车追踪器实现"><a href="#3-1-基于监视器的机动车追踪器实现" class="headerlink" title="3.1 基于监视器的机动车追踪器实现"></a>3.1 基于监视器的机动车追踪器实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.GuardedBy;</span><br><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于监视器的机动车追踪器实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonitorVehicleTracker</span> &#123;</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, MutablePoint&gt; locations;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MonitorVehicleTracker</span><span class="params">(Map&lt;String, MutablePoint&gt; locations)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.locations = deepCopy(locations);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> Map&lt;String, MutablePoint&gt; <span class="title function_">getLocations</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> deepCopy(locations);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> MutablePoint <span class="title function_">getLocation</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="type">MutablePoint</span> <span class="variable">loc</span> <span class="operator">=</span> locations.get(id);</span><br><span class="line">        <span class="type">return</span> <span class="variable">loc</span> <span class="operator">=</span>= <span class="literal">null</span> ? <span class="literal">null</span> : <span class="keyword">new</span> <span class="title class_">MutablePoint</span>(loc);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setLocation</span><span class="params">(String id, <span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">        <span class="type">MutablePoint</span> <span class="variable">loc</span> <span class="operator">=</span> locations.get(id);</span><br><span class="line">        <span class="keyword">if</span> (loc == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;No such ID: &quot;</span> + id);</span><br><span class="line">        &#125;</span><br><span class="line">        loc.x = x;</span><br><span class="line">        loc.y = y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 深拷贝一个机动车追踪器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> m 机动车追踪器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 深拷贝后的机动车追踪器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, MutablePoint&gt; <span class="title function_">deepCopy</span><span class="params">(Map&lt;String, MutablePoint&gt; m)</span> &#123;</span><br><span class="line">        Map&lt;String, MutablePoint&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(m.size());</span><br><span class="line">        <span class="keyword">for</span> (String id : m.keySet()) &#123;</span><br><span class="line">            result.put(id, <span class="keyword">new</span> <span class="title class_">MutablePoint</span>(m.get(id)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 深拷贝后，返回一个不可修改的 Map</span></span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableMap(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-2-将现场安全委托到-ConcurrentHashMap"><a href="#3-2-将现场安全委托到-ConcurrentHashMap" class="headerlink" title="3.2 将现场安全委托到 ConcurrentHashMap"></a>3.2 将现场安全委托到 ConcurrentHashMap</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.Point;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 机动车追踪器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelegatingVehicleTracker</span> &#123;</span><br><span class="line">    <span class="comment">/** 机动车位置 */</span></span><br><span class="line">    <span class="keyword">private</span> ConcurrentMap&lt;String, Point&gt; locations;</span><br><span class="line">    <span class="comment">/** 机动车位置(不可修改的，即最初位置) */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Point&gt; unmodifiableMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DelegatingVehicleTracker</span><span class="params">(Map&lt;String, Point&gt; points)</span> &#123;</span><br><span class="line">        locations = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, Point&gt;(points);</span><br><span class="line">        unmodifiableMap = Collections.unmodifiableMap(locations);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 所有机动车位置(不可变的) */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Point&gt; <span class="title function_">getLocations</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> unmodifiableMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 某机动车位置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 机动车 id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 机动车位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Point <span class="title function_">getLocation</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> locations.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改机动车位置(需要存在该机动车)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 机动车 id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x 机动车 x 坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> y 机动车 y 坐标</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLocation</span><span class="params">(String id, <span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (locations.replace(id, <span class="keyword">new</span> <span class="title class_">Point</span>(x, y)) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;车辆名称无效: &quot;</span> + id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 机动车移动</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> evt 机动车移动事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vehicleMoved</span><span class="params">(VehicleMovedEvent evt)</span> &#123;</span><br><span class="line">        <span class="comment">// 位置</span></span><br><span class="line">        <span class="type">Point</span> <span class="variable">local</span> <span class="operator">=</span> evt.point;</span><br><span class="line">        <span class="comment">// 修改机动车位置(需要存在该机动车)</span></span><br><span class="line">        setLocation(evt.vehicleId, local.x, local.y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 所有机动车位置(可变的) */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Point&gt; <span class="title function_">getLocationsAsStatic</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableMap(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Point&gt;(locations));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打印机动车位置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> vehicleId 机动车id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> local 机动车位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">renderVehicle</span><span class="params">(String vehicleId, Point local)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;机动车 &quot;</span> + vehicleId + <span class="string">&quot; 位置：&quot;</span> + local);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 机动车移动事件 */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">VehicleMovedEvent</span> &#123;</span><br><span class="line">        Point point;</span><br><span class="line">        String vehicleId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">VehicleMovedEvent</span><span class="params">(Point point, String vehicleId)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.point = point;</span><br><span class="line">            <span class="built_in">this</span>.vehicleId = vehicleId;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-3-非状态依赖变量"><a href="#3-3-非状态依赖变量" class="headerlink" title="3.3 非状态依赖变量"></a>3.3 非状态依赖变量</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.awt.event.KeyListener;</span><br><span class="line"><span class="keyword">import</span> java.awt.event.MouseListener;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CopyOnWriteArrayList;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 委托线程安全到多个底层的状态变量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VisualComponent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;KeyListener&gt; keyListeners = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;MouseListener&gt; mouseListeners = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addKeyListener</span><span class="params">(KeyListener listener)</span> &#123;</span><br><span class="line">        keyListeners.add(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMouseListener</span><span class="params">(MouseListener listener)</span> &#123;</span><br><span class="line">        mouseListeners.add(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeKeyListener</span><span class="params">(KeyListener listener)</span> &#123;</span><br><span class="line">        keyListeners.remove(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeMouseListener</span><span class="params">(MouseListener listener)</span> &#123;</span><br><span class="line">        mouseListeners.remove(listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>VisualComponent</code> 使用 <code>CopyOnWriteArrayList</code> 存储每个监听器清单。</p>
<p>在 VisualComponent 中，不但每个 List 是线程安全的，而且不存在哪个不变约束会增加一个状态与另一个状态间的耦合，所以 VisualComponent 可以将它的线程安全贵任委托到 MouseListener 和 KeyListener 对象上。</p>
<h2 id="3-4-不完整地保护不变约束"><a href="#3-4-不完整地保护不变约束" class="headerlink" title="3.4 不完整地保护不变约束"></a>3.4 不完整地保护不变约束</h2><p>NumberRange 不是线程安全的；它没有保护好用于约東 lower 和 upper 的不变约束。</p>
<p>setLower 和 setupper 都是<code>检查再运行</code>的操作，但是它们没有适当地加锁以保证其原子性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * NumberRange 类没有完整地保护它的不变约束</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NumberRange</span> &#123;</span><br><span class="line">    <span class="comment">/** 不变约束: lower &lt;= upper */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">lower</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">upper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 设置最低 number */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLower</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="comment">// 警告 -- 不安全的 &quot;检查再运行&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (i &gt; upper.get()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;can&#x27;t set lower to &quot;</span> + i + <span class="string">&quot; &gt; upper&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        lower.set(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 设置最高 number */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpper</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="comment">// 警告 -- 不安全的 &quot;检查再运行&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (i &lt; lower.get()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;can&#x27;t set upper to &quot;</span> + i + <span class="string">&quot; &lt; lower&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        upper.set(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断 i 是否满足 lower &lt;= i &lt;= upper</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true or false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isInRange</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (i &gt;= lower.get() &amp;&amp; i &lt;= upper.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果类中还存在复合操作，如 setLower 和 setupper，类必须提供它自身有的锁以保证复合操作都是原子的。</p>
<p>除非所有的操作可以委托给一个状态变量。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * NumberRange2 类完整地保护它的不变约束</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NumberRange2</span> &#123;</span><br><span class="line">    <span class="comment">/** 不变约束: lower &lt;= upper */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;RangeNum&gt; lowerAndUpper = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">RangeNum</span>(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 设置最低 number */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLower</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        lowerAndUpper.set(<span class="keyword">new</span> <span class="title class_">RangeNum</span>(i, lowerAndUpper.get().upper));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 设置最高 number */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpper</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        lowerAndUpper.set(<span class="keyword">new</span> <span class="title class_">RangeNum</span>(lowerAndUpper.get().lower, i));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断 i 是否满足 lower &lt;= i &lt;= upper</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true or false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isInRange</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (i &gt;= lowerAndUpper.get().lower &amp;&amp; i &lt;= lowerAndUpper.get().upper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">RangeNum</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> lower;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> upper;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">RangeNum</span><span class="params">(<span class="type">int</span> lower, <span class="type">int</span> upper)</span> &#123;</span><br><span class="line">            <span class="comment">// 警告 -- 不安全的 &quot;检查再运行&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (upper &lt; lower) &#123;<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;upper must be greater than or equal to lower!&quot;</span>);&#125;</span><br><span class="line">            <span class="built_in">this</span>.lower = lower;</span><br><span class="line">            <span class="built_in">this</span>.upper = upper;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-5-发布底层的状态变量"><a href="#3-5-发布底层的状态变量" class="headerlink" title="3.5 发布底层的状态变量"></a>3.5 发布底层的状态变量</h2><p>如果一个状态变量是线程安金的，没有任何不变约束限制它的值，并且没有任何状态转换限制它的操作，那么它可以被安全发布。</p>
<p>发布了状态的机动车追踪器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.GuardedBy;</span><br><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PublishingVehicleTracker</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, SafePoint&gt; locations;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, SafePoint&gt; unmodifiableMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PublishingVehicleTracker</span><span class="params">(Map&lt;String, SafePoint&gt; locations)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.locations = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(locations);</span><br><span class="line">        <span class="built_in">this</span>.unmodifiableMap = Collections.unmodifiableMap(<span class="built_in">this</span>.locations);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, SafePoint&gt; <span class="title function_">getLocations</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> unmodifiableMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SafePoint <span class="title function_">getLocation</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> locations.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLocation</span><span class="params">(String id, <span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!locations.containsKey(id)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;invalid vehicle name: &quot;</span> + id);</span><br><span class="line">        &#125;</span><br><span class="line">        locations.get(id).set(x, y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ThreadSafe</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">SafePoint</span> &#123;</span><br><span class="line">        <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> x, y;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SafePoint</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.set(x, y);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">SafePoint</span><span class="params">(<span class="type">int</span>[] a)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>(a[<span class="number">0</span>], a[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SafePoint</span><span class="params">(SafePoint p)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>(p.get());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span>[] get() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;x, y&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.x = x;</span><br><span class="line">            <span class="built_in">this</span>.y = y;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>PublishingVehicleTracker 的线程安全性源自于它所委托的底层 ConcurrentHashMap。</li>
<li>不过这次 Map 的内容是<code>线程安全的可变 SafePoint</code>，而非不可变的。 </li>
<li>getLocation 方法返回底层 Map 的<code>不可变拷贝</code>，调用者在其上无法添加或移除车辆，却可以通过修改返回的 Map 中 SafePoint 的值，改变一个机动车的位置。</li>
<li>只有 PublishingVehicleTracker 对<code>机动车追踪器的合法值</code>没有施加任何额外的约束时，它才是线程安全的。</li>
<li>如果需要对机动车的 <code>location</code> 的改变(<code>setLocation()</code>)进行判断或者执行一些其他的操作，那么 PublishingVehicleTracker 的做法可能就不正确了.</li>
</ul>
<h1 id="4-向已有的线程安全类添加功能"><a href="#4-向已有的线程安全类添加功能" class="headerlink" title="4. 向已有的线程安全类添加功能"></a>4. 向已有的线程安全类添加功能</h1><h2 id="4-1-向已有的线程安全类添加功能"><a href="#4-1-向已有的线程安全类添加功能" class="headerlink" title="4.1 向已有的线程安全类添加功能"></a>4.1 向已有的线程安全类添加功能</h2><ul>
<li><p>Java 类库中包含了很多有用的 <code>构建块</code> 类。<code>重用</code>这些已有的类要好于创建一个新的。重用能够降低开发的难度、风和维护成本。</p>
</li>
<li><p>有时一个线程安全类支持我们需要的全部操作，但更多时候，一个类只支持我们需要的大部分操作，这时我们需要在不破坏其线程安全性的前提下，向它添加一个新的操作。</p>
</li>
<li><p>修改原始的类</p>
<ol>
<li>添加一个新原子操作的最安全的方式是，<code>修改原始的类</code>，以支持期望的操作。</li>
<li>但是你可能无法访问源代码或者没有修改的自由，所以这通常是不可能的。</li>
<li>即使你可以修改原始的类，也需要理解其实现的同步策略，才能在维持原有设计的前提下完善它的功能。</li>
<li>直接向类中加入新方法，意味着所有实现类同步策略的代码仍然包含在一个源代码文件中，因此便于理解与维护。</li>
</ol>
</li>
<li><p>扩展这个类</p>
<ol>
<li><p>另一种方法是<code>扩展这个类</code>，假如这个类在设计上是可以扩展的。如：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Vector;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BetterVector</span> &lt;E&gt; <span class="keyword">extends</span> <span class="title class_">Vector</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="comment">/** 扩展可序列化类时，应重新定义 serialVersionUID */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">3963416950630760754L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">putIfAbsent</span><span class="params">(E x)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">absent</span> <span class="operator">=</span> !contains(x);</span><br><span class="line">        <span class="keyword">if</span> (absent) &#123;</span><br><span class="line">            add(x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> absent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p>扩展后，同步策略的实现会被分布到多个独立维护的源代码(<code>.class</code>)文件中，所以扩展一个类比直接在类中加入代码更脆弱。</p>
</li>
<li><p>如果低层的类选择了不同的锁保护它的状态变量，从而会改变它的同步策略，子类就在不知不觉中被破坏，因为它不能再用<code>正确的锁控制</code>对基类状态的并发访问。</p>
</li>
</ol>
</li>
</ul>
<h2 id="4-2-客户端加锁"><a href="#4-2-客户端加锁" class="headerlink" title="4.2 客户端加锁"></a>4.2 客户端加锁</h2><p>创建一个助手类，该助手类包含一个作用于线程安全 List 的原子 <code>缺少即加入</code> 的操作。</p>
<ol>
<li><p>非线程安全的 “缺少即加入” 实现（不要这样做）</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotThreadSafe</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BadListHelper</span> &lt;E&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;E&gt; list = Collections.synchronizedList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;E&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">putIfAbsent</span><span class="params">(E x)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">absent</span> <span class="operator">=</span> !list.contains(x);</span><br><span class="line">        <span class="keyword">if</span> (absent) &#123;</span><br><span class="line">            list.add(x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> absent;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================</span></span><br><span class="line">    <span class="comment">// 等等有关操作 list 的其它方法</span></span><br><span class="line">    <span class="comment">// =========================</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这里是并不能保证对 <code>list</code> 的操作是线程安全的，即使使用了同步修饰 <code>putIfAbsent()</code> 方法。</p>
<p> 虽然对 <code>putIfAbsent()</code> 加了内置锁，但是这仅仅限制同一时间仅有单一线程调用此方法。</p>
<p> 我们并不能保证其它线程调用 <code>BadListHelper</code> 的其它方法，对 <code>list</code> 进行操作。即使其它方法也都是用了内置锁。</p>
</li>
<li><p>使用客户端加锁实现的 “缺少即加入”</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GoodListHelper</span> &lt;E&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;E&gt; list = Collections.synchronizedList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;E&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">putIfAbsent</span><span class="params">(E x)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">absent</span> <span class="operator">=</span> !list.contains(x);</span><br><span class="line">            <span class="keyword">if</span> (absent) &#123;</span><br><span class="line">                list.add(x);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> absent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================</span></span><br><span class="line">    <span class="comment">// 等等有关操作 list 的其它方法</span></span><br><span class="line">    <span class="comment">// =========================</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 线程安全</p>
</li>
</ol>
<ul>
<li>如果说，为了添加另一个原子操作而去扩展一个类(扩展类加锁)容易出问题，是因为它将加锁的代码分布到了继承体系中的多个类里。</li>
<li>然而客户端加锁其实是更加脆弱的，因为它必须将<code>类 a.class</code>中的加锁代码置入与<code>a.class</code>完全无关的类中。</li>
<li>在那些<code>不关注锁策略</code>的类中使用客户端加锁时，一定要小心。客户端加锁与扩展类有很多共同之处：所得类的行为与基类的实现之间都存在耦合。正如同扩展会破坏实现的封装性一样，客户端加锁会破坏同步策略的封装性。</li>
</ul>
<h2 id="4-3-组合-composition"><a href="#4-3-组合-composition" class="headerlink" title="4.3 组合(composition)"></a>4.3 组合(composition)</h2><p>向己有的类中添加一个原子操作，还有更好的选择：组合。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.ListIterator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by osys on 2022/08/28 21:48.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImprovedList</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">List</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;T&gt; list;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * PRE: list 参数是线程安全的。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ImprovedList</span><span class="params">(List&lt;T&gt; list)</span> &#123;<span class="built_in">this</span>.list = list;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">putIfAbsent</span><span class="params">(T x)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">contains</span> <span class="operator">=</span> list.contains(x);</span><br><span class="line">        <span class="keyword">if</span> (contains) &#123;</span><br><span class="line">            list.add(x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> !contains;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// List 方法的普通委托。</span></span><br><span class="line">    <span class="comment">// 可变方法必须同步以确保 putIfAbsent 的原子性。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;list.clear();&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> index, T element)</span> &#123;list.add(index, element);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(T e)</span> &#123;<span class="keyword">return</span> list.add(e);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object o)</span> &#123;<span class="keyword">return</span> list.remove(o);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">addAll</span><span class="params">(Collection&lt;? extends T&gt; c)</span> &#123;<span class="keyword">return</span> list.addAll(c);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">addAll</span><span class="params">(<span class="type">int</span> index, Collection&lt;? extends T&gt; c)</span> &#123;<span class="keyword">return</span> list.addAll(index, c);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">removeAll</span><span class="params">(Collection&lt;?&gt; c)</span> &#123;<span class="keyword">return</span> list.removeAll(c);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">retainAll</span><span class="params">(Collection&lt;?&gt; c)</span> &#123;<span class="keyword">return</span> list.retainAll(c);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> T <span class="title function_">set</span><span class="params">(<span class="type">int</span> index, T element)</span> &#123;<span class="keyword">return</span> list.set(index, element);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> T <span class="title function_">remove</span><span class="params">(<span class="type">int</span> index)</span> &#123;<span class="keyword">return</span> list.remove(index);&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不可变方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span>  T <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span> &#123;<span class="keyword">return</span> list.get(index);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;<span class="keyword">return</span> list.size();&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;<span class="keyword">return</span> list.isEmpty();&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">contains</span><span class="params">(Object o)</span> &#123;<span class="keyword">return</span> list.contains(o);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;T&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;<span class="keyword">return</span> list.iterator();&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object[] toArray() &#123;<span class="keyword">return</span> list.toArray();&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T[] toArray(T[] a) &#123;<span class="keyword">return</span> list.toArray(a);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">containsAll</span><span class="params">(Collection&lt;?&gt; c)</span> &#123;<span class="keyword">return</span> list.containsAll(c);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;<span class="keyword">return</span> list.equals(o);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;<span class="keyword">return</span> list.hashCode();&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">indexOf</span><span class="params">(Object o)</span> &#123;<span class="keyword">return</span> list.indexOf(o);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">lastIndexOf</span><span class="params">(Object o)</span> &#123;<span class="keyword">return</span> list.lastIndexOf(o);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ListIterator&lt;T&gt; <span class="title function_">listIterator</span><span class="params">()</span> &#123;<span class="keyword">return</span> list.listIterator();&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ListIterator&lt;T&gt; <span class="title function_">listIterator</span><span class="params">(<span class="type">int</span> index)</span> &#123;<span class="keyword">return</span> list.listIterator(index);&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;T&gt; <span class="title function_">subList</span><span class="params">(<span class="type">int</span> fromIndex, <span class="type">int</span> toIndex)</span> &#123;<span class="keyword">return</span> list.subList(fromIndex, toIndex);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ImprovedList 通过将操作委托给底层的 List 实例，实现了 List 的操作，同时还添加了一个原子的<code>putIfAbsent()</code>方法。</li>
<li>就像 <code>Collections.synchronizedList</code> 和其他容器封装器那样，ImprovedList 假设一旦有一个 list 传给它的构造函数后，客户将不再直接使用这个 list，而仅仅通过 ImprovedList 访问它。</li>
<li>通过使用内部锁，ImproveaList 引入了一个<code>新的锁层</code>。</li>
<li>它并不关心底层的 List 是否线程安全，即使 List 不是线程安全的，或者会改变 ImproveaList 的锁实现，Improvedtist 都有自己兼容的锁可以提供线程安全性。</li>
<li>虽然额外的一层同步可能会带来一些微弱的性能损失，但是相比于去尝试模拟另一个对象的锁策路而言，ImprovedList并不那么脆弱。</li>
<li>我们己经使用 Java 监视器模式有效地封裝了一个己有的 List，而且只要我们的类持有底层 List 的<code>唯一外部引用</code>，那么就能保证提供线程安全性。</li>
</ul>
<h1 id="5-同步策略的文档化"><a href="#5-同步策略的文档化" class="headerlink" title="5. 同步策略的文档化"></a>5. 同步策略的文档化</h1><p>1.为类的用户编写类线程安全性担保的文档；为类的维护者编写类的同步文档。</p>
<p>2.每次使用synchronized，volatile或者任何线程安全类，都表现了一种同步策略，这个策略是你程序设计的一个元素，因此应该将它文档化。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Java并发编程实战：第4章 组合对象</p><p><a href="https://osys.github.io/posts/f8f2.html">https://osys.github.io/posts/f8f2.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Osys</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022年08月29日</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022年08月29日</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/posts/ff33.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Java并发编程实战：第5章 构建块</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/posts/fff0.html"><span class="level-item">Java并发编程实战：第3章 对象的共享</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "87ec2c4d094c53062e71bd6e56ba4967",
            repo: "osys.github.io",
            owner: "osys",
            clientID: "e0f10cf0c934d445e79f",
            clientSecret: "3dad6d25224fe45db31a3a912756bd5175e3a70f",
            admin: ["osys"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-8-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#1-设计线程安全的类"><span class="level-left"><span class="level-item">1. 设计线程安全的类</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-同步策略-Synchronization-Policy"><span class="level-left"><span class="level-item">1.1 同步策略(Synchronization Policy)</span></span></a></li><li><a class="level is-mobile" href="#1-2-收集同步需求"><span class="level-left"><span class="level-item">1.2 收集同步需求</span></span></a></li><li><a class="level is-mobile" href="#1-3-状态依赖的操作"><span class="level-left"><span class="level-item">1.3 状态依赖的操作</span></span></a></li><li><a class="level is-mobile" href="#1-4-状态所有权"><span class="level-left"><span class="level-item">1.4 状态所有权</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-实例限制"><span class="level-left"><span class="level-item">2. 实例限制</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-实例限制"><span class="level-left"><span class="level-item">2.1 实例限制</span></span></a></li><li><a class="level is-mobile" href="#2-2-Java-监视器模式-Java-monitor-pattern"><span class="level-left"><span class="level-item">2.2 Java 监视器模式(Java monitor pattern)</span></span></a></li><li><a class="level is-mobile" href="#2-3-机动车追踪器-tracking-fleet-vehicle"><span class="level-left"><span class="level-item">2.3 机动车追踪器(tracking fleet vehicle)</span></span></a></li></ul></li><li><a class="level is-mobile" href="#3-委托线程安全"><span class="level-left"><span class="level-item">3. 委托线程安全</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-基于监视器的机动车追踪器实现"><span class="level-left"><span class="level-item">3.1 基于监视器的机动车追踪器实现</span></span></a></li><li><a class="level is-mobile" href="#3-2-将现场安全委托到-ConcurrentHashMap"><span class="level-left"><span class="level-item">3.2 将现场安全委托到 ConcurrentHashMap</span></span></a></li><li><a class="level is-mobile" href="#3-3-非状态依赖变量"><span class="level-left"><span class="level-item">3.3 非状态依赖变量</span></span></a></li><li><a class="level is-mobile" href="#3-4-不完整地保护不变约束"><span class="level-left"><span class="level-item">3.4 不完整地保护不变约束</span></span></a></li><li><a class="level is-mobile" href="#3-5-发布底层的状态变量"><span class="level-left"><span class="level-item">3.5 发布底层的状态变量</span></span></a></li></ul></li><li><a class="level is-mobile" href="#4-向已有的线程安全类添加功能"><span class="level-left"><span class="level-item">4. 向已有的线程安全类添加功能</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-1-向已有的线程安全类添加功能"><span class="level-left"><span class="level-item">4.1 向已有的线程安全类添加功能</span></span></a></li><li><a class="level is-mobile" href="#4-2-客户端加锁"><span class="level-left"><span class="level-item">4.2 客户端加锁</span></span></a></li><li><a class="level is-mobile" href="#4-3-组合-composition"><span class="level-left"><span class="level-item">4.3 组合(composition)</span></span></a></li></ul></li><li><a class="level is-mobile" href="#5-同步策略的文档化"><span class="level-left"><span class="level-item">5. 同步策略的文档化</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/basic/avatar.png" alt="Osys"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Osys</p><p class="is-size-6 is-block">追寻美好生活，书写人生精彩篇章。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>GuangZhou</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">31</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">5</p></a></div></div></nav></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">29</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%A1%B9%E7%9B%AE%E6%A1%88%E4%BE%8B/"><span class="level-start"><span class="level-item">项目案例</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><span class="tag">Java并发编程</span><span class="tag">29</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringBoot/"><span class="tag">SpringBoot</span><span class="tag">2</span></a></div></div></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/09/"><span class="level-start"><span class="level-item">九月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">29</span></span></a></li></ul></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.cnblogs.com/liyihua/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">我的博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/qq_44830823?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">我的CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="footer-content"><div class="footer-left"><div class="footer-logo-section"><a class="footer-logo" href="/"><div class="footer-logo-row"><img src="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png" alt="LeeHua&#039;s Blog" height="35"><span class="footer-tagline">LeeHua&#039;s Blog</span></div><div class="footer-runtime"><span class="footer-osys">OSYS</span><div class="footer-runtime-text" id="site-runtime"></div></div></a></div><div class="footer-info"><p class="footer-statistics"><script src="https://sdk.51.la/perf/js-sdk-pro.min.js" crossorigin="anonymous"></script><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js?id=JoDQdGZeB7Cy04AN&amp;ck=JoDQdGZeB7Cy04AN"></script><a target="blank" title="网站统计" href="https://v6.51.la/land/JoDQdGZeB7Cy04AN"></a><script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoDQdGZeB7Cy04AN/quote.js?theme=0&amp;f=12&amp;display=0,1,1,1,1,1,0,1"></script></p><a href="https://beian.miit.gov.cn/" target="_blank"><div class="footer-card"><span class="footer-card-title">备案号:</span> 粤ICP备2022104988号</div></a><a href="https://github.com/" target="_blank"><div class="footer-card"><span class="footer-card-title">网站:</span> 挂载于 github + 腾讯云</div></a><a href="https://github.com/" target="_blank"><div class="footer-card"><span class="footer-card-title">图片:</span> 挂载于 github</div></a><a href="https://www.jsdelivr.com/github" target="_blank"><div class="footer-card"><span class="footer-card-title">CDN:</span> jsDelivr</div></a></div></div><div class="footer-right"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="粤ICP备2022104988号-1" href="https://beian.miit.gov.cn/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Blog on GitHub" href="https://github.com/osys/osys.github.io/"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container" id="algolia-input"></div><div id="algolia-poweredby" style="display:flex;margin:0 .5em 0 1em;align-items:center;line-height:0"></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div><div class="searchbox-footer"></div></div></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.0.3/dist/algoliasearch-lite.umd.js" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.3.1/dist/instantsearch.production.min.js" crossorigin="anonymous" defer></script><script src="/js/algolia.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadAlgolia({"applicationId":"8FPI8CDLJR","apiKey":"702cfc5bf8397419842065704ec39904","indexName":"github_pages_hexo_blog"}, {"hint":"想要查找什么...","no_result":"未找到搜索结果","untitled":"(无标题)","empty_preview":"(无内容预览)"});
        });</script></body></html>