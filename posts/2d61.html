<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Java并发编程实战：第12章 测试并发程序 - LeeHua&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="LeeHua&#039;s Blog"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="LeeHua&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="1. 测试正确性1.1 测试并发程序并发程序打造可以分为两类：  安全性测试 活跃性测试 进展性测试 无进展测试    与活跃性测试相关的事性能测试。性能的衡量：  吞吐量 响应性 可伸缩性"><meta property="og:type" content="blog"><meta property="og:title" content="Java并发编程实战：第12章 测试并发程序"><meta property="og:url" content="https://osys.github.io/"><meta property="og:site_name" content="Osys&#039;s Blog"><meta property="og:description" content="1. 测试正确性1.1 测试并发程序并发程序打造可以分为两类：  安全性测试 活跃性测试 进展性测试 无进展测试    与活跃性测试相关的事性能测试。性能的衡量：  吞吐量 响应性 可伸缩性"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://osys.github.io/img/og_image.png"><meta property="article:published_time" content="2022-08-29T14:18:40.000Z"><meta property="article:modified_time" content="2022-08-29T14:40:44.000Z"><meta property="article:author" content="Osys"><meta property="article:tag" content="Java并发编程"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://osys.github.io/"},"headline":"LeeHua's Blog","image":["https://osys.github.io/img/og_image.png"],"datePublished":"2022-08-29T14:18:40.000Z","dateModified":"2022-08-29T14:40:44.000Z","author":{"@type":"Person","name":"Osys"},"publisher":{"@type":"Organization","name":"Osys","logo":{"@type":"ImageObject","url":"https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"}},"description":"一路生花"}</script><link rel="canonical" href="https://osys.github.io/posts/2d61.html"><link rel="alternate" href="/path/to/atom.xml" title="LeeHua&#039;s Blog" type="application/atom+xml"><link rel="icon" href="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?44cd31785e14a1fdaad0921651759e0f";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 6.0.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png" alt="LeeHua&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-08-29T14:18:40.000Z" title="8/29/2022, 2:18:40 PM">2022年08月29日</time>发表</span><span class="level-item"><time dateTime="2022-08-29T14:40:44.000Z" title="8/29/2022, 2:40:44 PM">2022年08月29日</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Java/">Java</a></span><span class="level-item">24 分钟读完 (大约3674个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Java并发编程实战：第12章 测试并发程序</h1><div class="content"><h1 id="1-测试正确性"><a href="#1-测试正确性" class="headerlink" title="1. 测试正确性"></a>1. 测试正确性</h1><h2 id="1-1-测试并发程序"><a href="#1-1-测试并发程序" class="headerlink" title="1.1 测试并发程序"></a>1.1 测试并发程序</h2><p>并发程序打造可以分为两类：</p>
<ol>
<li>安全性测试</li>
<li>活跃性测试<ul>
<li>进展性测试</li>
<li>无进展测试</li>
</ul>
</li>
</ol>
<p>与活跃性测试相关的事<strong>性能测试</strong>。性能的衡量：</p>
<ul>
<li>吞吐量</li>
<li>响应性</li>
<li>可伸缩性</li>
</ul>
<span id="more"></span>

<h2 id="1-2-测试正确性"><a href="#1-2-测试正确性" class="headerlink" title="1.2 测试正确性"></a>1.2 测试正确性</h2><p>在为某个并发类设计单元测试时，首先需要执行与测试串行类时相同的分析 —- 找出需要检查的不变性条件和后验条件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.jcip.annotations.GuardedBy;</span><br><span class="line"><span class="keyword">import</span> net.jcip.annotations.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SemaphoreBoundedBuffer</span> &lt;E&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Semaphore ---- 计数信号量</span></span><br><span class="line"><span class="comment">     * availableItems ---- 可用items</span></span><br><span class="line"><span class="comment">     * availableSpaces ---- 可用空间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Semaphore availableItems, availableSpaces;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 存放 Element 的数组 */</span></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> E[] items;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * putPosition ---- 存入数组 items 的位置</span></span><br><span class="line"><span class="comment">     * takePosition ---- 从数组中拿 Element 的位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">putPosition</span> <span class="operator">=</span> <span class="number">0</span>, takePosition = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SemaphoreBoundedBuffer</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 初始化幸好量，可用 items = 0，可用空间 spaces = capacity</span></span><br><span class="line">        availableItems = <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">0</span>);</span><br><span class="line">        availableSpaces = <span class="keyword">new</span> <span class="title class_">Semaphore</span>(capacity);</span><br><span class="line">        items = (E[]) <span class="keyword">new</span> <span class="title class_">Object</span>[capacity];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> availableItems.availablePermits() == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isFull</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> availableSpaces.availablePermits() == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加一个元素</span></span><br><span class="line"><span class="comment">     * 可用空间 - 1</span></span><br><span class="line"><span class="comment">     * 可用元素 + 1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(E x)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        availableSpaces.acquire();</span><br><span class="line">        doInsert(x);</span><br><span class="line">        availableItems.release();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拿出一个元素</span></span><br><span class="line"><span class="comment">     * 可用空间 + 1</span></span><br><span class="line"><span class="comment">     * 可用元素 - 1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        availableItems.acquire();</span><br><span class="line">        <span class="type">E</span> <span class="variable">item</span> <span class="operator">=</span> doExtract();</span><br><span class="line">        availableSpaces.release();</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加一个元素</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x 元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">doInsert</span><span class="params">(E x)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> putPosition;</span><br><span class="line">        items[i] = x;</span><br><span class="line">        </span><br><span class="line">        ++i;</span><br><span class="line">        <span class="keyword">if</span> (i == items.length) &#123;</span><br><span class="line">            putPosition = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            putPosition = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">synchronized</span> E <span class="title function_">doExtract</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> takePosition;</span><br><span class="line">        <span class="type">E</span> <span class="variable">x</span> <span class="operator">=</span> items[i];</span><br><span class="line">        items[i] = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        ++i;</span><br><span class="line">        <span class="keyword">if</span> (i == items.length) &#123;</span><br><span class="line">            takePosition = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            takePosition = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在计数信号量中，许可不会被显式地表现出来，也不会和它所在的线程有任何关联；release 创建许可，acquire消費许可。</p>
<h3 id="1-2-1-基本的单元测试"><a href="#1-2-1-基本的单元测试" class="headerlink" title="1.2.1 基本的单元测试"></a>1.2.1 基本的单元测试</h3><p>对 SemaphoreBoundedBuffer 进行基本单元测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBoundedBuffer</span> <span class="keyword">extends</span> <span class="title class_">TestCase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testIsEmptyWhenConstructed</span><span class="params">()</span> &#123;</span><br><span class="line">        SemaphoreBoundedBuffer&lt;Integer&gt; bb = <span class="keyword">new</span> <span class="title class_">SemaphoreBoundedBuffer</span>&lt;Integer&gt;(<span class="number">10</span>);</span><br><span class="line">        assertTrue(bb.isEmpty());		<span class="comment">// bb.isEmpty() = true</span></span><br><span class="line">        assertFalse(bb.isFull());		<span class="comment">// bb.isFull() = false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testIsFullAfterPuts</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        SemaphoreBoundedBuffer&lt;Integer&gt; bb = <span class="keyword">new</span> <span class="title class_">SemaphoreBoundedBuffer</span>&lt;Integer&gt;(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            bb.put(i);</span><br><span class="line">        &#125;</span><br><span class="line">        assertTrue(bb.isFull());		<span class="comment">// bb.isFull() = true</span></span><br><span class="line">        assertFalse(bb.isEmpty());		<span class="comment">// bb.isEmpty() = false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-2-测试阻塞操作"><a href="#1-2-2-测试阻塞操作" class="headerlink" title="1.2.2 测试阻塞操作"></a>1.2.2 测试阻塞操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> junit.framework.TestCase;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBoundedBuffer</span> <span class="keyword">extends</span> <span class="title class_">TestCase</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">LOCKUP_DETECT_TIMEOUT</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTakeBlocksWhenEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> SemaphoreBoundedBuffer&lt;Integer&gt; bb = <span class="keyword">new</span> <span class="title class_">SemaphoreBoundedBuffer</span>&lt;Integer&gt;(<span class="number">10</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">taker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">unused</span> <span class="operator">=</span> bb.take();</span><br><span class="line">                    fail();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException success) &#123; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            taker.start();</span><br><span class="line">            Thread.sleep(LOCKUP_DETECT_TIMEOUT);</span><br><span class="line">            taker.interrupt();</span><br><span class="line">            taker.join(LOCKUP_DETECT_TIMEOUT);</span><br><span class="line">            assertFalse(taker.isAlive());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception unexpected) &#123;</span><br><span class="line">            fail();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果在某个测试用例创建的辅助线程中发现了一个错误，那么框架通常无法得知与这个线程相关的是哪一个测试，所以需要通过一些工作将成功或失败信息传递回主线程，从而才能将相应的信息报告出来。</p>
<h3 id="1-2-3-测试安全性"><a href="#1-2-3-测试安全性" class="headerlink" title="1.2.3 测试安全性"></a>1.2.3 测试安全性</h3><ul>
<li>要想测试一个并发类在不可预知的并发访问下是否能够正确执行，我们可以安排多个线程对该并发类进行操作，运行一段时间再检查数据是否正常。</li>
<li>在对并发类进行安全性测试时，要关注某些熟悉可能会引发数据异常、导致程序出现问题。简单地识别出这些受检查的属性来，不要在检查这些属性，人为的限制程序的并发性。最好能做到在检查测试的属性时，不需要添加任何同步代码。</li>
</ul>
<blockquote>
<p>SemaphoreBoundedBuffer 的生产者-消费者测试程序</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> junit.framework.TestCase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CyclicBarrier;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PutTakeTest</span> <span class="keyword">extends</span> <span class="title class_">TestCase</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">protected</span> CyclicBarrier barrier;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> SemaphoreBoundedBuffer&lt;Integer&gt; bb;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">int</span> nTrials, nPairs;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">putSum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">takeSum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">PutTakeTest</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">100000</span>).test(); <span class="comment">// sample parameters</span></span><br><span class="line">        pool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PutTakeTest</span><span class="params">(<span class="type">int</span> capacity, <span class="type">int</span> npairs, <span class="type">int</span> ntrials)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bb = <span class="keyword">new</span> <span class="title class_">SemaphoreBoundedBuffer</span>&lt;Integer&gt;(capacity);</span><br><span class="line">        <span class="built_in">this</span>.nTrials = ntrials;</span><br><span class="line">        <span class="built_in">this</span>.nPairs = npairs;</span><br><span class="line">        <span class="built_in">this</span>.barrier = <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(npairs * <span class="number">2</span> + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nPairs; i++) &#123;</span><br><span class="line">                pool.execute(<span class="keyword">new</span> <span class="title class_">Producer</span>());</span><br><span class="line">                pool.execute(<span class="keyword">new</span> <span class="title class_">Consumer</span>());</span><br><span class="line">            &#125;</span><br><span class="line">            barrier.await(); <span class="comment">// wait for all threads to be ready</span></span><br><span class="line">            barrier.await(); <span class="comment">// wait for all threads to finish</span></span><br><span class="line">            assertEquals(putSum.get(), takeSum.get());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">xorShift</span><span class="params">(<span class="type">int</span> y)</span> &#123;</span><br><span class="line">        y ^= (y &lt;&lt; <span class="number">6</span>);</span><br><span class="line">        y ^= (y &gt;&gt;&gt; <span class="number">21</span>);</span><br><span class="line">        y ^= (y &lt;&lt; <span class="number">7</span>);</span><br><span class="line">        <span class="keyword">return</span> y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 生产者 */</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Producer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">seed</span> <span class="operator">=</span> (<span class="built_in">this</span>.hashCode() ^ (<span class="type">int</span>) System.nanoTime());</span><br><span class="line">                <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                barrier.await();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> nTrials; i &gt; <span class="number">0</span>; --i) &#123;</span><br><span class="line">                    bb.put(seed);</span><br><span class="line">                    sum += seed;</span><br><span class="line">                    seed = xorShift(seed);</span><br><span class="line">                &#125;</span><br><span class="line">                putSum.getAndAdd(sum);</span><br><span class="line">                barrier.await();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 消费者 */</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Consumer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                barrier.await();</span><br><span class="line">                <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> nTrials; i &gt; <span class="number">0</span>; --i) &#123;</span><br><span class="line">                    sum += bb.take();</span><br><span class="line">                &#125;</span><br><span class="line">                takeSum.getAndAdd(sum);</span><br><span class="line">                barrier.await();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-4-测试资源管理"><a href="#1-2-4-测试资源管理" class="headerlink" title="1.2.4 测试资源管理"></a>1.2.4 测试资源管理</h3><ul>
<li>任何持有或管理着其他对象的对象，都应该在不需要某个对象时，放弃该对象的引用。</li>
<li>存储资源泄漏会抑制垃圾回收器回收内存(以及线程、文件句柄、套接字、数据库连接或者其它有限资源)，还会导致资源耗尽和应用程序的失败。因此要限制缓存的大小。</li>
<li>对内存不合理的占有，可以简单地通过堆检查工具测试出来。例如 JProfiler 工具。</li>
</ul>
<blockquote>
<p>测试资源泄漏</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> junit.framework.TestCase;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBoundedBuffer</span> <span class="keyword">extends</span> <span class="title class_">TestCase</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CAPACITY</span> <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THRESHOLD</span> <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Big</span> &#123;</span><br><span class="line">        <span class="type">double</span>[] data = <span class="keyword">new</span> <span class="title class_">double</span>[<span class="number">100000</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLeak</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        SemaphoreBoundedBuffer&lt;Big&gt; bb = <span class="keyword">new</span> <span class="title class_">SemaphoreBoundedBuffer</span>&lt;&gt;(CAPACITY);</span><br><span class="line">        <span class="type">int</span> <span class="variable">heapSize1</span> <span class="operator">=</span> snapshotHeap();			<span class="comment">// heap 的快照</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; CAPACITY; i++) &#123;</span><br><span class="line">            bb.put(<span class="keyword">new</span> <span class="title class_">Big</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; CAPACITY; i++) &#123;</span><br><span class="line">            bb.take();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">heapSize2</span> <span class="operator">=</span> snapshotHeap();			<span class="comment">// heap 的快照</span></span><br><span class="line">        assertTrue(Math.abs(heapSize1 - heapSize2) &lt; THRESHOLD);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">snapshotHeap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/* Snapshot heap and return heap size */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-5-使用回调"><a href="#1-2-5-使用回调" class="headerlink" title="1.2.5 使用回调"></a>1.2.5 使用回调</h3><ul>
<li>回调用户提供的代码，有助于创建测试用例；</li>
<li>回调常常发生在一个对象生命周期的己知点上，这些点提供了很好的机会，来断言不变约束。例如，ThreadPoolExecutor 就把调用转到了任务的 Runnable 和 ThreadFactory 上。</li>
<li>测试一个线程池，涉及到对其执行策路的大量要素的测试：当需要时就创建额外的线程，不需要时就不要创建；当需要时就回收空闲线程，等等。创建一个爱盖了所有可能性的全面的测试套件是一件非常好的事情，但是大多数可能性都可以简单地、独立地进行测试。</li>
</ul>
<blockquote>
<p>用于测试 ThreadPoolExecutor 的线程工厂</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestingThreadFactory</span> <span class="keyword">implements</span> <span class="title class_">ThreadFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">numCreated</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ThreadFactory</span> <span class="variable">factory</span> <span class="operator">=</span> Executors.defaultThreadFactory();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">        numCreated.incrementAndGet();</span><br><span class="line">        <span class="keyword">return</span> factory.newThread(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>验证线程池扩展的测试方法</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> junit.framework.TestCase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestThreadPool</span> <span class="keyword">extends</span> <span class="title class_">TestCase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 线程工厂 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">TestingThreadFactory</span> <span class="variable">threadFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingThreadFactory</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPoolExpansion</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">MAX_SIZE</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">exec</span> <span class="operator">=</span> Executors.newFixedThreadPool(MAX_SIZE, threadFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提交 100 个 task 到 execute</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span> * MAX_SIZE; i++) &#123;</span><br><span class="line">            exec.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(Long.MAX_VALUE);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        Thread.currentThread().interrupt();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">             i &lt; <span class="number">20</span> &amp;&amp; threadFactory.numCreated.get() &lt; MAX_SIZE;</span><br><span class="line">             i++) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// threadFactory.numCreated.get() = 10</span></span><br><span class="line">        <span class="comment">// MAX_SIZE = 10</span></span><br><span class="line">        <span class="comment">// junit.framework.AssertionFailedError: </span></span><br><span class="line">        assertEquals(threadFactory.numCreated.get(), MAX_SIZE);</span><br><span class="line">        exec.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果核心池大小小于最大值，线程池会在执行的任务增多时相应地增长。</p>
<p>向池提交几个耗时任务，会使池中的执行任务的数量在足够长的时间内都是常量，这就可以进行一些断言，比如测试池是否如期地扩展。</p>
<h3 id="1-2-6-产生更多的交替操作"><a href="#1-2-6-产生更多的交替操作" class="headerlink" title="1.2.6 产生更多的交替操作"></a>1.2.6 产生更多的交替操作</h3><p>由于并发代码中发生的错误一般都是低概率事件，所以在测试并发错误时需要反复地执行许多次。</p>
<p>有些方法可以提高发现这些错误的概率，在多处理器系统上，如果处理器的数量少于活动线程的数量，那么与<strong>单处理器的系统</strong>或者<strong>包含多个处理器的系统</strong>相比，将能产生更多的交替行为。</p>
<p>同样，如果在不同的处理器数量、操作系统以及处理器架构的系统上进行测试，就可以发现那些在特定运行环境中才会出现的问题。</p>
<p>有一种有用的方法能提高交替操作的数量。以便能更有效的搜索程序的状态空间：在访问共享状态的操作中，使用<strong>Thread.yield</strong>将产生更多的上下文切换。当代码在访问状态的时候没有使用足够的同步，将存在一些对执行时序敏感的错误，通过在某个操作的执行过程 中调用yield方法，可以将这些错误暴露出来。这种方法需要在测试中添加一些调用并且在正式产品中删除这些调用。</p>
<blockquote>
<p>使用 Thread.yield 产生更多的交替操作</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">tranferCredits</span><span class="params">(Account from,Account to,<span class="type">int</span> amount)</span> &#123;  </span><br><span class="line">    from.setBalance(from.getBalance()-amount);  </span><br><span class="line">    <span class="keyword">if</span> (random.nextInt(<span class="number">1000</span>)&gt;THRESHOLD) &#123;  </span><br><span class="line">        Thread.yield();  </span><br><span class="line">    &#125;  </span><br><span class="line">    to.setBalance(to.getBalance()+amount);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="2-测试性能"><a href="#2-测试性能" class="headerlink" title="2. 测试性能"></a>2. 测试性能</h1><h2 id="2-1-性能测试"><a href="#2-1-性能测试" class="headerlink" title="2.1 性能测试"></a>2.1 性能测试</h2><ul>
<li>性能测试要符合当前程序的应用场景，理想情况下应该反映出被测试对象在应用程序中的实际用法。</li>
<li>性能测试将衡量典型测试用例中的端到端功能。通常，要获得一组合理的使用场景并不容易，理想情况下，在测试中应该反映出被测试对象在应用程序中的实际用法。</li>
<li>根据经验值来调整各种不同的限值，例如线程数量，缓存容量等等，这些限值都依赖于平台特性(如CPU、内存)。</li>
</ul>
<h2 id="2-2-比较多种算法"><a href="#2-2-比较多种算法" class="headerlink" title="2.2 比较多种算法"></a>2.2 比较多种算法</h2><ul>
<li>测试结果表明，LinkedBlockgingQueue 的可伸缩性要高于 ArrayBlockingQueue。</li>
<li>从测试结果来看，这个结果似乎有些奇怪，链表队列在每次插入元素时，都必须分配一个链表节点对象，这似乎比基于数组的队列相比，链表队列的 put 和 take 等方法支持并发性更高的访问，因为一些优化后的链接队列算法能将队列头节点的更新操作与尾节点的更新操作分享开来。</li>
<li>因此如果算法能通过多执行一些内存分配操作来降低竞争程度，那么这种算法通常具有更高的可伸缩性。</li>
</ul>
<h2 id="2-3-测量响应性"><a href="#2-3-测量响应性" class="headerlink" title="2.3 测量响应性"></a>2.3 测量响应性</h2><ul>
<li>同一进程可以同时在多个内核上执行(多线程)，并且可以在进程之间共享内存。因此无论上下文切换发生什么，缓存同步都是不可避免的。</li>
<li>如果缓存过小，那么将导致非常多的上下文切换次数。频繁的上下文切换，会导致程序吞吐量较为糟糕。</li>
<li>如果线程由于较多的同步条件限制，导致持续的被阻塞，不公平的信号量(<code>Semaphore</code>)能够提供更好的吞吐量(差异性大)，公平的信号量提供更低的差异性。</li>
</ul>
<h1 id="3-避免性能测试陷阱"><a href="#3-避免性能测试陷阱" class="headerlink" title="3. 避免性能测试陷阱"></a>3. 避免性能测试陷阱</h1><h2 id="3-1-垃圾回收"><a href="#3-1-垃圾回收" class="headerlink" title="3.1 垃圾回收"></a>3.1 垃圾回收</h2><ul>
<li><p>垃圾回收的时序是不可预知的，在一个测量数据的测试运行中，任何时候垃圾回收器都有可能运行。</p>
</li>
<li><p>多次对程序进行测试时，如果仅在某一两次触发了垃圾回收，这可能会导致最终测试结果有所偏差。</p>
</li>
<li><p>有两种策略可以防止垃圾回收操作对测试结果产生偏差。</p>
<ul>
<li><p>第一种策略是，确保垃圾回收操作在测试运行的整个期间都不会执行。</p>
</li>
<li><p>第二种策略是，确保垃圾回收操作在测试期间执行多次，这样测试程序就能充分反映出运行期间的内存分配与垃圾回收等开销。</p>
<p>  （可以在调用JVM时指定-verbose：gc来判断是否执行了垃圾回收操作）</p>
</li>
</ul>
</li>
</ul>
<h2 id="3-2-动态编译"><a href="#3-2-动态编译" class="headerlink" title="3.2 动态编译"></a>3.2 动态编译</h2><ul>
<li>HotSpot JVM 结合了字节码解释和动态编译。</li>
<li>当一个类首次被加载后，JVM 会以解释字节码的方式执行。</li>
<li>如果一个方法运行得较为频繁，动态编译器最终会将其挑出来，转成本机代码，当编译完成后，执行方式将由解释执行转换到直接执行。</li>
<li>编译的时机时不可预知的。大多数程序在运行得足够长后，所有频繁执行的代码露肩都会被编译。</li>
<li>在进行性能测试时，可以长时间运行要测试的程序，这样编译过程和解释执行仅仅占总体运行的很小一部分，对结果影响较小。或者先让待测试代码频繁执行，这样代码就会被完全编译，再测试时，即为直接执行。</li>
</ul>
<p>在运行程序时，使用 <code>-XX: +PrintCompilation</code>，程序会在动态编译时打印出信息。可以通过这条消息来验证动态编译是在测试运行前，而不是在运行过程中。</p>
<h2 id="3-3-不切实际的竞争程度"><a href="#3-3-不切实际的竞争程度" class="headerlink" title="3.3 不切实际的竞争程度"></a>3.3 不切实际的竞争程度</h2><ul>
<li>并发的应用程序总是交替执行两种非常不同的工作：<ol>
<li>访问共享数据，比如从共享工作队列中获取下一个任务。</li>
<li>线程本地的计算（执行任务，假设任务自身并不访问共享数据）。</li>
</ol>
</li>
<li>依赖于两种工作类型的相关特性，应用程序会经历不同级别的竞争，并表现出不同的性能与伸缩性行为。</li>
</ul>
<p>如果有N个线程从共享工作队列中获取任务并执行，这些任务都是计算密集型的、耗时的（但并未频繁地跨线程访问数据），这种情况几乎没有竟争；吞吐量只受限于可用的 CPU 资源。另一方面，如果任务的生命周期很短，在工作队列上就会存在大量竞争，此时吞吐量受限于同步的开销。</p>
<p>为了获得有实际意义的结果，并发性能测试，除了需要考虑协调并发的因素，应该尽最去模拟让线程本地的计算由某一个特有的应用程序来完成。如果每个任务在真实应用程序中完成的工作，与测试程序相比，其本质和范围有相当大的不同，那么得到的关于性能瓶颈位置的结论将是毫无根据的。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Java并发编程实战：第12章 测试并发程序</p><p><a href="https://osys.github.io/posts/2d61.html">https://osys.github.io/posts/2d61.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Osys</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022年08月29日</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022年08月29日</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/posts/c025.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Java并发编程实战：第12章 总结</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/posts/842a.html"><span class="level-item">Java并发编程实战：第11章 总结</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "cb587aeb438b1bf41e00c6b961ba55f9",
            repo: "osys.github.io",
            owner: "osys",
            clientID: "e0f10cf0c934d445e79f",
            clientSecret: "3dad6d25224fe45db31a3a912756bd5175e3a70f",
            admin: ["osys"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-8-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#1-测试正确性"><span class="level-left"><span class="level-item">1. 测试正确性</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-测试并发程序"><span class="level-left"><span class="level-item">1.1 测试并发程序</span></span></a></li><li><a class="level is-mobile" href="#1-2-测试正确性"><span class="level-left"><span class="level-item">1.2 测试正确性</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-2-1-基本的单元测试"><span class="level-left"><span class="level-item">1.2.1 基本的单元测试</span></span></a></li><li><a class="level is-mobile" href="#1-2-2-测试阻塞操作"><span class="level-left"><span class="level-item">1.2.2 测试阻塞操作</span></span></a></li><li><a class="level is-mobile" href="#1-2-3-测试安全性"><span class="level-left"><span class="level-item">1.2.3 测试安全性</span></span></a></li><li><a class="level is-mobile" href="#1-2-4-测试资源管理"><span class="level-left"><span class="level-item">1.2.4 测试资源管理</span></span></a></li><li><a class="level is-mobile" href="#1-2-5-使用回调"><span class="level-left"><span class="level-item">1.2.5 使用回调</span></span></a></li><li><a class="level is-mobile" href="#1-2-6-产生更多的交替操作"><span class="level-left"><span class="level-item">1.2.6 产生更多的交替操作</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#2-测试性能"><span class="level-left"><span class="level-item">2. 测试性能</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-性能测试"><span class="level-left"><span class="level-item">2.1 性能测试</span></span></a></li><li><a class="level is-mobile" href="#2-2-比较多种算法"><span class="level-left"><span class="level-item">2.2 比较多种算法</span></span></a></li><li><a class="level is-mobile" href="#2-3-测量响应性"><span class="level-left"><span class="level-item">2.3 测量响应性</span></span></a></li></ul></li><li><a class="level is-mobile" href="#3-避免性能测试陷阱"><span class="level-left"><span class="level-item">3. 避免性能测试陷阱</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-垃圾回收"><span class="level-left"><span class="level-item">3.1 垃圾回收</span></span></a></li><li><a class="level is-mobile" href="#3-2-动态编译"><span class="level-left"><span class="level-item">3.2 动态编译</span></span></a></li><li><a class="level is-mobile" href="#3-3-不切实际的竞争程度"><span class="level-left"><span class="level-item">3.3 不切实际的竞争程度</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://cdn.jsdelivr.net/gh/osys/oss@master/blog/img/basic/avatar.png" alt="Osys"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Osys</p><p class="is-size-6 is-block">追寻美好生活，书写人生精彩篇章。·</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>GuangZhou</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">31</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">5</p></a></div></div></nav></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">29</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%A1%B9%E7%9B%AE%E6%A1%88%E4%BE%8B/"><span class="level-start"><span class="level-item">项目案例</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><span class="tag">Java并发编程</span><span class="tag">29</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringBoot/"><span class="tag">SpringBoot</span><span class="tag">2</span></a></div></div></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/09/"><span class="level-start"><span class="level-item">九月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">29</span></span></a></li></ul></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.cnblogs.com/liyihua/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">我的博客园</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/qq_44830823?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">我的CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><p><img src="https://cdn.jsdelivr.net/gh/osys/cloud@master/img/basic/favicon512.png" alt="LeeHua&#039;s Blog" height="28"><href src="https://osyss.com"> 数据开发猿</href>  ~~~~~~~~~~~~~~~~~~~~~~~~~  @世间美好与大家环环相扣@  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</p>---------------------------------------------------------------------------------------------------------------------------------------------------------------------------<p><a href="https://beian.miit.gov.cn/" target="_blank">备案号: 粤ICP备2022104988号</a>【<a href="https://github.com/" target="_blank">网站: 挂载于 github + 腾讯云</a>】 【<a href="https://github.com/" target="_blank">图片: 挂载于 github</a>】 【<a href="https://www.jsdelivr.com/github" target="_blank">CDN: jsDelivr</a>】</p></a><p class="is-size-7"><script src="https://sdk.51.la/perf/js-sdk-pro.min.js" crossorigin="anonymous"></script><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js?id=JoDQdGZeB7Cy04AN&amp;ck=JoDQdGZeB7Cy04AN"></script><a target=" blank" title="网站统计" href="https://v6.51.la/land/JoDQdGZeB7Cy04AN"></a><script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoDQdGZeB7Cy04AN/quote.js?theme=0&amp;f=12&amp;display=0,1,1,1,1,1,0,1"></script></p>---------------------------------------------------------------------------------------------------------------------------------------------------------------------------</div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="粤ICP备2022104988号-1" href="https://beian.miit.gov.cn/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Blog on GitHub" href="https://github.com/osys/osys.github.io/"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container" id="algolia-input"></div><div id="algolia-poweredby" style="display:flex;margin:0 .5em 0 1em;align-items:center;line-height:0"></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div><div class="searchbox-footer"></div></div></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.0.3/dist/algoliasearch-lite.umd.js" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.3.1/dist/instantsearch.production.min.js" crossorigin="anonymous" defer></script><script src="/js/algolia.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadAlgolia({"applicationId":"8FPI8CDLJR","apiKey":"702cfc5bf8397419842065704ec39904","indexName":"github_pages_hexo_blog"}, {"hint":"想要查找什么...","no_result":"未找到搜索结果","untitled":"(无标题)","empty_preview":"(无内容预览)"});
        });</script></body></html>